import React, { useState, useEffect, useRef } from 'react';
import { 
  Upload, 
  Image as ImageIcon, 
  Layers, 
  Sun, 
  Moon, 
  Wand2, 
  Download, 
  X, 
  Loader2,
  Sparkles,
  Aperture, 
  Heart, 
  User, 
  Users,
  Wrench,
  Layout,
  MessageSquare,
  Printer,
  Camera, 
  Shirt, 
  ScanFace, 
  ArrowRightLeft,
  Menu,
  Baby,
  PenTool, 
  Copy,    
  FileText, 
  Share2,
  ScanEye, 
  BrainCircuit,
  Lightbulb,
  Save, 
  ExternalLink, 
  Zap,
  Mic, 
  Volume2, 
  Play, 
  Pause, 
  Stethoscope, 
  FileAudio,
  Grid,
  Ban,         // Icon for Negative Prompt
  Palette,     // Icon for Style
  Maximize,    // Icon for Aspect Ratio / Review Text
  Sliders,     // Icon for Settings
  Settings,    // Icon for Account Settings (NEW)
  UserCheck,   // Icon for Skin Tone Match
  Frame,       // Icon for Merge Mode
  Package,     // Icon for Product
  Monitor,     // Icon for Display
  Smartphone,  // Icon for Mobile Mode (ADDED)
  Scissors,    // Icon for Cut/Size
  CheckCircle2, // Icon for verification
  LogOut,       // Icon for Logout
  Lock,         // Icon for Login Password
  ShieldCheck,   // Icon for Login Success
  Gem,          // Icon for High Quality
  Wand,          // Icon for Enhancer
  Pencil,        // Icon for Coloring
  ScanLine,      // Icon for Scan Text
  ChevronDown,   // Icon for Accordion
  ChevronRight,  // Icon for Accordion
  Briefcase,     // Icon for Business Category
  ShoppingBag,   // Icon for Fashion/Sales (NEW)
  Eye,            // Icon for Review (NEW)
  Star,           // Icon for Artist (NEW)
  Brush,          // Icon for Art (NEW)
  Languages,      // Icon for Language (NEW)
  MessageCircle,  // Icon for Dialog (NEW)
  Bot,            // Icon for Bot/Generator (NEW)
  ImagePlus,      // Icon for Change BG (NEW)
  Zap as ZapIcon, // Alias Zap for Enhancer icon variation
  Aperture as BlurIcon // Icon for Blur
} from 'lucide-react';

// --- FIREBASE IMPORTS ---
import { initializeApp } from 'firebase/app';
import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged, signOut } from 'firebase/auth';
import { getFirestore, doc, setDoc, onSnapshot, collection } from 'firebase/firestore';

// --- API CONFIGURATION ---
const apiKey = ""; 

// --- FIREBASE SETUP ---
const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// --- HELPER: PCM to WAV Converter for TTS (FIXED) ---
const pcmToWav = (base64PCM) => {
  const binaryString = window.atob(base64PCM);
  const len = binaryString.length;
  const buffer = new ArrayBuffer(len);
  const view = new Uint8Array(buffer);
  for (let i = 0; i < len; i++) {
    view[i] = binaryString.charCodeAt(i);
  }

  // PCM data is raw 16-bit signed integers (Little Endian)
  const numOfChannels = 1;
  const sampleRate = 24000; // Gemini default
  const bitsPerSample = 16;
  const byteRate = sampleRate * numOfChannels * bitsPerSample / 8;
  const blockAlign = numOfChannels * bitsPerSample / 8;
  const dataSize = buffer.byteLength;
  const headerSize = 44;
  const totalSize = headerSize + dataSize;

  const wavBuffer = new ArrayBuffer(totalSize);
  const dataView = new DataView(wavBuffer);

  // Helper to write strings
  const writeString = (view, offset, string) => {
    for (let i = 0; i < string.length; i++) {
      view.setUint8(offset + i, string.charCodeAt(i));
    }
  };

  // RIFF chunk
  writeString(dataView, 0, 'RIFF');
  dataView.setUint32(4, totalSize - 8, true); // ChunkSize
  writeString(dataView, 8, 'WAVE');

  // fmt subchunk
  writeString(dataView, 12, 'fmt ');
  dataView.setUint32(16, 16, true); // Subchunk1Size (16 for PCM)
  dataView.setUint16(20, 1, true); // AudioFormat (1 for PCM)
  dataView.setUint16(22, numOfChannels, true);
  dataView.setUint32(24, sampleRate, true);
  dataView.setUint32(28, byteRate, true);
  dataView.setUint16(32, blockAlign, true);
  dataView.setUint16(34, bitsPerSample, true);

  // data subchunk
  writeString(dataView, 36, 'data');
  dataView.setUint32(40, dataSize, true);

  // Write PCM data
  const pcmBytes = new Uint8Array(buffer);
  const wavBytes = new Uint8Array(wavBuffer, 44);
  wavBytes.set(pcmBytes);

  return new Blob([wavBuffer], { type: 'audio/wav' });
};

// KOMPONEN: Ikon Aplikasi Gaya Remini
const ReminiStyleIcon = ({ size = 48, className = "" }) => (
  <svg 
    width={size} 
    height={size} 
    viewBox="0 0 100 100" 
    fill="none" 
    xmlns="http://www.w3.org/2000/svg"
    className={className}
    style={{ filter: "drop-shadow(0 10px 15px rgba(99, 102, 241, 0.4))" }} 
  >
    <defs>
      <linearGradient id="bluePurpleGradient" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" style={{stopColor: "rgb(99, 102, 241)", stopOpacity: 1}} />
        <stop offset="100%" style={{stopColor: "rgb(236, 72, 153)", stopOpacity: 1}} />
      </linearGradient>
    </defs>
    <rect x="5" y="5" width="90" height="90" rx="20" fill="url(#bluePurpleGradient)" />
    <rect x="8" y="8" width="84" height="84" rx="17" fill="rgba(0,0,0,0.1)" />
    <path 
      d="M25 5H75C85 5 95 15 95 25V35C85 25 75 15 65 15H35C25 15 5 25 5 35V25C5 15 15 5 25 5Z" 
      fill="white" 
      fillOpacity="0.35"
    />
    <g transform="translate(50, 50)" fill="white" stroke="white" strokeWidth="2">
        <path d="M-15 0L-5 0M5 0L15 0M0 -15L0 -5M0 5L0 15" strokeLinecap="round" />
        <circle cx="10" cy="10" r="2" />
        <circle cx="-10" cy="-10" r="2" />
    </g>
  </svg>
);

// KOMPONEN: Slider Perbandingan Before/After
const BeforeAfterSlider = ({ beforeImage, afterImage }) => {
  const [sliderPosition, setSliderPosition] = useState(50);
  const isDragging = useRef(false);

  const handleMove = (event) => {
    if (!isDragging.current) return;
    const rect = event.currentTarget.getBoundingClientRect();
    const x = Math.max(0, Math.min(event.clientX - rect.left, rect.width));
    const percent = Math.max(0, Math.min((x / rect.width) * 100, 100));
    setSliderPosition(percent);
  };

  const handleTouchMove = (event) => {
    if (!isDragging.current) return;
    const rect = event.currentTarget.getBoundingClientRect();
    const touch = event.touches[0];
    const x = Math.max(0, Math.min(touch.clientX - rect.left, rect.width));
    const percent = Math.max(0, Math.min((x / rect.width) * 100, 100));
    setSliderPosition(percent);
  };

  return (
    <div 
      className="relative w-full aspect-[3/4] md:aspect-square rounded-xl overflow-hidden cursor-col-resize select-none shadow-2xl border-4 border-indigo-500/30 touch-none"
      onMouseDown={() => isDragging.current = true}
      onMouseUp={() => isDragging.current = false}
      onMouseLeave={() => isDragging.current = false}
      onMouseMove={handleMove}
      onTouchStart={() => isDragging.current = true}
      onTouchEnd={() => isDragging.current = false}
      onTouchMove={handleTouchMove}
    >
      <img src={beforeImage} alt="Before" className="absolute inset-0 w-full h-full object-cover pointer-events-none" />
      <div className="absolute top-4 left-4 bg-black/60 text-white px-2 py-1 text-xs rounded font-bold z-20 pointer-events-none">ORIGINAL</div>
      <div 
        className="absolute inset-0 w-full h-full overflow-hidden pointer-events-none"
        style={{ clipPath: `inset(0 ${100 - sliderPosition}% 0 0)` }}
      >
        <img src={afterImage} alt="After" className="absolute inset-0 w-full h-full object-cover" />
      </div>
      <div className="absolute top-4 right-4 bg-indigo-600/80 text-white px-2 py-1 text-xs rounded font-bold z-20 pointer-events-none">RESULT</div>
      <div 
        className="absolute inset-y-0 w-1 bg-white cursor-col-resize z-30 shadow-[0_0_10px_rgba(0,0,0,0.5)]"
        style={{ left: `${sliderPosition}%` }}
      >
        <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-8 h-8 bg-white rounded-full flex items-center justify-center shadow-lg text-indigo-600">
          <ArrowRightLeft size={16} />
        </div>
      </div>
    </div>
  );
};

export default function App() {
  const [theme, setTheme] = useState('light');
  
  // --- LOGIN STATE ---
  const [isAuthenticated, setIsAuthenticated] = useState(false);
  const [storedCreds, setStoredCreds] = useState({ username: 'admin', password: '12345' }); // NEW: Dynamic storage
  const [loginCreds, setLoginCreds] = useState({ username: '', password: '' });
  const [loginError, setLoginError] = useState('');
  
  // --- SETTINGS STATE ---
  const [isSettingsOpen, setIsSettingsOpen] = useState(false); // NEW
  const [tempCreds, setTempCreds] = useState({ username: '', password: '' }); // NEW

  // --- REVIEW MODAL STATE (NEW) ---
  const [reviewData, setReviewData] = useState(null); // { type: 'image'|'text', content: any, title: string }

  // --- VIEW MODE STATE (NEW) ---
  const [viewMode, setViewMode] = useState('mobile'); // 'mobile' | 'desktop'

  const [activeTab, setActiveTab] = useState('photopass'); 
  const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false); 
  // State untuk kategori menu yang terbuka
  const [expandedCategories, setExpandedCategories] = useState(['studio']); // Default 'studio' terbuka

  const [user, setUser] = useState(null); 
  
  // State Upload Images
  const [uploadedImages, setUploadedImages] = useState({
    product: [],
    prewedFemale: null, 
    prewedMale: null,
    faceswapSource: null,
    faceswapTarget: null,
    mixer: [],
    photoMerge: [], 
    restore: [],
    enhancer: [], // NEW: State untuk Enhancer
    banner: [],
    prompt: [],
    coloring: [],
    scanText: null,
    changeBg: null,        // Foto untuk Ganti Background
    changeBgReference: null, // NEW: Foto Referensi untuk Ganti Background
    photopass: [],
    photographerMain: null,
    photographerPartner: null,
    photographerBaby: null,
    writer: null,
    consultant: null,
    fashionGarment: null, // NEW: Foto Baju
    fashionModel: null,    // NEW: Foto Model
    artistPhoto: null,     // NEW: Foto Bareng Artis (User)
    artistTarget: null,    // NEW: Foto Bareng Artis (Artis)
    productArtist: null,   // NEW: Foto Artis untuk Endorse Produk
    artCaricature: null    // NEW: Foto untuk Art & Karikatur
  });
  
  // State Inputs Umum
  const [prompt, setPrompt] = useState('');
  const [negativePrompt, setNegativePrompt] = useState(''); 
  const [promptStyle, setPromptStyle] = useState('None');   
  const [promptAspectRatio, setPromptAspectRatio] = useState('1:1'); 
  const [isHighQuality, setIsHighQuality] = useState(true); // NEW: High Quality Toggle Default On

  // State Pas Foto Pro (NEW)
  const [pasFotoGender, setPasFotoGender] = useState('Pria');
  const [pasFotoSize, setPasFotoSize] = useState('3x4');
  const [pasFotoBg, setPasFotoBg] = useState('Merah (Kode 485C)');
  const [pasFotoOutfit, setPasFotoOutfit] = useState('Kemeja Putih Polos');
  const [pasFotoRetouch, setPasFotoRetouch] = useState({
    smoothSkin: true,
    brightenEyes: true,
    fixHair: false,
    formalPosture: true
  });
  const [customOutfitImage, setCustomOutfitImage] = useState(null);

  // State Change Background (NEW)
  const [changeBgCategory, setChangeBgCategory] = useState('Dewasa'); // 'Dewasa' or 'Anak-anak'
  const [changeBgStyle, setChangeBgStyle] = useState('Studio Profesional');
  const [changeBgMode, setChangeBgMode] = useState('preset'); // NEW: 'preset' | 'upload'

  // State Enhancer Options (NEW UPDATED)
  const [enhancerBlurBg, setEnhancerBlurBg] = useState(false);
  const [enhancerColorFilter, setEnhancerColorFilter] = useState('Normal');
  const [enhancerBgEnhance, setEnhancerBgEnhance] = useState(false);
  const [enhancerFaceEnhance, setEnhancerFaceEnhance] = useState(true);

  // State Face Swap Professional
  const [swapMode, setSwapMode] = useState('Realistic');
  const [enableFaceEnhance, setEnableFaceEnhance] = useState(true);
  const [matchSkinTone, setMatchSkinTone] = useState(true);

  // State Fashion AI (NEW)
  const [fashionType, setFashionType] = useState('Atasan (Kaos/Kemeja)');
  const [fashionShotType, setFashionShotType] = useState('Full Body'); // NEW: Shot Type State
  const [fashionBg, setFashionBg] = useState('Asli (Original)'); // NEW: Fashion Background State

  // State Artist Photo (NEW)
  const [selectedArtist, setSelectedArtist] = useState('');
  const [artistMode, setArtistMode] = useState('name'); // 'name' or 'upload'

  // State Art & Karikatur (NEW)
  const [artType, setArtType] = useState('painting'); // 'painting' or 'caricature'
  const [artStyle, setArtStyle] = useState('Cat Air');
  const [artCustomStyle, setArtCustomStyle] = useState('');

  // State Coloring Page
  const [coloringComplexity, setColoringComplexity] = useState('Anak-anak'); // 'Anak-anak', 'Dewasa'
  const [coloringMode, setColoringMode] = useState('text'); // 'text' (Prompt) or 'upload' (Konversi)

  // State Scan Text (NEW)
  const [scanTextResult, setScanTextResult] = useState('');
  const [isScanTextLoading, setIsScanTextLoading] = useState(false);

  // State Photo Merge (Family Photo) Professional
  const [mergeMode, setMergeMode] = useState('Seamless'); // Seamless vs Collage
  const [mergeTheme, setMergeTheme] = useState('Studio Polos');
  const [mergeOutfit, setMergeOutfit] = useState('Asli');
  const [mergeRatio, setMergeRatio] = useState('16:9');

  // State Product Photography Professional
  const [productRatio, setProductRatio] = useState('1:1');
  const [productBg, setProductBg] = useState('Studio Putih');
  const [productLight, setProductLight] = useState('Softbox Studio');
  const [productPlacement, setProductPlacement] = useState('Meja Minimalis');
  
  // -- NEW STATE: Product Tab (Standard vs Artist Endorse) --
  const [productTab, setProductTab] = useState('standard'); // 'standard' | 'artist'
  const [endorseCategory, setEndorseCategory] = useState('indo'); // 'indo' | 'hollywood'
  const [endorseArtist, setEndorseArtist] = useState('Raffi Ahmad');

  const [bannerText, setBannerText] = useState('');
  const [bannerStyle, setBannerStyle] = useState('');
  
  // State Photographer (Maternity & Newborn)
  const [photographerTab, setPhotographerTab] = useState('maternity'); 
  const [aspectRatio, setAspectRatio] = useState('9:16');

  // -- MATERNITY STATES (ENHANCED) --
  const [maternityPose, setMaternityPose] = useState('Berdiri (pamer perut)');
  const [maternityOutfit, setMaternityOutfit] = useState('Gaun panjang');
  const [maternityTheme, setMaternityTheme] = useState('Studio bunga');
  const [maternityThemeManual, setMaternityThemeManual] = useState(''); // NEW
  const [maternityLighting, setMaternityLighting] = useState('Soft Window Light'); // NEW
  const [maternityShotType, setMaternityShotType] = useState('Full Body'); // NEW
  const [maternityProp, setMaternityProp] = useState('Tanpa Properti'); // NEW
  
  // -- NEWBORN STATES (ENHANCED) --
  const [newbornGender, setNewbornGender] = useState('Laki-laki');
  const [newbornTheme, setNewbornTheme] = useState('Studio putih');
  const [newbornThemeManual, setNewbornThemeManual] = useState(''); 
  const [newbornName, setNewbornName] = useState('');
  const [newbornDate, setNewbornDate] = useState('');
  const [newbornDecorationMode, setNewbornDecorationMode] = useState('Otomatis');
  const [newbornPose, setNewbornPose] = useState('Tidur Terlentang');
  const [newbornOutfit, setNewbornOutfit] = useState('Kain Bedong (Wrap)');
  const [newbornAccessory, setNewbornAccessory] = useState('Boneka Beruang');

  // State AI Copywriter
  const [writerMode, setWriterMode] = useState('caption');
  const [writerTone, setWriterTone] = useState('Santai & Seru');
  const [writerResult, setWriterResult] = useState('');
  const [isWriterLoading, setIsWriterLoading] = useState(false);

  // State Idea Developer
  const [ideaText, setIdeaText] = useState('');
  const [ideaResult, setIdeaResult] = useState('');
  const [ideaCitations, setIdeaCitations] = useState([]);
  const [isIdeaLoading, setIsIdeaLoading] = useState(false);

  // State Consultant (Bedah Foto) 
  const [consultantResult, setConsultantResult] = useState('');
  const [isConsultantLoading, setIsConsultantLoading] = useState(false);

  // State Voiceover (TTS) - ENHANCED
  const [voiceoverMode, setVoiceoverMode] = useState('single'); // 'single' | 'dialogue'
  const [voiceLanguage, setVoiceLanguage] = useState('Bahasa Indonesia');
  const [voiceTopic, setVoiceTopic] = useState(''); // Input for auto-script
  const [voiceText, setVoiceText] = useState('');
  const [selectedVoice, setSelectedVoice] = useState('Kore'); // Voice 1 / Single
  const [voice2, setVoice2] = useState('Puck'); // Voice 2 (Dialogue)
  const [voiceStyle, setVoiceStyle] = useState('Normal'); 
  const [audioUrl, setAudioUrl] = useState(null);
  const [isAudioGenerating, setIsAudioGenerating] = useState(false);
  const [isVoiceScriptLoading, setIsVoiceScriptLoading] = useState(false); // State for script generator
  const [isPlaying, setIsPlaying] = useState(false);
  const audioRef = useRef(null);

  // --- EFFECT: AUDIO RELOAD FIX ---
  // Memastikan player mereset state dan memuat ulang saat ada audio baru
  useEffect(() => {
      if (audioUrl && audioRef.current) {
          audioRef.current.pause();
          audioRef.current.currentTime = 0;
          audioRef.current.load();
          setIsPlaying(false);
      }
  }, [audioUrl]);

  // State New Gemini Features
  const [isEnhancing, setIsEnhancing] = useState(false);
  const [isAnalyzing, setIsAnalyzing] = useState(false);

  // State System
  const [generatedImages, setGeneratedImages] = useState([]); 
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState(null);

  // Constants - PROMPT ENGINEERING
  const QUALITY_KEYWORDS = "8k resolution, photorealistic, masterpiece, ultra-detailed, sharp focus, high fidelity, raw photo, studio quality, cinematic lighting, HDR, distinct features, perfect composition";
  const NEGATIVE_PROMPT_UNIVERSAL = "blur, low quality, distorted, ugly, pixelated, watermark, text, bad anatomy, bad hands, cartoon, illustration, painting, extra limbs, missing limbs, deformation, noise, grainy";

  // Constants - ENHANCER COLOR FILTERS
  const ENHANCER_FILTERS = [
      { id: 'Normal', label: 'Normal' },
      { id: 'Whiten', label: 'Whiten (Putihkan)' },
      { id: 'Brighten', label: 'Brighten (Cerahkan)' },
      { id: 'Smooth', label: 'Smooth (Halus)' },
      { id: 'Skin Bright', label: 'Skin Bright' },
      { id: 'Face Tune', label: 'Face Tune' },
      { id: 'Exposure', label: 'Exposure' },
      { id: 'Highlights', label: 'Highlights' }
  ];

  // Constants - FASHION
  const FASHION_TYPES = ['Atasan (Kaos/Kemeja)', 'Gaun/Dress', 'Jaket/Outer', 'Celana/Rok (Bawahan)', 'Full Outfit'];
  const FASHION_SHOT_TYPES = ['Full Body', 'Half Body', 'Close Up', 'Portrait']; // NEW: Shot Type Options
  const FASHION_BACKGROUNDS = ['Asli (Original)', 'Studio Putih', 'Jalanan Kota', 'Pantai', 'Taman Bunga', 'Cafe Estetik', 'Abstrak Mewah']; // NEW: Fashion Backgrounds

  // Constants - CHANGE BACKGROUND (NEW)
  const BG_ADULT_OPTIONS = ['Studio Profesional', 'Kantor Modern', 'Abstrak Mewah', 'Alam (Hutan/Pantai)', 'Cafe Estetik', 'Warna Solid (Pas Foto)', 'Perpustakaan Klasik', 'Gedung Pencakar Langit', 'Rumah Minimalis'];
  const BG_CHILD_OPTIONS = ['Taman Bermain', 'Dunia Fantasi', 'Luar Angkasa', 'Kartun Ceria', 'Sekolah TK/PAUD', 'Langit Biru Berawan', 'Kebun Binatang', 'Bawah Laut', 'Kastil Kerajaan'];

  // Constants - ART & KARIKATUR (NEW)
  const ART_PAINTING_STYLES = ['Cat Air', 'Lukisan Minyak', 'Sketsa Pensil', 'Digital Art', 'Impresionis', 'Kustom'];
  const ART_CARICATURE_STYLES = ['3D Kartun', 'Anime', 'Stiker Lucu', 'Komik US', 'Klasik', 'Kepala Besar (Tiny Body)', 'Chibi-style Caricature', 'Chibi-style Kartun', 'Kustom'];

  // Constants - PAS FOTO PRO UPDATED
  const PAS_FOTO_SIZES = [
    { id: '2x3', label: '2x3 cm', ratio: '2:3' },
    { id: '3x4', label: '3x4 cm', ratio: '3:4' },
    { id: '4x6', label: '4x6 cm', ratio: '4:6' },
    { id: 'visa', label: 'Visa/Passport', ratio: '1:1' }
  ];

  const PAS_FOTO_BACKGROUNDS = [
    { id: 'Merah (Kode 485C)', label: 'Merah (Tahun Ganjil)', color: '#DB2628' },
    { id: 'Biru (Kode 300C)', label: 'Biru (Tahun Genap)', color: '#005CAB' },
    { id: 'Putih Studio', label: 'Putih (Visa/Nikah)', color: '#FFFFFF', border: true },
    { id: 'Abu-abu Profesional', label: 'Abu-abu (Karyawan)', color: '#808080' }
  ];

  const PAS_FOTO_OUTFITS_MALE = [
    'Kemeja Putih Polos', 'Kemeja Putih + Dasi Hitam', 'Jas Hitam Formal', 'Batik Resmi', 'Seragam PNS/ASN', 'Kustom'
  ];

  const PAS_FOTO_OUTFITS_FEMALE = [
    'Kemeja Putih Polos', 'Blazer Hitam Formal', 'Hijab Hitam + Kemeja Putih', 'Hijab Putih + Jas', 'Batik Resmi Wanita', 'Kustom'
  ];

  // -- MATERNITY CONSTANTS (ENHANCED) --
  const MATERNITY_POSES = ['Berdiri (pamer perut)', 'Duduk elegan', 'Tangan di perut (Heart)', 'Melihat ke perut', 'Berbaring di Sofa', 'Walking with Partner', 'Silhouette Profile'];
  const MATERNITY_OUTFITS = ['Gaun panjang', 'Flying Fabric (Kain Terbang)', 'Lace Robe (Jubah Renda)', 'Pake daster elegan', 'Gamis', 'Wrap dress + cardigan', 'Bodycon Dress', 'Kemeja Putih Oversize', 'Casual Jeans & Shirt'];
  const MATERNITY_THEMES = ['Studio bunga', 'Elegan gelap (Low Key)', 'Bohemian', 'Taman sore', 'Pantai Sunset', 'Jendela Besar (Natural)', 'Studio Polos (High Key)', 'Manual'];
  const MATERNITY_LIGHTING = ['Soft Window Light', 'Golden Hour', 'Silhouette (Backlight)', 'Studio Flash (Crisp)', 'Moody & Dramatic', 'Rim Light'];
  const MATERNITY_SHOT_TYPES = ['Full Body', 'Half Body', 'Close Up (Belly Focus)', 'Wide Angle (Scenery)'];
  const MATERNITY_PROPS = ['Tanpa Properti', 'Foto USG', 'Sepatu Bayi', 'Papan Nama', 'Bunga Mawar', 'Mahkota Bunga'];

  // -- NEWBORN CONSTANTS (ENHANCED) --
  const NEWBORN_THEMES = ['Studio putih', 'Pastel', 'Keranjang Rotan', 'Awan/Langit', 'Bunga-bunga', 'Muslim/Adat', 'Rustic Kayu', 'Manual'];
  const NEWBORN_POSES = ['Tidur Terlentang', 'Froggy (Kodok)', 'Taco (Lipat)', 'Potato Sack (Bedong Berdiri)', 'Chin on Hands (Dagu di Tangan)', 'Side Lying (Miring)'];
  const NEWBORN_OUTFITS = ['Kain Bedong (Wrap)', 'Polos (Skin)', 'Kostum Rajut Hewan', 'Gaun/Jas Mini', 'Topi & Celana', 'Piyama'];
  const NEWBORN_ACCESSORIES = ['Boneka Beruang', 'Tidak Ada', 'Bunga Segar', 'Mahkota Kecil', 'Papan Nama Kayu', 'Headband Bunga', 'Bulan Sabit'];
  
  const NEWBORN_RATIOS = ['16:9', '9:16', '1:1', '3:4'];
  const WRITER_TONES = ['Santai & Seru', 'Profesional', 'Emosional', 'Lucu', 'Persuasif (Jualan)'];
  
  // -- ARTIST LISTS --
  // Removed ARTISTS_INDO as it is replaced by upload
  const ARTISTS_HOLLYWOOD = ['Taylor Swift', 'Dwayne Johnson', 'Kim Kardashian', 'Leonardo DiCaprio', 'Zendaya', 'Tom Holland', 'Kylie Jenner', 'Selena Gomez', 'Ariana Grande', 'Chris Hemsworth'];

  // -- UPDATED: COMPREHENSIVE VOICE LIST --
  // Categorized Voices
  const VOICES_FEMALE = [
    'Kore', 'Leda', 'Aoede', 'Callirrhoe', 'Autonoe', 'Algieba', 
    'Despina', 'Erinome', 'Laomedeia', 'Achernar', 'Pulcherrima', 
    'Achird', 'Vindemiatrix', 'Sulafat'
  ];

  const VOICES_MALE = [
    'Zephyr', 'Puck', 'Charon', 'Fenrir', 'Orus', 'Enceladus', 
    'Iapetus', 'Umbriel', 'Algenib', 'Rasalgethi', 'Alnilam', 
    'Schedar', 'Gacrux', 'Zubenelgenubi', 'Sadachbia', 'Sadaltager'
  ];

  const VOICES = [...VOICES_FEMALE, ...VOICES_MALE]; // Helper for validation if needed

  // -- NEW: VOICE STYLES --
  const VOICE_STYLES = [
    { id: 'Normal', label: 'Normal' },
    { id: 'Happy', label: 'Ceria (Happy)' },
    { id: 'Sad', label: 'Sedih (Sad)' },
    { id: 'Excited', label: 'Semangat (Excited)' },
    { id: 'Whisper', label: 'Berbisik (Whisper)' },
    { id: 'Deep', label: 'Berat (Wibawa)' },
    { id: 'Fast', label: 'Cepat (Promo Kilat)' },
    { id: 'Slow', label: 'Lambat (Dramatis)' },
    { id: 'News Anchor', label: 'Berita (News)' },
    { id: 'Storyteller', label: 'Mendongeng' }
  ];

  const VOICE_LANGUAGES = [
      'Bahasa Indonesia', 'Bahasa Inggris (US)', 'Bahasa Inggris (UK)', 'Bahasa Jepang', 'Bahasa Korea', 'Bahasa Arab', 'Bahasa Jawa (Logat)'
  ];
  
  // Constants for Merge / Family Photo
  const MERGE_THEMES = ['Studio Polos', 'Taman Bunga', 'Ruang Tamu Mewah', 'Pantai Sunset', 'Abstrak Elegan', 'Perpustakaan Klasik', 'Kustom (dari Prompt)'];
  const MERGE_OUTFITS = ['Asli', 'Seragam Putih', 'Batik Formal', 'Casual Matching (Jeans+Kaos)', 'Jas & Gaun Malam', 'Pakaian Adat'];

  // Constants for Product Photography
  const PRODUCT_RATIOS = ['1:1', '9:16', '16:9', '4:5', '3:4'];
  const PRODUCT_BACKGROUNDS = ['Studio Putih', 'Studio Hitam', 'Marmer Mewah', 'Kayu Rustic', 'Warna Pastel', 'Neon Cyberpunk', 'Alam/Outdoor', 'Dapur Modern', 'Kustom'];
  const PRODUCT_LIGHTING = ['Softbox Studio', 'Sinar Matahari (Natural)', 'Golden Hour', 'Cinematic Neon', 'Dramatic Shadow', 'Ring Light'];
  const PRODUCT_PLACEMENTS = ['Meja Minimalis', 'Podium Geometris', 'Batu Alam', 'Kain Sutra', 'Lantai Kayu', 'Mengapung (Levitasi)', 'Tangan Model'];

  // Constants for Professional Prompt AI
  const PROMPT_STYLES = [
    'None', 'Cinematic', 'Photorealistic', 'Anime', '3D Render', 'Digital Art', 'Oil Painting', 'Cyberpunk', 'Minimalist', 'Vintage', 'Watercolor', 'Sketch'
  ];
  const PROMPT_RATIOS = ['1:1', '16:9', '9:16', '4:3', '3:4', '21:9'];

  // Definisi Kategori Menu Baru
  const NAV_CATEGORIES = [
    {
      id: 'studio',
      label: 'Studio Digital',
      icon: Camera,
      items: [
        { id: 'photopass', label: 'Pas Foto Pro', icon: User, color: 'bg-green-600' },
        { id: 'photographer', label: 'Photografer Studio', icon: Camera, color: 'bg-rose-600' },
        { id: 'art_caricature', label: 'Art & Karikatur', icon: Palette, color: 'bg-fuchsia-600' }, 
        { id: 'artist_photo', label: 'Foto Bareng Artis', icon: Star, color: 'bg-yellow-500' },
        { id: 'prewed', label: 'Prewedding AI', icon: Heart, color: 'bg-purple-600' },
        { id: 'photo_merge', label: 'Foto Keluarga', icon: Users, color: 'bg-cyan-600' },
      ]
    },
    {
      id: 'business',
      label: 'Bisnis & Promosi',
      icon: Briefcase,
      items: [
        { id: 'product', label: 'Foto Produk Pro', icon: Package, color: 'bg-blue-600' },
        { id: 'fashion', label: 'Model AI (Baju)', icon: ShoppingBag, color: 'bg-pink-500' },
        { id: 'banner', label: 'Buat Banner', icon: Layout, color: 'bg-orange-600' },
        { id: 'writer', label: 'AI Copywriter', icon: PenTool, color: 'bg-amber-600' },
        { id: 'voiceover', label: 'Generator Suara Narasi', icon: Mic, color: 'bg-red-500' },
      ]
    },
    {
      id: 'editing',
      label: 'Edit & Restorasi',
      icon: Wrench,
      items: [
        { id: 'enhancer', label: 'Enhance Foto (HD)', icon: ZapIcon, color: 'bg-amber-500' }, // NEW: Menu Enhancer
        { id: 'change_bg', label: 'Ganti Background', icon: ImagePlus, color: 'bg-cyan-500' },
        { id: 'restore', label: 'Restore Foto', icon: Wrench, color: 'bg-teal-600' },
        { id: 'faceswap', label: 'Face Swap', icon: ScanFace, color: 'bg-indigo-600' },
        { id: 'mixer', label: 'Image Mixer', icon: Layers, color: 'bg-violet-600' },
        { id: 'consultant', label: 'Bedah Foto', icon: Stethoscope, color: 'bg-teal-500' },
      ]
    },
    {
      id: 'tools',
      label: 'Tools Pintar',
      icon: Sparkles,
      items: [
        { id: 'scan_text', label: 'Scan ke Teks', icon: ScanLine, color: 'bg-emerald-600' },
        { id: 'coloring', label: 'Gambar Mewarnai', icon: Pencil, color: 'bg-fuchsia-500' },
        { id: 'ideadev', label: 'Ide Cerdas', icon: Lightbulb, color: 'bg-yellow-500' },
        { id: 'prompt', label: 'Prompt AI', icon: MessageSquare, color: 'bg-pink-600' },
      ]
    }
  ];

  // Helper untuk mendapatkan semua item (flattened) untuk pencarian aktif
  const ALL_NAV_ITEMS = NAV_CATEGORIES.flatMap(cat => cat.items);

  const toggleCategory = (categoryId) => {
    setExpandedCategories(prev => 
      prev.includes(categoryId) 
        ? prev.filter(id => id !== categoryId) 
        : [...prev, categoryId]
    );
  };

  // --- FIREBASE EFFECT: AUTHENTICATION ---
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (err) {
        console.error("Auth Error", err);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
        setUser(currentUser);
    });
    return () => unsubscribe();
  }, []);

  // --- FIREBASE EFFECT: LOAD IDEA ---
  useEffect(() => {
      if (!user || activeTab !== 'ideadev') return;

      const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'ideas', 'mainIdea');
      const unsubscribe = onSnapshot(docRef, (docSnap) => {
          if (docSnap.exists()) {
              setIdeaText(docSnap.data().content || '');
          }
      }, (err) => console.error("Snapshot error:", err));

      return () => unsubscribe();
  }, [user, activeTab]);

  // --- THEME ---
  useEffect(() => {
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      setTheme('dark');
    }
  }, []);

  const toggleTheme = () => setTheme(theme === 'light' ? 'dark' : 'light');

  // --- VIEW MODE TOGGLE ---
  const toggleViewMode = () => setViewMode(prev => prev === 'mobile' ? 'desktop' : 'mobile');

  // --- LOGIN HANDLER ---
  const handleLogin = (e) => {
    e.preventDefault();
    // Validasi Dinamis (Updated Logic)
    if (loginCreds.username === storedCreds.username && loginCreds.password === storedCreds.password) {
        setIsAuthenticated(true);
        setLoginError('');
    } else {
        setLoginError('Username atau password salah.');
    }
  };

  const handleLogout = () => {
      setIsAuthenticated(false);
      setLoginCreds({ username: '', password: '' });
  };

  // --- SETTINGS HANDLER (NEW) ---
  const handleOpenSettings = () => {
    setTempCreds(storedCreds); // Load current creds into temp
    setIsSettingsOpen(true);
  };

  const handleSaveSettings = (e) => {
    e.preventDefault();
    if (!tempCreds.username || !tempCreds.password) return; // Simple validation
    setStoredCreds(tempCreds); // Save temp to stored
    setIsSettingsOpen(false);
  };

  // --- UTILS ---
  const fileToBase64 = (file) => {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = () => resolve(reader.result);
      reader.onerror = (error) => reject(error);
    });
  };

  const handlePhotopassUpload = async (e, type) => {
      const files = Array.from(e.target.files);
      setError(null);
      if (files.length === 0 || !files[0].type.startsWith('image/')) {
          setError("Silakan unggah file gambar.");
          return;
      }
      const file = files[0];
      try {
          const base64 = await fileToBase64(file);
          const newImage = { id: Date.now() + Math.random(), file: file, preview: base64 };
          if (type === 'main') setUploadedImages(prev => ({ ...prev, photopass: [newImage] }));
          else if (type === 'outfit') setCustomOutfitImage(newImage);
      } catch (err) { setError("Gagal membaca file gambar."); }
  };

  const handleGeneralFileUpload = async (e, specificType = null) => {
    const files = Array.from(e.target.files);
    setError(null);
    if (files.length === 0 || !files[0].type.startsWith('image/')) { setError("Silakan unggah file gambar."); return; }
    
    // Check for multiple files for photo_merge or prompt
    if ((activeTab === 'photo_merge' || activeTab === 'prompt') && files.length > 0) {
        const targetArray = activeTab === 'photo_merge' ? uploadedImages.photoMerge : uploadedImages.prompt;
        const maxSlots = activeTab === 'photo_merge' ? 8 : 4;
        
        const remainingSlots = maxSlots - targetArray.length;
        if (remainingSlots <= 0) { setError(`Maksimal ${maxSlots} foto.`); return; }
        
        const filesToProcess = files.slice(0, remainingSlots);
        try {
            const processedImages = await Promise.all(filesToProcess.map(async (file) => {
                const base64 = await fileToBase64(file);
                return { id: Date.now() + Math.random(), file: file, preview: base64 };
            }));
            if (activeTab === 'photo_merge') {
                setUploadedImages(prev => ({ ...prev, photoMerge: [...prev.photoMerge, ...processedImages] }));
            } else {
                setUploadedImages(prev => ({ ...prev, prompt: [...prev.prompt, ...processedImages] }));
            }
        } catch (err) { setError("Gagal membaca file."); }
        return;
    }

    const file = files[0];
    try {
      const base64 = await fileToBase64(file);
      const newImage = { id: Date.now() + Math.random(), file: file, preview: base64 };
      if (activeTab === 'product') {
          if (specificType === 'artist') {
             setUploadedImages(prev => ({ ...prev, productArtist: newImage }));
          } else {
             setUploadedImages(prev => ({ ...prev, product: [newImage] }));
          }
      } else if (activeTab === 'restore') setUploadedImages(prev => ({ ...prev, restore: [newImage] }));
      else if (activeTab === 'enhancer') setUploadedImages(prev => ({ ...prev, enhancer: [newImage] })); // NEW: Enhancer Upload
      else if (activeTab === 'change_bg') {
         if (specificType === 'reference') setUploadedImages(prev => ({ ...prev, changeBgReference: newImage }));
         else setUploadedImages(prev => ({ ...prev, changeBg: newImage })); 
      }
      else if (activeTab === 'banner') setUploadedImages(prev => ({ ...prev, banner: [newImage] }));
      else if (activeTab === 'consultant') setUploadedImages(prev => ({ ...prev, consultant: newImage }));
      else if (activeTab === 'scan_text') setUploadedImages(prev => ({ ...prev, scanText: newImage }));
      else if (activeTab === 'coloring') setUploadedImages(prev => ({ ...prev, coloring: [newImage] }));
      else if (activeTab === 'faceswap') {
        if (specificType === 'source') setUploadedImages(prev => ({ ...prev, faceswapSource: newImage }));
        else if (specificType === 'target') setUploadedImages(prev => ({ ...prev, faceswapTarget: newImage }));
      } else if (activeTab === 'prewed') {
        if (specificType === 'female') setUploadedImages(prev => ({ ...prev, prewedFemale: newImage }));
        else if (specificType === 'male') setUploadedImages(prev => ({ ...prev, prewedMale: newImage }));
      } else if (activeTab === 'mixer') {
        if (uploadedImages.mixer.length >= 4) { setError("Maksimal 4 foto."); return; }
        setUploadedImages(prev => ({ ...prev, mixer: [...prev.mixer, newImage] }));
      } else if (activeTab === 'photographer') {
        if (specificType === 'main') setUploadedImages(prev => ({ ...prev, photographerMain: newImage }));
        else if (specificType === 'partner') setUploadedImages(prev => ({ ...prev, photographerPartner: newImage }));
        else if (specificType === 'baby') setUploadedImages(prev => ({ ...prev, photographerBaby: newImage }));
      } else if (activeTab === 'writer') {
        setUploadedImages(prev => ({ ...prev, writer: newImage }));
      } else if (activeTab === 'fashion') {
        if (specificType === 'garment') setUploadedImages(prev => ({ ...prev, fashionGarment: newImage }));
        else if (specificType === 'model') setUploadedImages(prev => ({ ...prev, fashionModel: newImage }));
      } else if (activeTab === 'artist_photo') {
        if (specificType === 'target') setUploadedImages(prev => ({ ...prev, artistTarget: newImage }));
        else setUploadedImages(prev => ({ ...prev, artistPhoto: newImage }));
      } else if (activeTab === 'art_caricature') {
        setUploadedImages(prev => ({ ...prev, artCaricature: newImage }));
      }
    } catch (err) { setError("Gagal membaca file gambar."); }
  };

  const removeImage = (id, type) => {
    if (type === 'product') setUploadedImages(prev => ({ ...prev, product: [] }));
    else if (type === 'restore') setUploadedImages(prev => ({ ...prev, restore: [] }));
    else if (type === 'enhancer') setUploadedImages(prev => ({ ...prev, enhancer: [] })); // NEW
    else if (type === 'changeBg') setUploadedImages(prev => ({ ...prev, changeBg: null }));
    else if (type === 'changeBgReference') setUploadedImages(prev => ({ ...prev, changeBgReference: null })); // NEW
    else if (type === 'coloring') setUploadedImages(prev => ({ ...prev, coloring: [] }));
    else if (type === 'scanText') setUploadedImages(prev => ({ ...prev, scanText: null })); 
    else if (type === 'banner') setUploadedImages(prev => ({ ...prev, banner: [] }));
    else if (type === 'prewedFemale') setUploadedImages(prev => ({ ...prev, prewedFemale: null }));
    else if (type === 'prewedMale') setUploadedImages(prev => ({ ...prev, prewedMale: null }));
    else if (type === 'faceswapSource') setUploadedImages(prev => ({ ...prev, faceswapSource: null }));
    else if (type === 'faceswapTarget') setUploadedImages(prev => ({ ...prev, faceswapTarget: null }));
    else if (type === 'fashionGarment') setUploadedImages(prev => ({ ...prev, fashionGarment: null }));
    else if (type === 'fashionModel') setUploadedImages(prev => ({ ...prev, fashionModel: null }));
    else if (type === 'mixer') setUploadedImages(prev => ({ ...prev, mixer: prev.mixer.filter(img => img.id !== id) }));
    else if (type === 'photoMerge') setUploadedImages(prev => ({ ...prev, photoMerge: prev.photoMerge.filter(img => img.id !== id) })); 
    else if (type === 'prompt') setUploadedImages(prev => ({ ...prev, prompt: prev.prompt.filter(img => img.id !== id) }));
    else if (type === 'photopass') { setUploadedImages(prev => ({ ...prev, photopass: [] })); setCustomOutfitImage(null); }
    else if (type === 'customOutfit') setCustomOutfitImage(null);
    else if (type === 'photographerMain') setUploadedImages(prev => ({ ...prev, photographerMain: null }));
    else if (type === 'photographerPartner') setUploadedImages(prev => ({ ...prev, photographerPartner: null }));
    else if (type === 'photographerBaby') setUploadedImages(prev => ({ ...prev, photographerBaby: null }));
    else if (type === 'writer') setUploadedImages(prev => ({ ...prev, writer: null }));
    else if (type === 'consultant') setUploadedImages(prev => ({ ...prev, consultant: null }));
    else if (type === 'artistPhoto') setUploadedImages(prev => ({ ...prev, artistPhoto: null }));
    else if (type === 'artistTarget') setUploadedImages(prev => ({ ...prev, artistTarget: null }));
    else if (type === 'productArtist') setUploadedImages(prev => ({ ...prev, productArtist: null }));
    else if (type === 'artCaricature') setUploadedImages(prev => ({ ...prev, artCaricature: null }));
  };

  const generateAutoPrompt = () => {
    const ideasMap = {
      product: ["Tempatkan produk ini di atas meja marmer putih dengan pencahayaan studio.", "Latar belakang minimalis berwarna pastel dengan elemen botani."],
      restore: ["Restorasi foto ini agar terlihat baru, tajam, bersih.", "Hilangkan blur, pertajam detail wajah, koreksi warna."],
      enhancer: ["Pertajam detail foto ini agar terlihat jernih dan resolusi tinggi.", "Upscale foto ini menjadi 8K, perbaiki tekstur dan pencahayaan."], // NEW
      change_bg: ["Ubah background menjadi kantor modern yang elegan.", "Ganti latar dengan pemandangan taman bunga yang cerah."],
      prewed: ["Adegan romantis di taman bunga sakura saat musim semi.", "Berjalan di pantai saat matahari terbenam."],
      prompt: ["Potret close-up sinematik dengan pencahayaan neon.", "Lukisan minyak klasik bangsawan abad ke-18."],
      mixer: ["Kolase artistik surealis dengan latar belakang galaksi.", "Komposisi poster film dramatis."],
      coloring: ["Kastil putri kerajaan dengan naga lucu yang sedang tidur.", "Pemandangan hutan ajaib dengan jamur raksasa dan peri."], 
      photo_merge: ["Keluarga bahagia di taman bunga dengan pencahayaan matahari sore.", "Foto bersama formal di studio dengan latar belakang abu-abu klasik."],
      fashion: ["Gunakan baju dari foto pertama dan pakaikan ke model di foto kedua. Pertahankan pose model.", "Mix and match virtual: ganti atasan model dengan foto baju yang diupload."],
      artist_photo: ["Berfoto selfie dengan ceria di red carpet.", "Berpose formal di studio acara talkshow.", "Candid shot sedang mengobrol santai di cafe."],
      art_caricature: ["Ubah menjadi lukisan cat air yang lembut dan artistik.", "Buat karikatur kartun 3D yang lucu dengan kepala sedikit lebih besar."]
    };
    if (ideasMap[activeTab]) setPrompt(ideasMap[activeTab][Math.floor(Math.random() * ideasMap[activeTab].length)]);
  };

  const generateBannerText = () => setBannerText(["DISKON 50%", "BELI 1 GRATIS 1", "LIMITED EDITION"][Math.floor(Math.random() * 3)]);
  const generateBannerStyle = () => setBannerStyle(["Minimalis Modern", "Cyberpunk Neon", "Elegan Mewah"][Math.floor(Math.random() * 3)]);

  // --- GEMINI LLM FUNCTIONS ---
  
  const callGeminiLLM = async (systemInstruction, userPrompt, imageBase64 = null) => {
    try {
      const parts = [{ text: userPrompt }];
      if (imageBase64) {
        const base64Data = imageBase64.includes(',') ? imageBase64.split(',')[1] : imageBase64;
        parts.push({ inlineData: { mimeType: 'image/jpeg', data: base64Data } });
      }
      const response = await fetch(
        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ contents: [{ parts: parts }], systemInstruction: { parts: [{ text: systemInstruction }] } }),
        }
      );
      if (!response.ok) throw new Error(`API Error: ${response.status}`);
      const result = await response.json();
      return result.candidates?.[0]?.content?.parts?.[0]?.text || "Gagal menghasilkan teks.";
    } catch (err) {
      console.error(err);
      throw new Error("Maaf, AI sedang sibuk. Coba lagi nanti.");
    }
  };

  // Dedicated function for Idea Developer with Grounding
  const callGeminiIdeaDev = async (userQuery, systemPrompt) => {
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
    const payload = {
        contents: [{ parts: [{ text: userQuery }] }],
        tools: [{ "google_search": {} }],
        systemInstruction: { parts: [{ text: systemPrompt }] },
    };

    try {
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        if (!response.ok) throw new Error(`API Error: ${response.status}`);
        const result = await response.json();
        const candidate = result.candidates?.[0];
        
        let text = candidate?.content?.parts?.[0]?.text || "Maaf, tidak ada respons.";
        let sources = [];
        
        // Extract Grounding
        if (candidate?.groundingMetadata?.groundingAttributions) {
             sources = candidate.groundingMetadata.groundingAttributions
                .map(attr => ({ uri: attr.web?.uri, title: attr.web?.title }))
                .filter(s => s.uri && s.title)
                .reduce((unique, item) => {
                    return unique.some(u => u.uri === item.uri) ? unique : [...unique, item];
                }, []);
        }
        return { text, sources };
    } catch (err) {
        throw new Error(err.message);
    }
  };

  // Dedicated function for Text-to-Speech (Updated for Multi-Speaker)
  const callGeminiTTS = async (text, voiceConfigPayload) => {
    try {
      const response = await fetch(
        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: text }] }],
            generationConfig: {
              responseModalities: ["AUDIO"],
              ...voiceConfigPayload
            }
          })
        }
      );
      if (!response.ok) throw new Error(`API Error: ${response.status}`);
      const result = await response.json();
      const base64PCM = result.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
      if (!base64PCM) throw new Error("No audio data returned");
      return pcmToWav(base64PCM);
    } catch (err) {
      throw new Error(err.message);
    }
  };

  // --- HANDLERS ---
  
  // 1. Magic Prompt
  const handleMagicEnhance = async () => {
    if (!prompt.trim()) return setError("Tuliskan ide dasar dulu!");
    setIsEnhancing(true);
    try {
      const enhanced = await callGeminiLLM("You are an expert Prompt Engineer. Output ONLY the enhanced English prompt.", prompt);
      setPrompt(enhanced);
    } catch (e) { setError(e.message); } finally { setIsEnhancing(false); }
  };

  // 2. Vision
  const handleVisionScan = async () => {
    const refImage = uploadedImages.prompt[0] || uploadedImages.photographerMain || uploadedImages.product[0] || uploadedImages.artCaricature;
    if (!refImage) return setError("Upload foto referensi dulu!");
    setIsAnalyzing(true);
    try {
      const description = await callGeminiLLM("Analyze image and create a text-to-image prompt. Output ONLY the prompt in English.", "Analyze this.", refImage.preview);
      setPrompt(description);
    } catch (e) { setError(e.message); } finally { setIsAnalyzing(false); }
  };

  // 3. Writer
  const handleWriterGenerate = async () => {
    if (!prompt.trim() && !uploadedImages.writer) { setError("Isi topik atau upload gambar."); return; }
    setIsWriterLoading(true); setWriterResult(''); setError(null);
    let sysPrompt = "";
    if (writerMode === 'caption') sysPrompt = `Buatkan 3 caption sosmed (${writerTone}). Bahasa Indonesia.`;
    else if (writerMode === 'product') sysPrompt = `Copywriting produk (${writerTone}). Struktur: Headline, Fitur, Manfaat.`;
    else if (writerMode === 'letter') sysPrompt = `Surat resmi (${writerTone}).`;
    
    try {
      const text = await callGeminiLLM(sysPrompt, prompt || "Buat konten dari gambar ini.", uploadedImages.writer?.preview);
      setWriterResult(text);
    } catch (e) { setError(e.message); } finally { setIsWriterLoading(false); }
  };

  // 4. Idea Developer Handlers
  const handleSaveIdea = async () => {
      if (!user) return setError("Silakan login (otomatis) untuk menyimpan.");
      try {
          await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'ideas', 'mainIdea'), {
              content: ideaText,
              timestamp: new Date().toISOString()
          });
      } catch (e) { setError("Gagal menyimpan ide: " + e.message); }
  };

  const handleIdeaAction = async (actionType) => {
      if (!ideaText.trim()) return setError("Tuliskan ide Anda terlebih dahulu.");
      setIsIdeaLoading(true); setIdeaResult(''); setIdeaCitations([]); setError(null);
      
      let userQuery = "";
      let systemPrompt = "";
      
      if (actionType === 'expand') {
          userQuery = `Kembangkan ide berikut menjadi konsep terperinci, rencana implementasi, dan langkah awal konkret: "${ideaText}"`;
          systemPrompt = "Bertindak sebagai konsultan strategi. Analisis ide pengguna dan buat dokumen konsep terstruktur (Min 3 paragraf). Bahasa Indonesia. Sertakan tantangan dan solusi.";
      } else {
          userQuery = `Saring dan ringkas konsep berikut menjadi maksimal 5 poin penting. Teks asli: "${ideaText}"`;
          systemPrompt = "Bertindak sebagai editor cerdas. Padatkan esensi ide menjadi poin-poin (maks 5). Bahasa Indonesia.";
      }

      try {
          const { text, sources } = await callGeminiIdeaDev(userQuery, systemPrompt);
          setIdeaResult(text);
          setIdeaCitations(sources);
      } catch (e) {
          setError("Gagal memproses ide: " + e.message);
      } finally {
          setIsIdeaLoading(false);
      }
  };

  // 5. Photo Consultant Handler 
  const handleConsultantAnalyze = async () => {
    if (!uploadedImages.consultant) return setError("Upload foto yang mau dibedah dulu.");
    setIsConsultantLoading(true); setConsultantResult(''); setError(null);
    try {
      const result = await callGeminiLLM(
        "Anda adalah fotografer profesional kelas dunia. Tugas anda adalah 'Membedah Foto' pengguna. Analisis foto ini secara mendalam namun ramah. Berikan output dalam format Markdown: \n### ðŸ“¸ Analisis Visual\n- **Komposisi:** [Komentar]\n- **Pencahayaan:** [Komentar]\n- **Warna & Tone:** [Komentar]\n\n### ðŸ’¡ Kritik Membangun\n[Berikan 3 saran konkret untuk memperbaiki foto ini jika diambil ulang]\n\n### â­ Skor\nBerikan skor 1-10 untuk foto ini.",
        "Analisis foto ini dan berikan saran perbaikan.",
        uploadedImages.consultant.preview
      );
      setConsultantResult(result);
    } catch (e) { setError(e.message); } finally { setIsConsultantLoading(false); }
  };

  // 6. Voiceover Script Generator (NEW)
  const handleGenerateVoiceScript = async () => {
      if (!voiceTopic.trim()) return setError("Tuliskan topik naskah terlebih dahulu.");
      setIsVoiceScriptLoading(true);
      setError(null);
      try {
          let systemPrompt = "";
          let userQuery = "";
          
          if (voiceoverMode === 'single') {
              systemPrompt = `Anda adalah penulis naskah profesional. Buatkan naskah narasi pendek untuk voiceover. Gunakan bahasa ${voiceLanguage}. Tanpa label pembicara.`;
              userQuery = `Buatkan naskah narasi tentang: "${voiceTopic}". Gaya: ${voiceStyle}. Panjang sekitar 3-5 kalimat. Langsung ke isi naskah.`;
          } else {
              systemPrompt = `Anda adalah penulis skenario dialog. Buatkan dialog pendek antara dua orang (Speaker A dan Speaker B). Gunakan bahasa ${voiceLanguage}. Format WAJIB: Gunakan label "Speaker A:" dan "Speaker B:".`;
              userQuery = `Buatkan dialog menarik tentang: "${voiceTopic}". Gaya: ${voiceStyle}. Durasi pendek. Pastikan formatnya "Speaker A: [teks]" dan "Speaker B: [teks]".`;
          }
          
          const text = await callGeminiLLM(systemPrompt, userQuery);
          setVoiceText(text);
      } catch (e) {
          setError("Gagal membuat naskah: " + e.message);
      } finally {
          setIsVoiceScriptLoading(false);
      }
  };

  // 7. Voiceover Generator (Updated)
  const handleVoiceoverGenerate = async () => {
    if (!voiceText.trim()) return setError("Tuliskan teks narasi/dialog dulu.");
    setIsAudioGenerating(true); setAudioUrl(null); setError(null);
    try {
      let voiceConfigPayload = {};
      let textToSpeak = voiceText;

      if (voiceoverMode === 'single') {
          // Logic for Style/Tone Control via Natural Language Prompting (Single)
          let stylePrompt = "";
          switch (voiceStyle) {
              case 'Normal': stylePrompt = ""; break;
              case 'Happy': stylePrompt = "Say this cheerfully: "; break;
              case 'Sad': stylePrompt = "Say this in a sad tone: "; break;
              case 'Excited': stylePrompt = "Say this with great excitement: "; break;
              case 'Whisper': stylePrompt = "Whisper this softly: "; break;
              case 'Deep': stylePrompt = "Say this with a deep, authoritative voice: "; break;
              case 'Fast': stylePrompt = "Speaking quickly like a disclaimer: "; break;
              case 'Slow': stylePrompt = "Speaking slowly and dramatically: "; break;
              case 'News Anchor': stylePrompt = "Read this like a professional news anchor: "; break;
              case 'Storyteller': stylePrompt = "Read this like a fairytale storyteller: "; break;
              default: stylePrompt = `Say in a ${voiceStyle} tone: `;
          }
          
          textToSpeak = stylePrompt + voiceText;
          voiceConfigPayload = {
              speechConfig: {
                  voiceConfig: {
                      prebuiltVoiceConfig: { voiceName: selectedVoice }
                  }
              }
          };
      } else {
          // Dialogue Mode
          // Ensure names match specific speakers A and B for clarity
          // The model expects "Speaker: text". We use standardized names in config.
          voiceConfigPayload = {
             multiSpeakerVoiceConfig: {
                 speakerVoiceConfigs: [
                     { speaker: "Speaker A", voiceConfig: { prebuiltVoiceConfig: { voiceName: selectedVoice } } },
                     { speaker: "Speaker B", voiceConfig: { prebuiltVoiceConfig: { voiceName: voice2 } } }
                 ]
             }
          };
      }
      
      const wavBlob = await callGeminiTTS(textToSpeak, voiceConfigPayload);
      const url = URL.createObjectURL(wavBlob);
      setAudioUrl(url);
    } catch (e) { setError("Gagal membuat suara: " + e.message); } finally { setIsAudioGenerating(false); }
  };

  // 8. NEW: Scan Text (OCR) Handler
  const handleScanText = async () => {
    if (!uploadedImages.scanText) return setError("Upload gambar yang berisi teks dulu.");
    setIsScanTextLoading(true); setScanTextResult(''); setError(null);
    try {
        const text = await callGeminiLLM(
            "Anda adalah mesin OCR canggih. Tugas Anda adalah mengekstrak teks dari gambar dengan akurasi 100%. Abaikan elemen visual, fokus hanya pada teks. Jika ada tabel, formatlah dengan rapi. Jika tulisan tangan, usahakan semaksimal mungkin.",
            "Transkripsikan seluruh teks yang terlihat dalam gambar ini persis seperti aslinya.",
            uploadedImages.scanText.preview
        );
        setScanTextResult(text);
    } catch (e) { setError(e.message); } finally { setIsScanTextLoading(false); }
  };

  // 9. Image Generation
  const callGeminiImageAPI = async (parts) => {
    const MAX_RETRIES = 3;
    let lastError = null;
    for (let attempt = 0; attempt < MAX_RETRIES; attempt++) {
      try {
        const response = await fetch(
          `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`,
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: [{ parts: parts }], generationConfig: { responseModalities: ['IMAGE'] } }),
          }
        );
        if (!response.ok) throw new Error(`API Error: ${response.status}`);
        const result = await response.json();
        const base64Data = result.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
        if (!base64Data) throw new Error("No image data");
        return base64Data;
      } catch (err) {
        lastError = err;
        if (attempt < MAX_RETRIES - 1) await new Promise(resolve => setTimeout(resolve, 1000 * Math.pow(2, attempt)));
      }
    }
    throw lastError;
  };

  const handleGenerate = async () => {
    let imagesToSend = [];
    let finalPrompt = prompt;

    // HIGH QUALITY BOOSTER
    const qualityBooster = isHighQuality ? QUALITY_KEYWORDS : "";
    const universalNegative = isHighQuality ? `Negative prompt: ${NEGATIVE_PROMPT_UNIVERSAL}, ` : "";
    
    // ... (Existing logic for prompt construction based on activeTab) ...
    if (activeTab === 'product') {
        imagesToSend = uploadedImages.product;
        
        if (productTab === 'standard') {
             // Prompt Engineering for Product (STANDARD)
            const bgPrompt = productBg === 'Kustom' ? '' : `Background: ${productBg}.`;
            const lightPrompt = `Lighting: ${productLight}.`;
            const placePrompt = `Product Placement: ${productPlacement}.`;
            const quality = "Professional Commercial Product Photography, 8k resolution, sharp focus, high detail, commercial advertisement quality, cinematic lighting, depth of field.";
            const userText = prompt ? `User Detail: ${prompt}` : "";

            finalPrompt = `Product Photography of the uploaded item. ${bgPrompt} ${placePrompt} ${lightPrompt} Aspect Ratio: ${productRatio}. ${quality} ${userText} ${qualityBooster} ${universalNegative}`;
        } else {
             // Prompt Engineering for Product (ENDORSE ARTIS)
             if (endorseCategory === 'indo') {
                 if (!uploadedImages.productArtist) return setError("Upload foto artis terlebih dahulu.");
                 imagesToSend = [uploadedImages.product[0], uploadedImages.productArtist];
                 
                 const bgPrompt = `Background: ${productBg}.`;
                 const userText = prompt ? `User Detail: ${prompt}` : "";

                 finalPrompt = `Realistic commercial photography of the person in Input Image 2 holding and presenting the Product in Input Image 1. 
                 The product must be clearly visible in their hands. 
                 ${bgPrompt} 
                 Professional lighting, 8k resolution, highly detailed face, authentic expression. Match the identity of Input Image 2.
                 ${userText} ${qualityBooster} ${universalNegative}`;

             } else {
                 // Hollywood logic (Text based)
                 const celebrity = endorseArtist;
                 const bgPrompt = `Background: ${productBg}.`;
                 const userText = prompt ? `User Detail: ${prompt}` : "";
                 
                 finalPrompt = `Realistic commercial photography of celebrity ${celebrity} holding and presenting the Product in Input Image 1. 
                 The product must be clearly visible in their hands. 
                 ${bgPrompt} 
                 Professional lighting, 8k resolution, highly detailed face of ${celebrity}, authentic expression. 
                 ${userText} ${qualityBooster} ${universalNegative}`;
             }
        }

    } else if (activeTab === 'fashion') { // NEW: FASHION AI LOGIC
        if (!uploadedImages.fashionGarment || !uploadedImages.fashionModel) return setError("Upload kedua foto: Baju dan Model.");
        imagesToSend = [uploadedImages.fashionGarment, uploadedImages.fashionModel];
        
        const typeInfo = `Target Clothing Category: ${fashionType}.`;
        const shotInfo = `Framing/Shot Type: ${fashionShotType}.`; // NEW: Include Shot Type in Prompt
        
        // --- NEW: Background Instruction ---
        const bgInstruction = fashionBg === 'Asli (Original)' 
            ? "Keep the model's face, identity, hair, skin tone, and background from Image 2 UNCHANGED. Do NOT modify the background." 
            : `Keep the model's face, identity, hair, skin tone UNCHANGED. Change the background to: ${fashionBg}. Ensure realistic blending with the new background.`;

        const userInst = prompt ? `Additional Details: ${prompt}` : "";

        // REVISED STRONG PROMPT FOR VIRTUAL TRY-ON
        finalPrompt = `STRICT VIRTUAL TRY-ON TASK.
        Input Image 1: The Reference Garment (Texture Source).
        Input Image 2: The Target Model (Body Source).
        
        PRIMARY OBJECTIVE: Dress the Model from Image 2 wearing EXACTLY the Garment from Image 1. ${shotInfo}
        
        CRITICAL RULES:
        1. TEXTURE COPY: You MUST transfer the exact pattern, logo, fabric, and color from the Garment (Image 1) onto the Model. DO NOT GENERATE NEW CLOTHES.
        2. ANATOMY FIT: Warp the garment to fit the model's pose and body shape naturally. Handle folds and shadows realistically based on the model's lighting.
        3. PRESERVATION: ${bgInstruction} Only change the specific clothing item: ${fashionType}.
        
        ${typeInfo} ${userInst}
        
        OUTPUT QUALITY: Award-winning fashion photography, 8k resolution, highly detailed fabric texture, realistic draping.
        ${qualityBooster}
        Negative prompt: changing clothes design, different pattern, wrong color, cartoon, illustration, low quality, bad warping, distorted body, ${NEGATIVE_PROMPT_UNIVERSAL}`;
        
    } else if (activeTab === 'restore') {
      imagesToSend = uploadedImages.restore;
      finalPrompt = `Restore this old photo. Fix blur, sharpen details, colorize if B&W, remove scratches, remove noise. Make it look like a modern high-resolution photo. High definition, 8k. ${qualityBooster} ${universalNegative}`;

    } else if (activeTab === 'enhancer') { // UPDATED LOGIC FOR ENHANCER
      if (!uploadedImages.enhancer.length) return setError("Upload foto yang ingin diperjelas.");
      imagesToSend = uploadedImages.enhancer;
      const userInst = prompt ? `User Detail: ${prompt}` : "";

      // Logic for new filters and features
      let blurInst = enhancerBlurBg ? "Apply bokeh effect, blur background to create shallow depth of field." : "";
      let bgEnhanceInst = enhancerBgEnhance ? "Sharpen and denoise background details, high clarity background." : "";
      let faceEnhanceInst = enhancerFaceEnhance ? "High fidelity facial restoration, sharpen eyes, smooth skin texture, enhance facial features." : "";
      
      let filterInst = "";
      switch (enhancerColorFilter) {
          case 'Whiten': filterInst = "Whiten teeth and eyes, cool tone balance, reduce yellowness."; break;
          case 'Brighten': filterInst = "Overall image brightness increase, vivid colors, lift shadows."; break;
          case 'Smooth': filterInst = "Soft skin texture, reduce noise, smooth gradients, beauty filter."; break;
          case 'Skin Bright': filterInst = "Radiant skin tone, glow effect on face, healthy skin look."; break;
          case 'Face Tune': filterInst = "Beautify face, symmetric features, aesthetic retouching, magazine quality."; break;
          case 'Exposure': filterInst = "Perfect exposure balance, correct under/overexposure, dynamic range optimization."; break;
          case 'Highlights': filterInst = "Enhance highlights, glowy light effects, cinematic shimmer."; break;
          default: filterInst = "";
      }
      
      finalPrompt = `Upscale this image to high resolution (4K/8K). 
      Sharpen details, denoise, improve texture quality, correct lighting artifacts. 
      ${blurInst}
      ${bgEnhanceInst}
      ${faceEnhanceInst}
      ${filterInst}
      Ensure the image looks photorealistic and crystal clear when zoomed in. 
      Do not alter the composition or identity, only enhance image quality significantly.
      ${userInst} ${qualityBooster} ${universalNegative}`;

    } else if (activeTab === 'change_bg') { // NEW LOGIC FOR CHANGE BACKGROUND
        if (!uploadedImages.changeBg) return setError("Upload foto utama dulu.");
        
        const userInst = prompt ? `User Instruction: ${prompt}` : "";

        if (changeBgMode === 'upload') {
            if (!uploadedImages.changeBgReference) return setError("Upload foto background referensi dulu.");
            imagesToSend = [uploadedImages.changeBg, uploadedImages.changeBgReference];
            
            finalPrompt = `Change Background Task.
            Input Image 1: Main Subject.
            Input Image 2: New Background Reference.
            Task: Replace the background of Image 1 with the scene/texture/style of Image 2.
            Constraints: Keep the subject in Image 1 EXACTLY as is.
            Blend the subject seamlessly into the new background context (Image 2).
            ${userInst}
            High quality, 8k resolution, photorealistic. ${qualityBooster} ${universalNegative}`;
        } else {
            imagesToSend = [uploadedImages.changeBg];
            finalPrompt = `Change Background Task. 
            Input Image: User uploaded photo.
            Task: Replace the background with: '${changeBgStyle}'.
            Constraints: Keep the person/subject in the foreground EXACTLY as is. Do not alter the subject's face or body.
            Ensure realistic lighting match between the subject and the new background.
            Category: ${changeBgCategory}.
            ${userInst}
            High quality, 8k resolution, photorealistic blending. ${qualityBooster} ${universalNegative}`;
        }

    } else if (activeTab === 'coloring') { // NEW LOGIC FOR COLORING
      // Pastikan hanya menggunakan gambar jika mode upload aktif
      if (coloringMode === 'upload') {
          imagesToSend = uploadedImages.coloring;
      } else {
          imagesToSend = []; // Mode teks, abaikan gambar
      }
      
      const complexity = coloringComplexity === 'Anak-anak' ? "simple, thick lines, large areas to color, easy difficulty, cartoon style" : "intricate details, thin lines, mandala style pattern, high complexity, zentangle style";
      const baseStyle = "black and white coloring book page, clean line art, vector style outlines, white background, no shading, no grayscale, high contrast";
      
      if (imagesToSend.length > 0) {
        // Image to Image Coloring
        finalPrompt = `Convert this image into a ${baseStyle}. ${complexity}. Keep the main subject recognizable but convert it to line art. Remove background if it is messy. ${prompt}`;
      } else {
        // Text to Image Coloring
        if (!prompt.trim()) return setError("Masukkan deskripsi gambar yang ingin dibuat.");
        finalPrompt = `Create a ${baseStyle}. Subject: ${prompt}. Style: ${complexity}. Ensure lines are closed and suitable for coloring. High quality, crisp lines.`;
      }

    } else if (activeTab === 'prompt') {
      imagesToSend = uploadedImages.prompt;
      // Professional Prompt Engineering Construction
      let styleText = promptStyle !== 'None' ? `Style: ${promptStyle}.` : '';
      let negText = negativePrompt.trim() ? ` Avoid/Negative Prompt: ${negativePrompt}.` : '';
      let ratioText = `Aspect Ratio: ${promptAspectRatio}.`;
      let refText = imagesToSend.length ? 'Use the attached images as visual references.' : '';
      
      finalPrompt = `${prompt}. ${styleText} ${ratioText} ${negText} ${refText} ${qualityBooster}`;

    } else if (activeTab === 'banner') {
      imagesToSend = uploadedImages.banner;
      finalPrompt = `Banner iklan landscape. Teks: "${bannerText || 'Promo'}". Gaya: ${bannerStyle}. High quality graphic design, commercial grade. ${qualityBooster}`;
    } else if (activeTab === 'prewed') {
      imagesToSend = [uploadedImages.prewedFemale, uploadedImages.prewedMale];
      finalPrompt = `Romantic Pre-wedding photography. Couple portrait. ${prompt}. High quality, cinematic lighting, emotional connection. ${qualityBooster} ${universalNegative}`;
    } else if (activeTab === 'faceswap') {
      if (!uploadedImages.faceswapSource || !uploadedImages.faceswapTarget) return setError("Upload kedua foto.");
      imagesToSend = [uploadedImages.faceswapSource, uploadedImages.faceswapTarget];
      
      // -- Professional Face Swap Logic --
      let modeInst = swapMode === 'Realistic' ? 'Photorealistic, seamless blending.' : swapMode === 'Artistic' ? 'Artistic style, creative blending.' : 'Funny caricature style.';
      let enhanceInst = enableFaceEnhance ? 'High fidelity facial details, sharp focus, 8k resolution, preserve skin texture.' : '';
      let toneInst = matchSkinTone ? 'Strictly match skin tone, color grading and lighting conditions of the Base image.' : '';
      
      finalPrompt = `STRICT FACE SWAP. Base: Image 1. Face Source: Image 2. Swap the face from Img 2 to Img 1. ${modeInst} ${enhanceInst} ${toneInst} Preserve background context. Ensure seamless neck blending. ${qualityBooster} ${universalNegative}`;

    } else if (activeTab === 'mixer') {
        imagesToSend = uploadedImages.mixer;
        finalPrompt = `Creative Image Mixer. Blend these images into a cohesive composition. ${prompt} ${qualityBooster} ${universalNegative}`;
    } else if (activeTab === 'photo_merge') { // NEW LOGIC FOR FAMILY PHOTO
        imagesToSend = uploadedImages.photoMerge;
        if (imagesToSend.length < 2) return setError("Upload minimal 2 foto.");
        
        // Family Photo Professional Prompts
        const modePrompt = mergeMode === 'Seamless' 
            ? "Create a single realistic group photo where all subjects stand together naturally in the same scene. Harmonize scale and perspective. Ensure eye contact with camera." 
            : "Create a stylish collage grid layout separating the images cleanly.";
        
        const themePrompt = `Background setting: ${mergeTheme}.`;
        const outfitPrompt = mergeOutfit !== 'Asli' ? `All subjects must wear matching ${mergeOutfit}.` : "Keep original clothing styles but harmonize lighting.";
        const userInst = prompt ? `User Instruction: ${prompt}` : "";

        finalPrompt = `FAMILY PHOTO COMPOSITION. ${modePrompt} ${themePrompt} ${outfitPrompt} Aspect Ratio: ${mergeRatio}. ${userInst}. Ensure realistic lighting, correct proportions, and seamless blending of subjects from different source photos into one environment. High quality, 8k resolution. ${qualityBooster} ${universalNegative}`;

    } else if (activeTab === 'artist_photo') { // NEW: FOTO BARENG ARTIS
        if (!uploadedImages.artistPhoto) return setError("Upload foto Anda dulu.");
        
        let artistReference = "";
        
        // Logic toggle: Nama vs Foto
        if (artistMode === 'name') {
             if (!selectedArtist.trim()) return setError("Masukkan nama artis."); 
             imagesToSend = [uploadedImages.artistPhoto];
             // Hapus 'Indonesian' agar fleksibel
             artistReference = `celebrity ${selectedArtist}. Ensure accurate likeness (${selectedArtist})`;
        } else {
             if (!uploadedImages.artistTarget) return setError("Upload foto artis.");
             imagesToSend = [uploadedImages.artistPhoto, uploadedImages.artistTarget];
             artistReference = `the person in Input Image 2 (Celebrity). Match the face and style of Input Image 2`;
        }
        
        const userPrompt = prompt ? `Action/Pose Details: ${prompt}` : "Smiling and posing together.";
        
        finalPrompt = `Realistic Fan Photo with Celebrity. Input Image 1 is the fan. 
        Generate a photo of the person in Input Image 1 standing next to ${artistReference}. 
        They are ${userPrompt}. 
        Seamless composition, consistent lighting between subjects, high quality, photorealistic, 8k resolution, natural skin texture. 
        ${qualityBooster} ${universalNegative}`;

    } else if (activeTab === 'art_caricature') { // NEW: ART & KARIKATUR
        if (!uploadedImages.artCaricature) return setError("Upload foto referensi dulu.");
        imagesToSend = [uploadedImages.artCaricature];
        
        const selectedStyle = artStyle === 'Kustom' ? artCustomStyle : artStyle;
        const userInst = prompt ? `Additional Details: ${prompt}` : "";
        
        if (artType === 'painting') {
            finalPrompt = `Transform this image into a ${selectedStyle} painting masterpiece. 
            Maintain the main subject's identity and composition but apply the ${selectedStyle} artistic style strongly. 
            High quality art, detailed textures, visible brush strokes (if applicable). ${userInst} ${qualityBooster}`;
        } else {
            // Logic khusus untuk style Kepala Besar & Chibi
            let specificInstruction = "";
            if (selectedStyle === 'Kepala Besar (Tiny Body)') {
                specificInstruction = "SPECIAL PROPORTIONS: Extremely large head (bobblehead style), very small body, tiny hands and feet. Full body shot. Cute and funny exaggerated proportions.";
            } else if (selectedStyle.includes('Chibi')) {
                specificInstruction = "CHIBI STYLE PROPORTIONS: Super Deformed (SD) anime style. Large head (1:2 or 1:3 ratio), very small cute body, big sparkling eyes. Kawaii aesthetic. Tiny hands and feet. Full body shot.";
            }

            finalPrompt = `Create a ${selectedStyle} of the person in this image. 
            ${specificInstruction}
            Exaggerate features slightly for comedic effect but keep it recognizable. 
            Style: ${selectedStyle}. Fun, expressive, high quality illustration. ${userInst} ${qualityBooster}`;
        }
        
    } else if (activeTab === 'photopass') {
      imagesToSend = uploadedImages.photopass;
      
      // Advanced Pas Foto Logic
      let outfitDesc = pasFotoOutfit === 'Kustom' ? 'Use custom outfit from second image.' : `Wear: ${pasFotoOutfit}.`;
      if (pasFotoOutfit === 'Kustom' && customOutfitImage) imagesToSend.push(customOutfitImage);
      
      const sizeData = PAS_FOTO_SIZES.find(s => s.id === pasFotoSize);
      const ratio = sizeData ? `Aspect Ratio: ${sizeData.ratio}` : 'Aspect Ratio: 3:4';
      
      // Retouching Instructions
      let retouchInst = "";
      if (pasFotoRetouch.smoothSkin) retouchInst += "Smooth skin texture, remove acne/blemishes naturally (retain pores). ";
      if (pasFotoRetouch.brightenEyes) retouchInst += "Brighten eyes, remove dark circles, look straight at camera. ";
      if (pasFotoRetouch.fixHair) retouchInst += "Neat and tidy hair styling. ";
      if (pasFotoRetouch.formalPosture) retouchInst += "Formal straight posture, symmetric shoulders. ";

      const genderPrompt = `Subject is ${pasFotoGender}.`;
      const bgPrompt = `Background Color: ${pasFotoBg}. Clean solid background.`;
      
      finalPrompt = `Professional ID Passport Photo. ${genderPrompt} ${outfitDesc} ${bgPrompt} ${ratio}. ${retouchInst} High quality, sharp focus, professional studio lighting, neutral expression. ${qualityBooster} ${universalNegative}`;
      
    } else if (activeTab === 'photographer') {
        if (photographerTab === 'maternity') {
            if (uploadedImages.photographerMain) imagesToSend.push(uploadedImages.photographerMain);
            if (uploadedImages.photographerPartner) imagesToSend.push(uploadedImages.photographerPartner);
            const instruction = prompt ? `Instruksi tambahan: ${prompt}` : '';
            const partnerText = uploadedImages.photographerPartner ? 'with partner/husband' : 'solo portrait';
            
            // Enhanced Maternity Prompt
            const lightingInfo = `Lighting: ${maternityLighting}.`;
            const shotInfo = `Shot Type: ${maternityShotType}.`;
            const propInfo = maternityProp !== 'Tanpa Properti' ? `Holding prop: ${maternityProp}.` : '';
            
            // Handle Manual Theme
            const finalTheme = maternityTheme === 'Manual' ? maternityThemeManual : maternityTheme;

            finalPrompt = `Professional Maternity Photography. Subject: Pregnant Woman ${partnerText}. Pose: ${maternityPose}. Outfit: ${maternityOutfit}. Theme: ${finalTheme}. ${lightingInfo} ${shotInfo} ${propInfo} Aspect Ratio: ${aspectRatio}. Quality: 8k, photorealistic, cinematic, emotional, elegant, aesthetic composition. ${instruction} ${qualityBooster} ${universalNegative}`;
        } else if (photographerTab === 'newborn') {
            if (uploadedImages.photographerBaby) imagesToSend.push(uploadedImages.photographerBaby);
            const instruction = prompt ? `Instruksi tambahan: ${prompt}` : '';
            const textInfo = (newbornName || newbornDate) ? `Include text prop/sign reading: '${newbornName}' ${newbornDate}.` : '';
            const deco = newbornDecorationMode === 'Otomatis' ? 'Automatic aesthetic decoration matching theme' : 'Manual/Minimal decoration';
            
            // Enhanced Newborn Prompt
            const poseInfo = `Baby Pose: ${newbornPose}.`;
            const outfitInfo = `Baby Outfit: ${newbornOutfit}.`;
            const propInfo = newbornAccessory !== 'Tidak Ada' ? `Prop: ${newbornAccessory}.` : '';
            
            // Handle Manual Theme
            const finalTheme = newbornTheme === 'Manual' ? newbornThemeManual : newbornTheme;

            finalPrompt = `Professional Newborn Baby Photography. Gender: ${newbornGender}. Theme: ${finalTheme}. ${poseInfo} ${outfitInfo} ${propInfo} Decoration: ${deco}. ${textInfo} Aspect Ratio: ${aspectRatio}. High quality, soft studio lighting, cute, cozy atmosphere, highly detailed fabric textures, shallow depth of field, 8k resolution. ${instruction} ${qualityBooster} ${universalNegative}`;
        }
    }

    if (!finalPrompt.trim() && imagesToSend.length === 0) return setError("Masukkan instruksi atau gambar.");
    setIsLoading(true); setError(null); setGeneratedImages([]);

    try {
      // Generate 10 images with UNIQUE prompts to ensure variety
      const promises = Array(10).fill().map((_, i) => {
          // Tambahkan variasi unik (random noise/seed) ke dalam prompt
          // Ini memaksa AI menggunakan seed berbeda untuk setiap gambar
          const uniquePrompt = `${finalPrompt} . Random Variation ${i + 1}-${Math.random().toString(36).substring(7)}`;
          
          const parts = [{ text: uniquePrompt }];
          imagesToSend.forEach(img => img && parts.push({ inlineData: { mimeType: img.file.type, data: img.preview.split(',')[1] } }));
          
          return callGeminiImageAPI(parts);
      });

      const results = await Promise.allSettled(promises);
      const successful = results.filter(r => r.status === 'fulfilled').map(r => `data:image/png;base64,${r.value}`);
      if (successful.length) setGeneratedImages(successful);
      else throw new Error("Gagal membuat gambar.");
    } catch (err) { setError(err.message || "Terjadi kesalahan."); } finally { setIsLoading(false); }
  };

  const downloadImage = (imgSrc) => {
    const link = document.createElement('a');
    link.href = imgSrc;
    link.download = `aisyah-ai-${Date.now()}.png`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  const copyToClipboard = (text) => {
    // Fallback for iframe environments where navigator.clipboard might be blocked
    const textArea = document.createElement("textarea");
    textArea.value = text;
    textArea.style.position = "fixed";
    textArea.style.left = "-9999px";
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    try {
      document.execCommand('copy');
    } catch (err) {
      console.error('Gagal menyalin teks', err);
    }
    document.body.removeChild(textArea);
  };

  const switchTab = (tab) => {
    setActiveTab(tab);
    setUploadedImages({ product: [], prewedFemale: null, prewedMale: null, faceswapSource: null, faceswapTarget: null, mixer: [], photoMerge: [], restore: [], enhancer: [], banner: [], prompt: [], coloring: [], scanText: null, changeBg: null, changeBgReference: null, photopass: [], photographerMain: null, photographerPartner: null, photographerBaby: null, writer: null, consultant: null, fashionGarment: null, fashionModel: null, artistPhoto: null, artistTarget: null, productArtist: null, artCaricature: null });
    setCustomOutfitImage(null); setGeneratedImages([]); setPrompt(''); setBannerText(''); setBannerStyle(''); setError(null); setWriterResult(''); setIdeaResult(''); setIdeaCitations([]); setConsultantResult(''); setAudioUrl(null); setVoiceText(''); setScanTextResult('');
    setNegativePrompt(''); setPromptStyle('None'); setPromptAspectRatio('1:1'); 
    setSwapMode('Realistic'); setEnableFaceEnhance(true); setMatchSkinTone(true); // Reset Pro params
    setMergeMode('Seamless'); setMergeTheme('Studio Polos'); setMergeOutfit('Asli'); // Reset Family Photo params
    setProductRatio('1:1'); setProductBg('Studio Putih'); setProductLight('Softbox Studio'); setProductPlacement('Meja Minimalis'); // Reset Product Photo params
    
    // Reset Fashion AI Params
    setFashionType('Atasan (Kaos/Kemeja)'); setFashionShotType('Full Body'); setFashionBg('Asli (Original)');
    
    // Reset Art & Caricature Params
    setArtType('painting'); setArtStyle('Cat Air'); setArtCustomStyle('');
    
    // Reset Voiceover Params
    setVoiceoverMode('single'); setVoiceTopic('');

    // Reset Change Bg Params
    setChangeBgCategory('Dewasa'); setChangeBgStyle('Studio Profesional'); setChangeBgMode('preset');
    
    // Reset Enhancer Params
    setEnhancerBlurBg(false); setEnhancerColorFilter('Normal'); setEnhancerBgEnhance(false); setEnhancerFaceEnhance(true);

    setArtistMode('name'); // Reset Artist Mode
    setProductTab('standard'); // Reset Product Tab

    setIsMobileMenuOpen(false);
    if (tab === 'photographer') setAspectRatio('9:16');
  };

  const getLoadingText = () => {
     if (activeTab === 'faceswap') return 'Menukar wajah...';
     if (activeTab === 'photopass') return 'Mencetak Pas Foto...';
     if (activeTab === 'photographer') return 'Mengambil Foto Studio...';
     if (activeTab === 'writer') return 'Menulis Copywriting...';
     if (activeTab === 'ideadev') return 'Mengembangkan Ide...';
     if (activeTab === 'consultant') return 'Membedah Foto...';
     if (activeTab === 'photo_merge') return 'Menggabungkan Foto Keluarga...';
     if (activeTab === 'product') return 'Mengambil Foto Produk Pro...';
     if (activeTab === 'coloring') return 'Menggambar Sketsa...';
     if (activeTab === 'fashion') return 'Memproses Virtual Try-On...';
     if (activeTab === 'artist_photo') return 'Mempersiapkan Foto Artis...';
     if (activeTab === 'art_caricature') return 'Melukis Karya Seni...';
     if (activeTab === 'change_bg') return 'Mengganti Background...';
     if (activeTab === 'enhancer') return 'Memperjelas & Meningkatkan Foto...'; // NEW
     return 'Memproses AI...';
  };

  // UI Helper Components
  const UploadArea = ({ label, currentImage, onFileUpload, onRemoveImage, icon: Icon, multiple = false }) => (
    <div className="relative group cursor-pointer">
      <input type="file" onChange={onFileUpload} multiple={multiple} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" accept="image/*" />
      {currentImage ? (
        <div className="relative h-32 w-full rounded-xl overflow-hidden border-2 border-slate-300 dark:border-slate-600 bg-slate-100 dark:bg-slate-900">
          <img src={currentImage.preview} alt="preview" className="w-full h-full object-contain" />
          <button onClick={(e) => { e.stopPropagation(); onRemoveImage(); }} className="absolute top-1 right-1 bg-red-500 text-white p-1 rounded-full z-20"><X size={16} /></button>
        </div>
      ) : (
        <div className="border-2 border-dashed border-blue-300 dark:border-slate-600 rounded-xl p-4 flex flex-col items-center justify-center bg-blue-50/50 dark:bg-slate-900/50 h-32 hover:bg-blue-100/50 dark:hover:bg-slate-800/50 transition-colors">
          <Icon size={24} className="text-slate-500 mb-2"/>
          <p className="text-xs text-center text-slate-500 font-medium">{label}</p>
        </div>
      )}
    </div>
  );

  // --- RENDER FUNCTION for Photo Pass Controls (Avoids component remount issues) ---
  const renderPhotoPassControls = () => (
    <div className="space-y-6 animate-in fade-in slide-in-from-top-2">
      {/* 1. SIZE & GENDER SECTION */}
      <div className="grid grid-cols-2 gap-4">
        <div>
           <label className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-2 flex items-center gap-1"><Scissors size={14}/> Ukuran Cetak</label>
           <div className="grid grid-cols-2 gap-2">
             {PAS_FOTO_SIZES.map(s => (
               <button 
                key={s.id} 
                onClick={() => setPasFotoSize(s.id)} 
                className={`py-2 px-1 text-xs rounded-lg border transition-all ${pasFotoSize === s.id ? 'bg-indigo-100 border-indigo-500 text-indigo-700 font-bold' : 'bg-slate-50 border-slate-200 text-slate-600 hover:bg-slate-100 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-300'}`}
               >
                 {s.id === 'visa' ? 'Visa' : s.id}
               </button>
             ))}
           </div>
        </div>
        <div>
           <label className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-2 flex items-center gap-1"><UserCheck size={14}/> Gender</label>
           <div className="flex gap-2 h-[88px] items-start">
             {['Pria', 'Wanita'].map(g => (
                <button 
                  key={g} 
                  onClick={() => { setPasFotoGender(g); setPasFotoOutfit(g === 'Pria' ? PAS_FOTO_OUTFITS_MALE[0] : PAS_FOTO_OUTFITS_FEMALE[0]); }}
                  className={`flex-1 h-[42px] rounded-lg text-xs font-medium border transition-all ${pasFotoGender === g ? 'bg-indigo-100 border-indigo-500 text-indigo-700' : 'bg-slate-50 border-slate-200 text-slate-600'}`}
                >
                  {g}
                </button>
             ))}
           </div>
        </div>
      </div>

      {/* 2. BACKGROUND SECTION */}
      <div>
        <label className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-2 flex items-center gap-1"><Palette size={14}/> Warna Latar</label>
        <div className="grid grid-cols-2 gap-2">
          {PAS_FOTO_BACKGROUNDS.map(bg => ( 
             <button 
               key={bg.id} 
               onClick={() => setPasFotoBg(bg.id)} 
               className={`flex items-center gap-2 p-2 rounded-lg border transition-all text-left ${pasFotoBg === bg.id ? 'ring-2 ring-offset-1 ring-indigo-500 border-transparent' : 'border-slate-200 dark:border-slate-600 hover:bg-slate-50'}`}
             >
               <div className="w-6 h-6 rounded-full border border-black/10 shadow-sm" style={{ backgroundColor: bg.color }}></div>
               <span className="text-[10px] font-medium text-slate-700 dark:text-slate-300 leading-tight">{bg.label}</span>
             </button> 
          ))}
        </div>
      </div>

      {/* 3. OUTFIT SECTION (DYNAMIC) */}
      <div>
        <label className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-2 flex items-center gap-1"><Shirt size={14}/> Pakaian Formal</label>
        <div className="flex flex-wrap gap-2">
          {(pasFotoGender === 'Pria' ? PAS_FOTO_OUTFITS_MALE : PAS_FOTO_OUTFITS_FEMALE).map(o => ( 
            <button 
              key={o} 
              onClick={() => { setPasFotoOutfit(o); if (o !== 'Kustom') setCustomOutfitImage(null); }} 
              className={`px-3 py-1.5 text-xs rounded-full border transition-all ${pasFotoOutfit === o ? 'bg-indigo-600 text-white border-indigo-600 shadow-md' : 'bg-slate-50 border-slate-200 text-slate-600 hover:bg-slate-100 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-300'}`}
            >
              {o}
            </button> 
          ))}
        </div>
        {pasFotoOutfit === 'Kustom' && (
          <div className="mt-3 bg-yellow-50 dark:bg-yellow-900/20 p-3 rounded-xl border border-yellow-200 dark:border-yellow-700">
             <p className="text-xs font-bold text-yellow-800 dark:text-yellow-200 mb-2">Upload Referensi Pakaian:</p>
             <UploadArea label="Foto Pakaian" currentImage={customOutfitImage} onFileUpload={(e) => handlePhotopassUpload(e, 'outfit')} onRemoveImage={() => removeImage(null, 'customOutfit')} icon={Shirt} />
          </div>
        )}
      </div>

      {/* 4. AI RETOUCHING */}
      <div className="bg-slate-50 dark:bg-slate-700/50 p-3 rounded-xl border border-slate-200 dark:border-slate-600">
         <label className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-2 flex items-center gap-1"><Sparkles size={14}/> AI Studio Retouch</label>
         <div className="grid grid-cols-2 gap-y-2 gap-x-4">
             {Object.entries({
               smoothSkin: 'Haluskan Kulit',
               brightenEyes: 'Cerahkan Mata',
               fixHair: 'Rapikan Rambut',
               formalPosture: 'Postur Tegap'
             }).map(([key, label]) => (
                <button 
                  key={key}
                  onClick={() => setPasFotoRetouch(prev => ({...prev, [key]: !prev[key]}))}
                  className="flex items-center gap-2 text-xs text-slate-700 dark:text-slate-300"
                >
                   <div className={`w-4 h-4 rounded border flex items-center justify-center transition-colors ${pasFotoRetouch[key] ? 'bg-indigo-500 border-indigo-500 text-white' : 'bg-white border-slate-300'}`}>
                      {pasFotoRetouch[key] && <CheckCircle2 size={10} />}
                   </div>
                   {label}
                </button>
             ))}
         </div>
      </div>
      
      {/* 5. PRINT LAYOUT HINT */}
      <div className="flex items-center gap-2 text-[10px] text-slate-400 dark:text-slate-500 bg-slate-100 dark:bg-slate-800 p-2 rounded-lg">
          <Printer size={12} />
          <span>Hasil akhir siap cetak di kertas foto (Glossy/Matte).</span>
      </div>

    </div>
  );

  // --- RENDERING LOGIN OR APP ---
  if (!isAuthenticated) {
    return (
      <div className={`min-h-screen flex items-center justify-center bg-slate-950 text-white relative overflow-hidden font-sans`}>
         {/* Background Decoration */}
         <div className="absolute top-0 left-0 w-full h-full overflow-hidden z-0">
            <div className="absolute top-[-10%] right-[-5%] w-96 h-96 bg-purple-600/30 rounded-full blur-3xl animate-pulse"></div>
            <div className="absolute bottom-[-10%] left-[-5%] w-96 h-96 bg-indigo-600/30 rounded-full blur-3xl animate-pulse delay-700"></div>
            <div className="absolute top-[40%] left-[30%] w-64 h-64 bg-pink-500/20 rounded-full blur-3xl animate-pulse delay-1000"></div>
         </div>

         <div className="w-full max-w-md p-8 bg-slate-900/60 backdrop-blur-2xl border border-slate-700 rounded-2xl shadow-2xl relative z-10 animate-in fade-in zoom-in duration-500 mx-4">
            <div className="flex flex-col items-center mb-8">
               <div className="relative mb-6 group">
                   <div className="absolute -inset-1 bg-gradient-to-r from-pink-600 to-purple-600 rounded-full blur opacity-75 group-hover:opacity-100 transition duration-1000 group-hover:duration-200"></div>
                   <div className="relative bg-slate-900 rounded-full p-2">
                        <ReminiStyleIcon size={64} />
                   </div>
               </div>
               <h1 className="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 via-purple-400 to-pink-400 tracking-tight">Aisyah AI Pro</h1>
               <p className="text-slate-400 text-sm mt-2 text-center">Masuk untuk mengakses studio kreatif Anda.</p>
            </div>

            <form onSubmit={handleLogin} className="space-y-5">
                <div className="space-y-1">
                    <label className="text-xs font-bold uppercase text-slate-500 tracking-wider ml-1">Username</label>
                    <div className="relative">
                        <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-500">
                            <User size={18} />
                        </div>
                        <input 
                            type="text" 
                            value={loginCreds.username} 
                            onChange={(e) => setLoginCreds({...loginCreds, username: e.target.value})}
                            placeholder="Masukkan username"
                            className="w-full pl-10 pr-4 py-3 bg-slate-800/50 border border-slate-700 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-slate-200 placeholder-slate-500 transition-all outline-none"
                        />
                    </div>
                </div>

                <div className="space-y-1">
                    <label className="text-xs font-bold uppercase text-slate-500 tracking-wider ml-1">Password</label>
                    <div className="relative">
                        <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-500">
                            <Lock size={18} />
                        </div>
                        <input 
                            type="password" 
                            value={loginCreds.password} 
                            onChange={(e) => setLoginCreds({...loginCreds, password: e.target.value})}
                            placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                            className="w-full pl-10 pr-4 py-3 bg-slate-800/50 border border-slate-700 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-slate-200 placeholder-slate-500 transition-all outline-none"
                        />
                    </div>
                </div>

                {loginError && (
                    <div className="p-3 bg-red-900/30 border border-red-800 rounded-xl text-red-300 text-sm text-center animate-in fade-in slide-in-from-top-1">
                        {loginError}
                    </div>
                )}

                <button 
                    type="submit"
                    className="w-full py-3.5 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text-white font-bold rounded-xl shadow-lg shadow-indigo-500/30 transition-all transform hover:scale-[1.02] active:scale-[0.98] flex items-center justify-center gap-2"
                >
                    <ShieldCheck size={20} />
                    Masuk Sekarang
                </button>
            </form>
         </div>
      </div>
    );
  }

  // --- MAIN APP ---
  return (
    <div className={`${theme} h-screen font-sans flex justify-center bg-gray-200 dark:bg-black overflow-hidden`}>
      {/* SIDEBAR NAVIGATION (Mobile Drawer Style Only) */}
      {/* Mobile Backdrop */}
      {isMobileMenuOpen && (
        <div 
          className="fixed inset-0 bg-black/50 z-50 backdrop-blur-sm transition-opacity"
          onClick={() => setIsMobileMenuOpen(false)}
        />
      )}
      
      <aside className={`
        fixed inset-y-0 left-0 z-[60] w-72 bg-slate-950 text-white transform transition-transform duration-300 ease-in-out shadow-2xl flex flex-col
        ${isMobileMenuOpen ? 'translate-x-0' : '-translate-x-full'}
      `}>
        <div className="p-6 border-b border-slate-800 bg-slate-950 sticky top-0 z-10">
          <div className="flex items-center gap-3">
            <ReminiStyleIcon size={48} />
            <div>
              <h1 className="font-bold text-lg leading-tight tracking-tight text-slate-100">
                Percetakan<br />
                <span className="text-transparent bg-clip-text bg-gradient-to-r from-pink-400 to-purple-400">Aisyah AI Pro</span>
              </h1>
            </div>
            <button onClick={() => setIsMobileMenuOpen(false)} className="ml-auto text-slate-400 hover:text-white"><X size={24} /></button>
          </div>
        </div>
        
        {/* NEW: CATEGORIZED NAVIGATION */}
        <nav className="flex-1 overflow-y-auto py-6 px-4 custom-scrollbar space-y-4">
          {NAV_CATEGORIES.map((category) => (
            <div key={category.id} className="mb-2">
              <button
                onClick={() => toggleCategory(category.id)}
                className="w-full flex items-center justify-between px-3 py-2 text-xs font-bold text-slate-500 uppercase tracking-wider hover:text-slate-300 transition-colors"
              >
                <div className="flex items-center gap-2">
                  <category.icon size={14} className="text-slate-500" />
                  {category.label}
                </div>
                {expandedCategories.includes(category.id) ? (
                  <ChevronDown size={14} />
                ) : (
                  <ChevronRight size={14} />
                )}
              </button>
              
              {expandedCategories.includes(category.id) && (
                <ul className="mt-1 space-y-1 animate-in fade-in slide-in-from-top-2 duration-300">
                  {category.items.map((item) => {
                    const isActive = activeTab === item.id;
                    return (
                      <li key={item.id}>
                        <button
                          onClick={() => switchTab(item.id)}
                          className={`
                            w-full flex items-center gap-3 px-4 py-3 rounded-xl text-left transition-all duration-200 group relative overflow-hidden
                            ${isActive ? 'text-white shadow-lg translate-x-1' : 'text-slate-400 hover:bg-slate-900 hover:text-slate-200'}
                          `}
                        >
                          {isActive && <div className={`absolute inset-0 opacity-100 ${item.color} transition-all duration-300`}></div>}
                          <item.icon size={18} className={`relative z-10 transition-transform duration-300 ${isActive ? 'scale-110' : 'group-hover:scale-110'}`} strokeWidth={isActive ? 2.5 : 2} />
                          <span className={`relative z-10 font-medium text-sm tracking-wide ${isActive ? 'font-semibold' : ''}`}>{item.label}</span>
                          {isActive && <div className="absolute right-4 w-1.5 h-1.5 bg-white rounded-full shadow-sm animate-pulse z-10"></div>}
                        </button>
                      </li>
                    );
                  })}
                </ul>
              )}
            </div>
          ))}
        </nav>

        <div className="p-4 border-t border-slate-800 bg-slate-950 space-y-3">
          
          {/* NEW: Settings Button */}
          <button onClick={handleOpenSettings} className="w-full flex items-center gap-3 px-4 py-3 rounded-xl bg-slate-900 hover:bg-slate-800 text-slate-400 hover:text-white border border-slate-800 transition-all">
             <Settings size={18} />
             <span className="text-sm font-medium">Pengaturan Akun</span>
          </button>

          <button onClick={handleLogout} className="w-full flex items-center gap-3 px-4 py-3 rounded-xl bg-red-900/20 hover:bg-red-900/40 text-red-400 hover:text-red-300 border border-red-900/30 transition-all">
             <LogOut size={18} />
             <span className="text-sm font-medium">Keluar / Logout</span>
          </button>
        </div>
      </aside>

      {/* NEW: Settings Modal */}
      {isSettingsOpen && (
        <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-in fade-in duration-200">
           <div className="bg-white dark:bg-slate-800 w-full max-w-md rounded-2xl p-6 shadow-2xl border border-slate-200 dark:border-slate-700 animate-in zoom-in-95 duration-200 max-h-[90vh] overflow-y-auto custom-scrollbar">
              <div className="flex items-center justify-between mb-6">
                 <h3 className="text-xl font-bold text-slate-800 dark:text-white flex items-center gap-2">
                    <Settings className="text-indigo-500" /> Pengaturan Akun
                 </h3>
                 <button onClick={() => setIsSettingsOpen(false)} className="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200">
                    <X size={24} />
                 </button>
              </div>

              {/* SECTION: TAMPILAN (Moved from Sidebar) */}
              <div className="mb-6 space-y-3">
                  <h4 className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-2">Preferensi Tampilan</h4>
                  
                  {/* View Mode Toggle */}
                  <div className="flex items-center justify-between p-3 rounded-xl bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700">
                     <div className="flex items-center gap-3">
                         {viewMode === 'mobile' ? <Smartphone size={20} className="text-blue-500"/> : <Monitor size={20} className="text-purple-500"/>}
                         <span className="text-sm font-medium text-slate-700 dark:text-slate-200">
                            {viewMode === 'mobile' ? 'Tampilan Mobile' : 'Tampilan Desktop'}
                         </span>
                     </div>
                     <button onClick={toggleViewMode} className={`w-12 h-6 rounded-full relative transition-colors ${viewMode === 'desktop' ? 'bg-indigo-600' : 'bg-slate-300'}`}>
                        <div className={`absolute top-1 w-4 h-4 bg-white rounded-full transition-all ${viewMode === 'desktop' ? 'left-7' : 'left-1'}`}></div>
                     </button>
                  </div>

                  {/* Theme Toggle */}
                  <div className="flex items-center justify-between p-3 rounded-xl bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700">
                     <div className="flex items-center gap-3">
                        {theme === 'light' ? <Sun size={20} className="text-orange-500"/> : <Moon size={20} className="text-indigo-400"/>}
                        <span className="text-sm font-medium text-slate-700 dark:text-slate-200">
                            {theme === 'light' ? 'Mode Terang' : 'Mode Gelap'}
                        </span>
                     </div>
                     <button onClick={toggleTheme} className={`w-12 h-6 rounded-full relative transition-colors ${theme === 'dark' ? 'bg-indigo-600' : 'bg-slate-300'}`}>
                        <div className={`absolute top-1 w-4 h-4 bg-white rounded-full transition-all ${theme === 'dark' ? 'left-7' : 'left-1'}`}></div>
                     </button>
                  </div>
              </div>

              <div className="border-t border-slate-200 dark:border-slate-700 my-4"></div>
              
              <form onSubmit={handleSaveSettings} className="space-y-4">
                 <h4 className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-2">Keamanan Akun</h4>
                 <div>
                    <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Username Baru</label>
                    <input 
                      type="text" 
                      value={tempCreds.username} 
                      onChange={(e) => setTempCreds({...tempCreds, username: e.target.value})}
                      className="w-full p-3 rounded-xl bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 text-slate-900 dark:text-white focus:ring-2 focus:ring-indigo-500 outline-none"
                      required
                    />
                 </div>
                 <div>
                    <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Password Baru</label>
                    <input 
                      type="text" 
                      value={tempCreds.password} 
                      onChange={(e) => setTempCreds({...tempCreds, password: e.target.value})}
                      className="w-full p-3 rounded-xl bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 text-slate-900 dark:text-white focus:ring-2 focus:ring-indigo-500 outline-none"
                      required
                    />
                 </div>
                 <div className="pt-4 flex gap-3">
                    <button type="button" onClick={() => setIsSettingsOpen(false)} className="flex-1 py-3 rounded-xl border border-slate-300 dark:border-slate-600 text-slate-600 dark:text-slate-300 font-medium hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">Batal</button>
                    <button type="submit" className="flex-1 py-3 rounded-xl bg-indigo-600 text-white font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-500/30 transition-colors">Simpan Perubahan</button>
                 </div>
              </form>
           </div>
        </div>
      )}

      {/* NEW: REVIEW MODAL (FULLSCREEN) */}
      {reviewData && (
        <div className="fixed inset-0 z-[70] flex items-center justify-center bg-black/90 p-4 animate-in fade-in duration-200 backdrop-blur-sm">
           <button 
              onClick={() => setReviewData(null)} 
              className="absolute top-4 right-4 text-white hover:text-gray-300 z-50 p-2 bg-black/50 rounded-full"
           >
              <X size={32}/>
           </button>
           
           <div className={`bg-white dark:bg-slate-900 rounded-2xl overflow-hidden shadow-2xl max-h-[90vh] max-w-[90vw] ${reviewData.type === 'text' ? 'w-full max-w-2xl' : ''} flex flex-col relative`}>
              {reviewData.title && (
                 <div className="p-4 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-950 shrink-0">
                    <h3 className="font-bold text-lg text-slate-800 dark:text-white truncate pr-4">{reviewData.title}</h3>
                    <div className="flex gap-2 shrink-0">
                       {reviewData.type === 'image' && (
                          <button onClick={() => downloadImage(reviewData.content)} className="flex items-center gap-2 px-3 py-1.5 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded-lg text-xs font-bold transition-colors">
                             <Download size={16}/> Unduh
                          </button>
                       )}
                       <button onClick={() => copyToClipboard(reviewData.type === 'image' ? reviewData.content : reviewData.content)} className="flex items-center gap-2 px-3 py-1.5 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg text-xs font-bold transition-colors">
                          <Copy size={16}/> Salin
                       </button>
                    </div>
                 </div>
              )}
              
              <div className="overflow-auto p-1 custom-scrollbar flex-1 flex items-center justify-center bg-slate-100 dark:bg-black/50">
                 {reviewData.type === 'image' ? (
                    <img src={reviewData.content} alt="Review" className="max-h-[80vh] w-auto object-contain shadow-lg" />
                 ) : (
                    <div className="p-6 prose dark:prose-invert max-w-none whitespace-pre-wrap leading-relaxed w-full h-full overflow-y-auto">
                       {reviewData.content}
                    </div>
                 )}
              </div>
           </div>
        </div>
      )}

      {/* MAIN CONTENT - RESPONSIVE CONTAINER */}
      <main className={`w-full h-full flex flex-col bg-slate-50 dark:bg-slate-900 shadow-2xl overflow-hidden relative border-x border-slate-200 dark:border-slate-800 transition-all duration-500 ease-in-out ${viewMode === 'mobile' ? 'max-w-lg' : 'max-w-full px-10'}`}>
        
        {/* MOBILE HEADER - ALWAYS VISIBLE */}
        <header className="flex items-center justify-between px-4 py-3 bg-white/90 dark:bg-slate-900/90 backdrop-blur-md border-b border-slate-200 dark:border-slate-800 shrink-0 sticky top-0 z-30">
          <div className="flex items-center gap-2">
            <ReminiStyleIcon size={32} />
            <span className="font-bold text-slate-800 dark:text-white text-sm">Aisyah AI Pro</span>
          </div>
          <button onClick={() => setIsMobileMenuOpen(true)} className="p-2 text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg"><Menu size={24} /></button>
        </header>

        <div className="flex-1 overflow-y-auto p-4 scroll-smooth bg-slate-50 dark:bg-slate-900 transition-colors duration-300 custom-scrollbar">
          
            <div className="mb-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
              <h2 className="text-2xl font-bold text-slate-800 dark:text-white flex items-center gap-3">
                {/* Updated to find icon from flattened list */}
                {ALL_NAV_ITEMS.find(n => n.id === activeTab)?.icon && React.createElement(ALL_NAV_ITEMS.find(n => n.id === activeTab).icon, { 
                  className: `text-${ALL_NAV_ITEMS.find(n => n.id === activeTab).color.replace('bg-', '').replace('-600', '-500')}` 
                })}
                {ALL_NAV_ITEMS.find(n => n.id === activeTab)?.label}
              </h2>
              <p className="text-slate-500 dark:text-slate-400 mt-1 ml-1 text-sm">
                 {activeTab === 'ideadev' ? 'Kembangkan, simpan, dan ringkas ide Anda.' : 'Platform Kreatif AI.'}
              </p>
            </div>

            {/* --- LAYOUT LOGIC SWITCHER (MOBILE SINGLE COLUMN VS DESKTOP GRID) --- */}
            {/* The rest of the content rendering logic remains unchanged */}
            {activeTab === 'ideadev' ? (
                // --- IDEA DEVELOPER LAYOUT ---
                <div className={`gap-6 animate-in fade-in duration-500 pb-20 ${viewMode === 'desktop' ? 'grid grid-cols-2 items-start' : 'flex flex-col'}`}>
                    <div className="space-y-6">
                         <div className="bg-white dark:bg-slate-800 rounded-2xl p-5 shadow-sm border border-slate-200 dark:border-slate-700">
                            <div className="flex justify-between items-center mb-4">
                                <h3 className="text-lg font-bold text-slate-700 dark:text-slate-200 flex items-center gap-2"><BrainCircuit size={20} className="text-yellow-500" /> Ruang Ide</h3>
                                <button onClick={handleSaveIdea} className="flex items-center gap-2 px-3 py-1.5 bg-green-100 hover:bg-green-200 text-green-700 rounded-lg text-xs font-semibold transition-colors dark:bg-green-900/30 dark:text-green-300"><Save size={14} /> Simpan</button>
                            </div>
                            <textarea value={ideaText} onChange={(e) => setIdeaText(e.target.value)} placeholder="Tuliskan ide..." className="w-full p-4 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-900 dark:text-white placeholder-slate-400 focus:ring-2 focus:ring-yellow-500 resize-none text-base leading-relaxed min-h-[150px]" />
                            <div className="mt-4 grid grid-cols-2 gap-3">
                                <button onClick={() => handleIdeaAction('expand')} disabled={isIdeaLoading} className="py-2.5 px-4 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold shadow-lg shadow-blue-500/30 flex items-center justify-center gap-2 transition-all disabled:opacity-50 text-sm">{isIdeaLoading ? <Loader2 className="animate-spin" size={16} /> : <Sparkles size={16} />} Kembangkan</button>
                                <button onClick={() => handleIdeaAction('summarize')} disabled={isIdeaLoading} className="py-2.5 px-4 bg-purple-600 hover:bg-purple-700 text-white rounded-xl font-bold shadow-lg shadow-purple-500/30 flex items-center justify-center gap-2 transition-all disabled:opacity-50 text-sm">{isIdeaLoading ? <Loader2 className="animate-spin" size={16} /> : <Layout size={16} />} Ringkas</button>
                            </div>
                         </div>
                    </div>
                    
                    {/* Result Card */}
                    <div className="bg-white dark:bg-slate-800 rounded-2xl p-5 shadow-sm border border-slate-200 dark:border-slate-700 min-h-[300px]">
                        <div className="flex justify-between items-center mb-4 border-b border-slate-100 dark:border-slate-700 pb-3">
                            <h3 className="text-lg font-bold text-slate-700 dark:text-slate-200 flex items-center gap-2"><Zap size={20} className="text-blue-500" /> Hasil</h3>
                            <div className="flex gap-2">
                               {ideaResult && (
                                  <button onClick={() => setReviewData({type: 'text', content: ideaResult, title: 'Review Ide'})} className="text-xs flex items-center gap-1 text-blue-500 hover:text-blue-700 bg-blue-50 hover:bg-blue-100 px-2 py-1 rounded-lg transition-colors font-medium">
                                     <Maximize size={14} /> Full
                                  </button>
                               )}
                               {ideaResult && (<button onClick={() => copyToClipboard(ideaResult)} className="text-xs flex items-center gap-1 text-slate-500 hover:text-slate-800 dark:text-slate-400 dark:hover:text-white"><Copy size={14} /> Salin</button>)}
                            </div>
                        </div>
                        <div className="custom-scrollbar">
                            {isIdeaLoading ? (
                                <div className="flex flex-col items-center justify-center py-10 text-slate-400 gap-3"><Loader2 size={32} className="animate-spin text-yellow-500" /><p className="text-sm animate-pulse">Sedang berpikir...</p></div>
                            ) : ideaResult ? (
                                <div className="space-y-6">
                                    <div className="prose dark:prose-invert max-w-none text-slate-700 dark:text-slate-300 whitespace-pre-wrap leading-relaxed text-sm">{ideaResult}</div>
                                    {ideaCitations.length > 0 && (<div className="mt-6 pt-4 border-t border-slate-200 dark:border-slate-700"><h4 className="text-xs font-bold text-slate-500 dark:text-slate-400 mb-2 flex items-center gap-2"><ExternalLink size={12} /> Referensi:</h4><div className="flex flex-wrap gap-2">{ideaCitations.map((source, idx) => (<a key={idx} href={source.uri} target="_blank" rel="noopener noreferrer" className="text-[10px] bg-slate-100 dark:bg-slate-700 text-blue-600 dark:text-blue-400 px-2 py-1 rounded-full hover:bg-blue-50 dark:hover:bg-slate-600 transition-colors truncate max-w-[150px]">{source.title}</a>))}</div></div>)}
                                </div>
                            ) : (<div className="flex flex-col items-center justify-center py-10 text-slate-400 opacity-60"><Lightbulb size={48} className="mb-4 text-slate-300 dark:text-slate-600" /><p className="text-center text-sm">Hasil analisis muncul di sini.</p></div>)}
                        </div>
                    </div>
                </div>
            ) : activeTab === 'scan_text' ? (
                // --- NEW: SCAN TEXT (OCR) LAYOUT ---
                <div className={`gap-6 animate-in fade-in duration-500 pb-20 ${viewMode === 'desktop' ? 'grid grid-cols-2 items-start' : 'flex flex-col'}`}>
                    <div className="space-y-6">
                        <div className="bg-white dark:bg-slate-800 rounded-2xl p-5 shadow-sm border border-slate-200 dark:border-slate-700">
                            <h3 className="text-lg font-bold text-slate-700 dark:text-slate-200 mb-4 flex items-center gap-2"><ImageIcon size={20} /> Upload Gambar</h3>
                            <UploadArea label="Foto Dokumen/Teks" currentImage={uploadedImages.scanText} onFileUpload={(e) => handleGeneralFileUpload(e, 'scan_text')} onRemoveImage={() => removeImage(null, 'scanText')} icon={ScanLine} />
                            <button onClick={handleScanText} disabled={isScanTextLoading || !uploadedImages.scanText} className="w-full mt-4 flex items-center justify-center gap-2 px-6 py-3 bg-emerald-600 hover:bg-emerald-700 text-white rounded-xl font-bold shadow-lg shadow-emerald-500/30 transition-all disabled:opacity-50 active:scale-95 text-sm">
                                {isScanTextLoading ? <Loader2 className="animate-spin" size={18} /> : <ScanLine size={18} />} Scan Teks Sekarang
                            </button>
                        </div>
                    </div>
                    
                    <div className="bg-white dark:bg-slate-800 rounded-2xl p-5 shadow-sm border border-slate-200 dark:border-slate-700 min-h-[300px]">
                        <div className="flex justify-between items-center mb-4 border-b border-slate-100 dark:border-slate-700 pb-3">
                            <h3 className="text-lg font-bold text-slate-700 dark:text-slate-200 flex items-center gap-2"><FileText size={20} className="text-emerald-500" /> Hasil Teks</h3>
                            <div className="flex gap-2">
                               {scanTextResult && (
                                  <button onClick={() => setReviewData({type: 'text', content: scanTextResult, title: 'Review Teks'})} className="text-xs flex items-center gap-1 text-emerald-500 hover:text-emerald-700 bg-emerald-50 hover:bg-emerald-100 px-2 py-1 rounded-lg transition-colors font-medium">
                                     <Maximize size={14} /> Full
                                  </button>
                               )}
                               {scanTextResult && (<button onClick={() => copyToClipboard(scanTextResult)} className="text-xs flex items-center gap-1 text-slate-500 hover:text-slate-800 dark:text-slate-400 dark:hover:text-white"><Copy size={14} /> Salin</button>)}
                            </div>
                        </div>
                        <div className="custom-scrollbar">
                            {isScanTextLoading ? (
                                <div className="flex flex-col items-center justify-center py-10 text-slate-400 gap-3"><Loader2 size={32} className="animate-spin text-emerald-500" /><p className="text-sm animate-pulse">Membaca teks...</p></div>
                            ) : scanTextResult ? (
                                <div className="prose dark:prose-invert max-w-none text-slate-700 dark:text-slate-300 whitespace-pre-wrap leading-relaxed text-sm font-mono bg-slate-50 dark:bg-slate-900 p-4 rounded-xl border border-slate-200 dark:border-slate-700">{scanTextResult}</div>
                            ) : (
                                <div className="flex flex-col items-center justify-center py-10 text-slate-400 opacity-60"><ScanLine size={48} className="mb-4 text-slate-300 dark:text-slate-600" /><p className="text-center text-sm">Hasil scan teks muncul di sini.</p></div>
                            )}
                        </div>
                    </div>
                </div>
            ) : activeTab === 'consultant' ? (
                // --- PHOTO CONSULTANT ---
                <div className={`gap-6 animate-in fade-in duration-500 pb-20 ${viewMode === 'desktop' ? 'grid grid-cols-2 items-start' : 'flex flex-col'}`}>
                    <div className="space-y-6">
                        <div className="bg-white dark:bg-slate-800 rounded-2xl p-5 shadow-sm border border-slate-200 dark:border-slate-700">
                            <h3 className="text-lg font-bold text-slate-700 dark:text-slate-200 mb-4 flex items-center gap-2"><ImageIcon size={20} /> Upload Foto</h3>
                            <UploadArea label="Foto untuk Analisis" currentImage={uploadedImages.consultant} onFileUpload={(e) => handleGeneralFileUpload(e, 'consultant')} onRemoveImage={() => removeImage(null, 'consultant')} icon={Camera} />
                            <button onClick={handleConsultantAnalyze} disabled={isConsultantLoading} className="w-full mt-4 flex items-center justify-center gap-2 px-6 py-3 bg-teal-600 hover:bg-teal-700 text-white rounded-xl font-bold shadow-lg shadow-teal-500/30 transition-all disabled:opacity-50 active:scale-95 text-sm">
                                {isConsultantLoading ? <Loader2 className="animate-spin" size={18} /> : <Stethoscope size={18} />} Analisis Foto
                            </button>
                        </div>
                    </div>
                    <div className="bg-white dark:bg-slate-800 rounded-2xl p-5 shadow-sm border border-slate-200 dark:border-slate-700 min-h-[300px]">
                         <div className="flex justify-between items-center mb-4 border-b border-slate-100 dark:border-slate-700 pb-3">
                            <h3 className="text-lg font-bold text-slate-700 dark:text-slate-200 flex items-center gap-2"><Zap size={20} className="text-teal-500" /> Diagnosis AI</h3>
                            {consultantResult && (
                                <button onClick={() => setReviewData({type: 'text', content: consultantResult, title: 'Review Diagnosis'})} className="text-xs flex items-center gap-1 text-teal-500 hover:text-teal-700 bg-teal-50 hover:bg-teal-100 px-2 py-1 rounded-lg transition-colors font-medium">
                                   <Maximize size={14} /> Full
                                </button>
                             )}
                         </div>
                         <div className="custom-scrollbar">
                            {isConsultantLoading ? (
                                <div className="flex flex-col items-center justify-center py-10 text-slate-400 gap-3"><Loader2 size={32} className="animate-spin text-teal-500" /><p className="text-sm">Meneliti pixel foto...</p></div>
                            ) : consultantResult ? (
                                <div className="prose dark:prose-invert max-w-none text-slate-700 dark:text-slate-300 whitespace-pre-wrap text-sm">{consultantResult}</div>
                            ) : (
                                <div className="flex flex-col items-center justify-center py-10 text-slate-400 opacity-60"><Stethoscope size={48} className="mb-4" /><p className="text-sm">Upload foto untuk kritik.</p></div>
                            )}
                         </div>
                    </div>
                </div>
            ) : activeTab === 'voiceover' ? (
                // --- VOICEOVER STUDIO (UPDATED) ---
                <div className={`gap-6 animate-in fade-in duration-500 pb-20 ${viewMode === 'desktop' ? 'grid grid-cols-2 items-start' : 'space-y-6'}`}>
                     <div className="bg-white dark:bg-slate-800 rounded-2xl p-5 shadow-xl border border-slate-200 dark:border-slate-700">
                        <div className="text-center mb-6">
                            <div className="inline-block p-2 bg-red-100 dark:bg-red-900/30 rounded-full mb-2"><Mic size={24} className="text-red-600 dark:text-red-400" /></div>
                            <h2 className="text-xl font-bold text-slate-800 dark:text-white">Studio Suara Pro</h2>
                        </div>

                        {/* MODE SWITCHER (NEW) */}
                        <div className="flex gap-2 p-1 bg-slate-100 dark:bg-slate-700 rounded-xl mb-6">
                            <button 
                                onClick={() => { setVoiceoverMode('single'); setVoiceText(''); }} 
                                className={`flex-1 py-2 px-3 rounded-lg text-xs font-bold transition-all flex items-center justify-center gap-2 ${voiceoverMode === 'single' ? 'bg-white dark:bg-slate-600 text-red-600 dark:text-red-400 shadow-sm' : 'text-slate-500 hover:text-slate-700 dark:text-slate-400'}`}
                            >
                                <User size={14} /> Narasi Tunggal
                            </button>
                            <button 
                                onClick={() => { setVoiceoverMode('dialogue'); setVoiceText(''); }} 
                                className={`flex-1 py-2 px-3 rounded-lg text-xs font-bold transition-all flex items-center justify-center gap-2 ${voiceoverMode === 'dialogue' ? 'bg-white dark:bg-slate-600 text-red-600 dark:text-red-400 shadow-sm' : 'text-slate-500 hover:text-slate-700 dark:text-slate-400'}`}
                            >
                                <MessageCircle size={14} /> Dialog AI
                            </button>
                        </div>

                        <div className="space-y-5 animate-in fade-in slide-in-from-top-4">
                            {/* 1. Language & Auto-Generator (NEW) */}
                            <div className="p-4 bg-slate-50 dark:bg-slate-900/50 rounded-xl border border-slate-200 dark:border-slate-700">
                                <label className="text-xs font-bold uppercase tracking-wider block mb-2 text-slate-500 dark:text-slate-400 flex items-center gap-1"><Bot size={14}/> Generator Naskah Otomatis</label>
                                
                                <div className="space-y-3">
                                    <div className="flex items-center gap-2 bg-white dark:bg-slate-800 p-2 rounded-lg border border-slate-200 dark:border-slate-600">
                                        <Languages size={16} className="text-slate-400"/>
                                        <select 
                                            value={voiceLanguage} 
                                            onChange={(e) => setVoiceLanguage(e.target.value)} 
                                            className="flex-1 bg-transparent text-xs font-medium text-slate-700 dark:text-slate-200 outline-none"
                                        >
                                            {VOICE_LANGUAGES.map(lang => <option key={lang} value={lang}>{lang}</option>)}
                                        </select>
                                    </div>
                                    
                                    <div className="flex gap-2">
                                        <input 
                                            type="text" 
                                            value={voiceTopic}
                                            onChange={(e) => setVoiceTopic(e.target.value)}
                                            placeholder={voiceoverMode === 'single' ? "Topik: Iklan Kopi, Cerita Pendek..." : "Topik: Podcast Tech, Debat Lucu..."}
                                            className="flex-1 p-2 text-xs rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-slate-900 dark:text-white focus:ring-2 focus:ring-red-500"
                                        />
                                        <button 
                                            onClick={handleGenerateVoiceScript}
                                            disabled={isVoiceScriptLoading || !voiceTopic.trim()}
                                            className="px-3 py-2 bg-red-100 hover:bg-red-200 dark:bg-red-900/30 dark:hover:bg-red-900/50 text-red-700 dark:text-red-300 rounded-lg text-xs font-bold transition-colors disabled:opacity-50"
                                        >
                                            {isVoiceScriptLoading ? <Loader2 size={16} className="animate-spin"/> : <Sparkles size={16}/>}
                                        </button>
                                    </div>
                                </div>
                            </div>

                            {/* 2. Voice Selection (Dynamic based on Mode) */}
                            <div>
                                <label className="text-xs font-bold uppercase tracking-wider block mb-2 text-slate-500 dark:text-slate-400 flex items-center gap-1"><UserCheck size={14}/> Karakter Suara</label>
                                
                                {voiceoverMode === 'single' ? (
                                    // SINGLE MODE: One Voice Selector (Categorized)
                                    <div className="max-h-48 overflow-y-auto custom-scrollbar p-2 border border-slate-200 dark:border-slate-700 rounded-xl bg-slate-50 dark:bg-slate-900 space-y-3">
                                        {/* Female Voices Group */}
                                        <div>
                                            <p className="text-[10px] font-bold text-slate-400 mb-1.5 px-1 uppercase tracking-wider sticky top-0 bg-slate-50 dark:bg-slate-900 z-10">Suara Perempuan</p>
                                            <div className="grid grid-cols-3 sm:grid-cols-4 gap-2">
                                                {VOICES_FEMALE.map(v => (
                                                    <button 
                                                        key={v} 
                                                        onClick={() => setSelectedVoice(v)} 
                                                        className={`px-2 py-2 rounded-lg text-[10px] font-bold transition-all truncate ${selectedVoice === v ? 'bg-fuchsia-600 text-white shadow-md' : 'bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 hover:bg-fuchsia-50 dark:hover:bg-slate-700 border border-slate-100 dark:border-slate-700'}`}
                                                        title={v}
                                                    >
                                                        {v}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>

                                        {/* Male Voices Group */}
                                        <div>
                                            <p className="text-[10px] font-bold text-slate-400 mb-1.5 px-1 uppercase tracking-wider sticky top-0 bg-slate-50 dark:bg-slate-900 z-10">Suara Laki-laki</p>
                                            <div className="grid grid-cols-3 sm:grid-cols-4 gap-2">
                                                {VOICES_MALE.map(v => (
                                                    <button 
                                                        key={v} 
                                                        onClick={() => setSelectedVoice(v)} 
                                                        className={`px-2 py-2 rounded-lg text-[10px] font-bold transition-all truncate ${selectedVoice === v ? 'bg-blue-600 text-white shadow-md' : 'bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 hover:bg-blue-50 dark:hover:bg-slate-700 border border-slate-100 dark:border-slate-700'}`}
                                                        title={v}
                                                    >
                                                        {v}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                ) : (
                                    // DIALOGUE MODE: Two Voice Selectors (Categorized Options)
                                    <div className="space-y-3">
                                        <div>
                                            <p className="text-[10px] font-bold text-slate-500 mb-1">Speaker A (Suara 1)</p>
                                            <select 
                                                value={selectedVoice} 
                                                onChange={(e) => setSelectedVoice(e.target.value)} 
                                                className="w-full p-2 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-xs text-slate-900 dark:text-white"
                                            >
                                                <optgroup label="Perempuan">
                                                    {VOICES_FEMALE.map(v => <option key={v} value={v}>{v}</option>)}
                                                </optgroup>
                                                <optgroup label="Laki-laki">
                                                    {VOICES_MALE.map(v => <option key={v} value={v}>{v}</option>)}
                                                </optgroup>
                                            </select>
                                        </div>
                                        <div>
                                            <p className="text-[10px] font-bold text-slate-500 mb-1">Speaker B (Suara 2)</p>
                                            <select 
                                                value={voice2} 
                                                onChange={(e) => setVoice2(e.target.value)} 
                                                className="w-full p-2 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-xs text-slate-900 dark:text-white"
                                            >
                                                <optgroup label="Perempuan">
                                                    {VOICES_FEMALE.map(v => <option key={v} value={v}>{v}</option>)}
                                                </optgroup>
                                                <optgroup label="Laki-laki">
                                                    {VOICES_MALE.map(v => <option key={v} value={v}>{v}</option>)}
                                                </optgroup>
                                            </select>
                                        </div>
                                    </div>
                                )}
                            </div>
                            
                            {/* 3. Style Control (Only for Single Mode mainly, but available) */}
                            {voiceoverMode === 'single' && (
                                <div>
                                    <label className="text-xs font-bold uppercase tracking-wider block mb-2 text-slate-500 dark:text-slate-400 flex items-center gap-1"><Sliders size={14}/> Gaya Bicara</label>
                                    <div className="flex overflow-x-auto gap-2 pb-2 custom-scrollbar">
                                        {VOICE_STYLES.map(style => (
                                            <button 
                                                key={style.id} 
                                                onClick={() => setVoiceStyle(style.id)} 
                                                className={`whitespace-nowrap px-3 py-1.5 rounded-full text-[10px] font-medium transition-all border ${voiceStyle === style.id ? 'bg-red-100 border-red-500 text-red-700 shadow-sm' : 'bg-slate-50 border-slate-200 text-slate-600 hover:bg-slate-100 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-300'}`}
                                            >
                                                {style.label}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {/* 4. Text Input & Counter (UPDATED) */}
                            <div>
                                <div className="flex justify-between mb-2">
                                    <label className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">
                                        {voiceoverMode === 'single' ? 'Naskah Narasi' : 'Naskah Dialog (Speaker A: ... Speaker B: ...)'}
                                    </label>
                                    <span className="text-[10px] text-slate-400">{voiceText.length} Karakter</span>
                                </div>
                                <textarea 
                                    value={voiceText} 
                                    onChange={(e) => setVoiceText(e.target.value)} 
                                    placeholder={voiceoverMode === 'single' ? "Tulis naskah di sini..." : "Format Wajib:\nSpeaker A: Halo apa kabar?\nSpeaker B: Baik, kamu gimana?\nSpeaker A: ..."}
                                    className="w-full p-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-900 dark:text-white placeholder-slate-400 focus:ring-2 focus:ring-red-500 text-sm resize-none h-32 font-mono"
                                />
                            </div>

                            <button onClick={handleVoiceoverGenerate} disabled={isAudioGenerating || !voiceText.trim()} className="w-full py-3 bg-red-600 hover:bg-red-700 text-white rounded-xl font-bold text-base shadow-lg shadow-red-500/30 transition-all disabled:opacity-50 active:scale-95 flex items-center justify-center gap-2">
                                {isAudioGenerating ? <Loader2 className="animate-spin" size={20} /> : <Volume2 size={20} />} Generate Audio
                            </button>
                        </div>
                     </div>
                     
                     {/* Audio Result placed side-by-side in desktop */}
                     <div>
                        {audioUrl ? (
                            <div className="p-4 bg-slate-50 dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-700 animate-in slide-in-from-bottom-4 shadow-lg">
                                <div className="flex items-center justify-between gap-2 mb-3">
                                    <div className="flex items-center gap-3">
                                        <button 
                                            onClick={() => {
                                                const audio = audioRef.current;
                                                if (!audio) return;
                                                
                                                if (audio.paused) { 
                                                    const playPromise = audio.play();
                                                    if (playPromise !== undefined) {
                                                        playPromise
                                                            .then(() => setIsPlaying(true))
                                                            .catch(error => {
                                                                console.error("Playback error:", error);
                                                                setIsPlaying(false);
                                                            });
                                                    }
                                                } else { 
                                                    audio.pause(); 
                                                    setIsPlaying(false); 
                                                }
                                            }}
                                            className="w-12 h-12 flex items-center justify-center bg-red-600 text-white rounded-full hover:scale-110 transition-transform shadow-md"
                                        >
                                            {isPlaying ? <Pause size={20} /> : <Play size={20} fill="currentColor" />}
                                        </button>
                                        <div className="min-w-0">
                                            <h4 className="font-bold text-sm text-slate-800 dark:text-white truncate">Hasil Audio</h4>
                                            <div className="flex items-center gap-2 text-[10px] text-slate-500">
                                                <span className="bg-slate-200 dark:bg-slate-700 px-1.5 py-0.5 rounded">{selectedVoice}</span>
                                                {voiceoverMode === 'dialogue' && <span className="bg-slate-200 dark:bg-slate-700 px-1.5 py-0.5 rounded">+ {voice2}</span>}
                                                {voiceoverMode === 'single' && <span className="bg-slate-200 dark:bg-slate-700 px-1.5 py-0.5 rounded">{voiceStyle}</span>}
                                            </div>
                                        </div>
                                    </div>
                                    <a href={audioUrl} download={`promo-aisyah-${selectedVoice}.wav`} className="flex items-center gap-1 px-3 py-2 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-700 dark:text-slate-300 text-xs font-medium hover:bg-slate-50">
                                        <Download size={14} /> Unduh
                                    </a>
                                </div>
                                <audio 
                                    ref={audioRef} 
                                    src={audioUrl} 
                                    onEnded={() => setIsPlaying(false)} 
                                    onError={(e) => {
                                        console.error("Audio Load Error Details:", e.currentTarget.error);
                                        setIsPlaying(false);
                                    }}
                                    className="hidden" 
                                />
                                <div className="h-1.5 bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden">
                                    <div className={`h-full bg-red-500 transition-all duration-300 ${isPlaying ? 'w-full animate-[progress_10s_linear]' : 'w-0'}`}></div>
                                </div>
                            </div>
                        ) : (
                            <div className="h-full min-h-[200px] flex flex-col items-center justify-center border-2 border-dashed border-slate-200 dark:border-slate-700 rounded-2xl text-slate-400 bg-slate-50/50 dark:bg-slate-800/50">
                                <Volume2 size={40} className="mb-2 opacity-50"/>
                                <p className="text-sm">Hasil suara muncul di sini</p>
                            </div>
                        )}
                     </div>
                </div>
            ) : (
            // --- STANDARD LAYOUT (STACKED FOR MOBILE, GRID FOR DESKTOP) ---
            <div className={`gap-6 items-start pb-20 ${viewMode === 'desktop' ? 'grid grid-cols-2' : 'flex flex-col'}`}>
              
              {/* Controls (Order 1) */}
              <div className="w-full space-y-6 order-1">
                
                {/* Upload Card */}
                <div className="bg-white dark:bg-slate-800 rounded-2xl p-5 shadow-sm border border-slate-200 dark:border-slate-700">
                  <h3 className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-4 flex items-center gap-2">
                    <Upload size={14} /> Area Upload
                  </h3>

                  {activeTab === 'writer' && (
                    <div className="space-y-4">
                      <p className="text-xs text-slate-600 dark:text-slate-400 mb-2">Upload foto (opsional).</p>
                      <UploadArea label="Foto Referensi" currentImage={uploadedImages.writer} onFileUpload={(e) => handleGeneralFileUpload(e, 'writer')} onRemoveImage={() => removeImage(null, 'writer')} icon={ImageIcon} />
                    </div>
                  )}

                  {activeTab === 'photopass' && (
                    <UploadArea label="Foto Utama (Wajah)" currentImage={uploadedImages.photopass[0]} onFileUpload={(e) => handlePhotopassUpload(e, 'main')} onRemoveImage={() => removeImage(null, 'photopass')} icon={User} />
                  )}

                  {activeTab === 'photographer' && (
                    <div className="space-y-4">
                      <div className="flex bg-slate-100 dark:bg-slate-700/50 p-1 rounded-xl mb-4">
                        <button onClick={() => { setPhotographerTab('maternity'); setAspectRatio('9:16'); }} className={`flex-1 py-2 text-xs font-medium rounded-lg transition-all ${photographerTab === 'maternity' ? 'bg-white dark:bg-slate-600 shadow text-rose-600 dark:text-rose-300' : 'text-slate-500 dark:text-slate-400'}`}>Ibu Hamil</button>
                        <button onClick={() => { setPhotographerTab('newborn'); setAspectRatio('1:1'); }} className={`flex-1 py-2 text-xs font-medium rounded-lg transition-all ${photographerTab === 'newborn' ? 'bg-white dark:bg-slate-600 shadow text-blue-600 dark:text-blue-300' : 'text-slate-500 dark:text-slate-400'}`}>Born Baby</button>
                      </div>
                      {photographerTab === 'maternity' && (
                        <div className="animate-in fade-in slide-in-from-left-4 duration-300 space-y-4">
                            <UploadArea label="Foto Ibu Hamil (Wajib)" currentImage={uploadedImages.photographerMain} onFileUpload={(e) => handleGeneralFileUpload(e, 'main')} onRemoveImage={() => removeImage(null, 'photographerMain')} icon={User} />
                            <UploadArea label="Foto Pasangan (Opsional)" currentImage={uploadedImages.photographerPartner} onFileUpload={(e) => handleGeneralFileUpload(e, 'partner')} onRemoveImage={() => removeImage(null, 'photographerPartner')} icon={Users} />
                        </div>
                      )}
                      {photographerTab === 'newborn' && (
                        <div className="animate-in fade-in slide-in-from-right-4 duration-300 space-y-4">
                            <UploadArea label="Foto Bayi (Wajib)" currentImage={uploadedImages.photographerBaby} onFileUpload={(e) => handleGeneralFileUpload(e, 'baby')} onRemoveImage={() => removeImage(null, 'photographerBaby')} icon={Baby} />
                        </div>
                      )}
                    </div>
                  )}
                  
                  {/* NEW: Fashion / Virtual Try-On Uploads */}
                  {activeTab === 'fashion' && (
                    <div className="space-y-4 animate-in fade-in slide-in-from-top-2">
                        <UploadArea 
                            label="1. Foto Baju (Flat Lay/Manekin)" 
                            currentImage={uploadedImages.fashionGarment} 
                            onFileUpload={(e) => handleGeneralFileUpload(e, 'garment')} 
                            onRemoveImage={() => removeImage(null, 'fashionGarment')} 
                            icon={Shirt} 
                        />
                        <div className="flex justify-center -my-2 relative z-10">
                            <div className="bg-slate-100 dark:bg-slate-700 p-1.5 rounded-full">
                                <ArrowRightLeft size={16} className="text-slate-500"/>
                            </div>
                        </div>
                        <UploadArea 
                            label="2. Foto Model (Orang)" 
                            currentImage={uploadedImages.fashionModel} 
                            onFileUpload={(e) => handleGeneralFileUpload(e, 'model')} 
                            onRemoveImage={() => removeImage(null, 'fashionModel')} 
                            icon={User} 
                        />
                    </div>
                  )}

                   {/* NEW: Artist Photo Upload */}
                  {activeTab === 'artist_photo' && (
                    <div className="space-y-4 animate-in fade-in slide-in-from-top-2">
                        <UploadArea 
                            label="Foto Anda (Selfie/Full Body)" 
                            currentImage={uploadedImages.artistPhoto} 
                            onFileUpload={(e) => handleGeneralFileUpload(e, 'artist_photo')} 
                            onRemoveImage={() => removeImage(null, 'artistPhoto')} 
                            icon={User} 
                        />
                        <p className="text-[10px] text-center text-slate-500">
                          Upload foto yang jelas agar hasil gabungan dengan artis terlihat nyata.
                        </p>
                    </div>
                  )}

                  {activeTab === 'faceswap' && (
                    <div className="space-y-4">
                      <UploadArea label="1. Foto Original (Body)" currentImage={uploadedImages.faceswapSource} onFileUpload={(e) => handleGeneralFileUpload(e, 'source')} onRemoveImage={() => removeImage(null, 'faceswapSource')} icon={ImageIcon} />
                      <div className="flex justify-center -my-2 relative z-10"><div className="bg-slate-100 dark:bg-slate-700 p-1.5 rounded-full"><ArrowRightLeft size={16} className="text-slate-500"/></div></div>
                      <UploadArea label="2. Foto Wajah Target" currentImage={uploadedImages.faceswapTarget} onFileUpload={(e) => handleGeneralFileUpload(e, 'target')} onRemoveImage={() => removeImage(null, 'faceswapTarget')} icon={ScanFace} />
                    </div>
                  )}

                  {/* UPDATE: Upload logic for Coloring split from others */}
                  {['product', 'restore', 'banner'].includes(activeTab) && (
                    <div className="space-y-4">
                        <UploadArea label={`Upload Foto ${activeTab}`} currentImage={uploadedImages[activeTab][0]} onFileUpload={(e) => handleGeneralFileUpload(e, activeTab)} onRemoveImage={() => removeImage(null, activeTab)} icon={ImageIcon} />
                        
                        {/* NEW: Upload area for Artist Endorse when product tab is active and Endorse Category is Indo */}
                        {activeTab === 'product' && productTab === 'artist' && endorseCategory === 'indo' && (
                            <div className="animate-in fade-in slide-in-from-top-2 pt-2 border-t border-slate-100 dark:border-slate-700">
                                <p className="text-xs font-bold text-slate-500 mb-2 flex items-center gap-1"><UserCheck size={12}/> Foto Artis Target</p>
                                <UploadArea 
                                    label="Upload Foto Artis Indonesia" 
                                    currentImage={uploadedImages.productArtist} 
                                    onFileUpload={(e) => handleGeneralFileUpload(e, 'artist')} 
                                    onRemoveImage={() => removeImage(null, 'productArtist')} 
                                    icon={User} 
                                />
                            </div>
                        )}
                    </div>
                  )}
                  
                  {activeTab === 'coloring' && coloringMode === 'upload' && (
                    <div className="animate-in fade-in slide-in-from-top-2">
                        <UploadArea label="Foto Berwarna" currentImage={uploadedImages.coloring[0]} onFileUpload={(e) => handleGeneralFileUpload(e, 'coloring')} onRemoveImage={() => removeImage(null, 'coloring')} icon={ImageIcon} />
                        <p className="text-[10px] text-slate-500 mt-2 text-center">Foto akan diubah menjadi sketsa hitam putih.</p>
                    </div>
                  )}

                  {activeTab === 'art_caricature' && (
                    <div className="animate-in fade-in slide-in-from-top-2">
                        <UploadArea 
                            label="Upload Foto Referensi" 
                            currentImage={uploadedImages.artCaricature} 
                            onFileUpload={(e) => handleGeneralFileUpload(e, 'art_caricature')} 
                            onRemoveImage={() => removeImage(null, 'artCaricature')} 
                            icon={ImageIcon} 
                        />
                         <p className="text-[10px] text-slate-500 mt-2 text-center">Foto akan diubah menjadi karya seni digital.</p>
                    </div>
                  )}

                  {activeTab === 'change_bg' && (
                    <div className="animate-in fade-in slide-in-from-top-2">
                        <UploadArea 
                            label="Upload Foto Utama" 
                            currentImage={uploadedImages.changeBg} 
                            onFileUpload={(e) => handleGeneralFileUpload(e, 'change_bg')} 
                            onRemoveImage={() => removeImage(null, 'changeBg')} 
                            icon={ImagePlus} 
                        />
                         <p className="text-[10px] text-slate-500 mt-2 text-center">AI akan otomatis mendeteksi orang dan mengganti background.</p>
                    </div>
                  )}

                  {activeTab === 'enhancer' && (
                    <div className="animate-in fade-in slide-in-from-top-2">
                        <UploadArea 
                            label="Upload Foto Buram/Low Res" 
                            currentImage={uploadedImages.enhancer[0]} 
                            onFileUpload={(e) => handleGeneralFileUpload(e, 'enhancer')} 
                            onRemoveImage={() => removeImage(null, 'enhancer')} 
                            icon={ImageIcon} 
                        />
                         <p className="text-[10px] text-slate-500 mt-2 text-center">Foto akan diperjelas dan ditingkatkan resolusinya (Upscale).</p>
                    </div>
                  )}

                  {activeTab === 'prompt' && (
                    <div className="space-y-4">
                        <div className="grid grid-cols-2 gap-2">
                             {uploadedImages.prompt.map(img => (
                                 <div key={img.id} className="relative h-24 rounded-xl overflow-hidden border-2 border-slate-300 dark:border-slate-600">
                                     <img src={img.preview} alt="preview" className="w-full h-full object-cover" />
                                     <button onClick={() => removeImage(img.id, 'prompt')} className="absolute top-1 right-1 bg-red-500 text-white p-1 rounded-full z-20"><X size={14} /></button>
                                 </div>
                             ))}
                        </div>
                        {uploadedImages.prompt.length < 4 && (
                            <UploadArea 
                                label={`Upload Referensi (${uploadedImages.prompt.length}/4)`} 
                                currentImage={null} 
                                onFileUpload={(e) => handleGeneralFileUpload(e, 'prompt')} 
                                onRemoveImage={() => {}} 
                                icon={Layers} 
                                multiple={true} 
                            />
                        )}
                        {uploadedImages.prompt.length > 0 && (
                            <button onClick={handleVisionScan} disabled={isAnalyzing} className="w-full flex items-center justify-center gap-2 py-2.5 bg-indigo-50 hover:bg-indigo-100 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300 rounded-xl text-sm font-medium transition-colors">
                            {isAnalyzing ? <><Loader2 size={16} className="animate-spin" /> Menganalisis...</> : <><ScanEye size={16} /> Scan ke Prompt ðŸ‘ï¸</>}
                            </button>
                        )}
                    </div>
                  )}
                  {activeTab === 'prewed' && (
                     <div className="grid grid-cols-2 gap-2">
                        <UploadArea label="Pria" currentImage={uploadedImages.prewedMale} onFileUpload={(e) => handleGeneralFileUpload(e, 'male')} onRemoveImage={() => removeImage(null, 'prewedMale')} icon={User} />
                        <UploadArea label="Wanita" currentImage={uploadedImages.prewedFemale} onFileUpload={(e) => handleGeneralFileUpload(e, 'female')} onRemoveImage={() => removeImage(null, 'prewedFemale')} icon={User} />
                     </div>
                  )}

                  {activeTab === 'mixer' && (
                    <div className="space-y-4">
                      {uploadedImages.mixer.length > 0 && (
                        <div className="grid grid-cols-2 gap-2">
                          {uploadedImages.mixer.map(img => (
                            <div key={img.id} className="relative h-24 rounded-xl overflow-hidden border-2 border-slate-300 dark:border-slate-600">
                              <img src={img.preview} alt="preview" className="w-full h-full object-cover" />
                              <button onClick={() => removeImage(img.id, 'mixer')} className="absolute top-1 right-1 bg-red-500 text-white p-1 rounded-full z-20"><X size={14} /></button>
                            </div>
                          ))}
                        </div>
                      )}
                      {uploadedImages.mixer.length < 4 && <UploadArea label={`Upload (${uploadedImages.mixer.length}/4)`} currentImage={null} onFileUpload={(e) => handleGeneralFileUpload(e, 'mixer')} onRemoveImage={() => {}} icon={Layers} multiple={true} />}
                    </div>
                  )}
                  
                  {activeTab === 'photo_merge' && (
                     <div className="space-y-4">
                         <div className="grid grid-cols-2 gap-2">
                             {uploadedImages.photoMerge.map(img => (
                                 <div key={img.id} className="relative h-24 rounded-xl overflow-hidden border-2 border-slate-300 dark:border-slate-600">
                                     <img src={img.preview} alt="preview" className="w-full h-full object-cover" />
                                     <button onClick={() => removeImage(img.id, 'photoMerge')} className="absolute top-1 right-1 bg-red-500 text-white p-1 rounded-full z-20"><X size={14} /></button>
                                 </div>
                             ))}
                         </div>
                         {uploadedImages.photoMerge.length < 8 && (
                             <UploadArea 
                                 label={`Upload Foto Keluarga (${uploadedImages.photoMerge.length}/8)`} 
                                 currentImage={null} 
                                 onFileUpload={(e) => handleGeneralFileUpload(e, 'photoMerge')} 
                                 onRemoveImage={() => {}} 
                                 icon={Grid} 
                                 multiple={true} 
                             />
                         )}
                         <p className="text-[10px] text-slate-500 dark:text-slate-400">Pilih 2-8 foto.</p>
                     </div>
                  )}
                </div>

                {/* Controls Card */}
                <div className="bg-white dark:bg-slate-800 rounded-2xl p-5 shadow-sm border border-slate-200 dark:border-slate-700 space-y-5">
                  <div className="flex items-center justify-between">
                     <h3 className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 flex items-center gap-2"><Wand2 size={14} /> Kontrol AI</h3>
                     {/* HIGH QUALITY TOGGLE (NEW FEATURE) */}
                     <button 
                         onClick={() => setIsHighQuality(!isHighQuality)} 
                         className={`flex items-center gap-2 px-2.5 py-1 rounded-full text-[10px] font-bold transition-all ${isHighQuality ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-500/30' : 'bg-slate-100 dark:bg-slate-700 text-slate-500'}`}
                     >
                         <Gem size={10} />
                         {isHighQuality ? 'HD: ON' : 'HD: OFF'}
                     </button>
                  </div>

                  {activeTab === 'writer' && (
                    <div className="space-y-4 animate-in fade-in slide-in-from-left-4 duration-300">
                      <div>
                        <label className="text-xs font-medium block mb-2 text-slate-700 dark:text-slate-300 uppercase">Jenis Konten</label>
                        <div className="flex flex-col gap-2">
                          {[{ id: 'caption', label: 'Caption', icon: Share2 }, { id: 'product', label: 'Deskripsi', icon: ImageIcon }, { id: 'letter', label: 'Surat', icon: FileText }].map(mode => (
                            <button key={mode.id} onClick={() => setWriterMode(mode.id)} className={`flex items-center gap-3 p-2.5 rounded-xl border transition-all text-left ${writerMode === mode.id ? 'bg-yellow-100 border-yellow-500 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-200 dark:border-yellow-600' : 'bg-slate-50 border-slate-200 text-slate-600 hover:bg-slate-100 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-300'}`}>
                              <mode.icon size={16} /><span className="font-medium text-xs">{mode.label}</span>
                            </button>
                          ))}
                        </div>
                      </div>
                      <div>
                        <label className="text-xs font-medium block mb-2 text-slate-700 dark:text-slate-300 uppercase">Tone</label>
                        <div className="flex flex-wrap gap-2">
                          {WRITER_TONES.map(t => (
                            <button key={t} onClick={() => setWriterTone(t)} className={`px-2 py-1 text-[10px] rounded-lg border transition-all ${writerTone === t ? 'bg-indigo-100 border-indigo-500 text-indigo-700 font-medium' : 'bg-slate-50 border-slate-200 text-slate-600 hover:bg-slate-100 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-300'}`}>{t}</button>
                          ))}
                        </div>
                      </div>
                      <div>
                        <label className="text-xs font-medium block mb-2 text-slate-700 dark:text-slate-300 uppercase">Detail</label>
                        <textarea rows={3} value={prompt} onChange={(e) => setPrompt(e.target.value)} placeholder="Tuliskan detail..." className="w-full p-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-900 dark:text-white placeholder-slate-400 focus:ring-2 focus:ring-yellow-500 resize-none text-sm"></textarea>
                      </div>
                    </div>
                  )}

                  {/* FIX: USING RENDER FUNCTION INSTEAD OF COMPONENT TO PREVENT FOCUS LOSS */}
                  {activeTab === 'photopass' && renderPhotoPassControls()}

                  {/* --- ENHANCER CONTROLS (NEWLY ADDED) --- */}
                  {activeTab === 'enhancer' && (
                    <div className="space-y-4 mb-4 pb-4 border-b border-slate-200 dark:border-slate-700 animate-in fade-in slide-in-from-top-2">
                        {/* 1. Blur Background Toggle */}
                        <button 
                             onClick={() => setEnhancerBlurBg(!enhancerBlurBg)}
                             className={`w-full flex items-center justify-between p-3 rounded-xl border transition-all ${enhancerBlurBg ? 'bg-purple-50 border-purple-500 text-purple-700' : 'bg-slate-50 border-slate-200 text-slate-600 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-300'}`}
                        >
                            <span className="text-xs font-bold flex items-center gap-2"><BlurIcon size={14} /> Buramkan Latar Belakang</span>
                            <div className={`w-8 h-4 rounded-full relative transition-colors ${enhancerBlurBg ? 'bg-purple-500' : 'bg-slate-300'}`}>
                                <div className={`absolute top-0.5 w-3 h-3 bg-white rounded-full transition-all ${enhancerBlurBg ? 'right-0.5' : 'left-0.5'}`}></div>
                            </div>
                        </button>

                        {/* 2. Color Filter Options */}
                        <div>
                            <label className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-2 flex items-center gap-1"><Palette size={14}/> Pilihan Warna Gambar</label>
                            <div className="grid grid-cols-2 gap-2 max-h-40 overflow-y-auto custom-scrollbar">
                                {ENHANCER_FILTERS.map(filter => (
                                    <button 
                                        key={filter.id} 
                                        onClick={() => setEnhancerColorFilter(filter.id)} 
                                        className={`px-2 py-2 text-[10px] rounded-lg border transition-all text-left truncate ${enhancerColorFilter === filter.id ? 'bg-amber-100 border-amber-500 text-amber-700 font-bold' : 'bg-slate-50 border-slate-200 text-slate-600 hover:bg-slate-100 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-300'}`}
                                    >
                                        {filter.label}
                                    </button>
                                ))}
                            </div>
                        </div>

                        {/* 3. Specific Enhancements */}
                        <div className="space-y-2">
                            <button 
                                onClick={() => setEnhancerBgEnhance(!enhancerBgEnhance)}
                                className={`w-full flex items-center justify-between p-2.5 rounded-lg border transition-all text-xs ${enhancerBgEnhance ? 'bg-cyan-50 border-cyan-500 text-cyan-700' : 'bg-slate-50 border-slate-200 text-slate-500 hover:bg-slate-100 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-300'}`}
                            >
                                <span className="flex items-center gap-2 font-medium"><ImageIcon size={14} /> Peningkatan Latar Belakang</span>
                                {enhancerBgEnhance && <CheckCircle2 size={14} className="text-cyan-600"/>}
                            </button>
                            
                            <button 
                                onClick={() => setEnhancerFaceEnhance(!enhancerFaceEnhance)}
                                className={`w-full flex items-center justify-between p-2.5 rounded-lg border transition-all text-xs ${enhancerFaceEnhance ? 'bg-rose-50 border-rose-500 text-rose-700' : 'bg-slate-50 border-slate-200 text-slate-500 hover:bg-slate-100 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-300'}`}
                            >
                                <span className="flex items-center gap-2 font-medium"><ScanFace size={14} /> Peningkatan Wajah</span>
                                {enhancerFaceEnhance && <CheckCircle2 size={14} className="text-rose-600"/>}
                            </button>
                        </div>
                    </div>
                  )}
                  
                  {activeTab === 'coloring' && (
                     <div className="space-y-4 animate-in fade-in slide-in-from-top-2">
                         {/* MODE SELECTOR (NEW) */}
                         <div>
                            <label className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-2 flex items-center gap-1"><Layout size={14}/> Mode Pembuatan</label>
                            <div className="flex gap-2 p-1 bg-slate-100 dark:bg-slate-700 rounded-xl">
                                <button 
                                    onClick={() => setColoringMode('text')} 
                                    className={`flex-1 py-2 px-3 rounded-lg text-xs font-bold transition-all flex items-center justify-center gap-2 ${coloringMode === 'text' ? 'bg-white dark:bg-slate-600 text-fuchsia-600 dark:text-fuchsia-400 shadow-sm' : 'text-slate-500 hover:text-slate-700 dark:text-slate-400'}`}
                                >
                                    <PenTool size={14} /> Dari Teks
                                </button>
                                <button 
                                    onClick={() => setColoringMode('upload')} 
                                    className={`flex-1 py-2 px-3 rounded-lg text-xs font-bold transition-all flex items-center justify-center gap-2 ${coloringMode === 'upload' ? 'bg-white dark:bg-slate-600 text-fuchsia-600 dark:text-fuchsia-400 shadow-sm' : 'text-slate-500 hover:text-slate-700 dark:text-slate-400'}`}
                                >
                                    <ImageIcon size={14} /> Konversi Foto
                                </button>
                            </div>
                         </div>

                         <div>
                            <label className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-2 flex items-center gap-1"><UserCheck size={14}/> Tingkat Detail</label>
                            <div className="flex gap-2">
                                {['Anak-anak', 'Dewasa'].map(c => (
                                    <button 
                                        key={c} 
                                        onClick={() => setColoringComplexity(c)} 
                                        className={`flex-1 py-2 px-3 rounded-lg text-xs font-medium transition-all border ${coloringComplexity === c ? 'bg-fuchsia-100 border-fuchsia-500 text-fuchsia-700 shadow-sm' : 'bg-slate-50 border-slate-200 text-slate-600 hover:bg-slate-100 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-300'}`}
                                    >
                                        {c}
                                    </button>
                                ))}
                            </div>
                            <p className="text-[10px] text-slate-500 mt-2">
                                {coloringComplexity === 'Anak-anak' ? 'Garis tebal, simpel, area luas.' : 'Detail rumit, pola mandala/zentangle.'}
                            </p>
                         </div>
                     </div>
                  )}
                  
                  {activeTab === 'photographer' && (
                    <div className="space-y-4">
                        {photographerTab === 'maternity' && (
                            <div className="animate-in fade-in slide-in-from-left-4 duration-300 space-y-4">
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="text-xs font-medium block mb-2 text-slate-700 dark:text-slate-300 uppercase">Pose</label>
                                        <select value={maternityPose} onChange={(e) => setMaternityPose(e.target.value)} className="w-full p-2.5 rounded-lg border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-900 dark:text-white text-xs">
                                            {MATERNITY_POSES.map(p => <option key={p} value={p}>{p}</option>)}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="text-xs font-medium block mb-2 text-slate-700 dark:text-slate-300 uppercase">Outfit</label>
                                        <select value={maternityOutfit} onChange={(e) => setMaternityOutfit(e.target.value)} className="w-full p-2.5 rounded-lg border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-900 dark:text-white text-xs">
                                            {MATERNITY_OUTFITS.map(o => <option key={o} value={o}>{o}</option>)}
                                        </select>
                                    </div>
                                </div>

                                {/* NEW: Lighting & Shot Type */}
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="text-xs font-medium block mb-2 text-slate-700 dark:text-slate-300 uppercase">Pencahayaan</label>
                                        <select value={maternityLighting} onChange={(e) => setMaternityLighting(e.target.value)} className="w-full p-2.5 rounded-lg border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-900 dark:text-white text-xs">
                                            {MATERNITY_LIGHTING.map(l => <option key={l} value={l}>{l}</option>)}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="text-xs font-medium block mb-2 text-slate-700 dark:text-slate-300 uppercase">Fokus Foto</label>
                                        <select value={maternityShotType} onChange={(e) => setMaternityShotType(e.target.value)} className="w-full p-2.5 rounded-lg border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-900 dark:text-white text-xs">
                                            {MATERNITY_SHOT_TYPES.map(s => <option key={s} value={s}>{s}</option>)}
                                        </select>
                                    </div>
                                </div>

                                {/* NEW: Props */}
                                <div>
                                    <label className="text-xs font-medium block mb-2 text-slate-700 dark:text-slate-300 uppercase">Properti Tambahan</label>
                                    <div className="flex flex-wrap gap-2">
                                        {MATERNITY_PROPS.map(p => (
                                            <button 
                                                key={p} 
                                                onClick={() => setMaternityProp(p)} 
                                                className={`px-2 py-1 text-[10px] rounded border transition-all ${maternityProp === p ? 'bg-rose-100 border-rose-500 text-rose-700 font-medium' : 'bg-slate-50 border-slate-200 text-slate-600 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-300'}`}
                                            >
                                                {p}
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                <div>
                                    <label className="text-xs font-medium block mb-2 text-slate-700 dark:text-slate-300 uppercase">Tema</label>
                                    <select value={maternityTheme} onChange={(e) => setMaternityTheme(e.target.value)} className="w-full p-2.5 rounded-lg border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-900 dark:text-white text-sm">
                                        {MATERNITY_THEMES.map(t => <option key={t} value={t}>{t}</option>)}
                                    </select>
                                    {maternityTheme === 'Manual' && (
                                        <input 
                                            type="text" 
                                            value={maternityThemeManual} 
                                            onChange={(e) => setMaternityThemeManual(e.target.value)} 
                                            placeholder="Deskripsikan tema (cth: Hutan Fantasi)" 
                                            className="w-full mt-2 p-2.5 rounded-lg border border-rose-300 dark:border-rose-600 bg-rose-50 dark:bg-rose-900/20 text-slate-900 dark:text-white text-sm focus:ring-2 focus:ring-rose-500 animate-in fade-in slide-in-from-top-1" 
                                        />
                                    )}
                                </div>
                            </div>
                        )}
                        {photographerTab === 'newborn' && (
                            <div className="animate-in fade-in slide-in-from-right-4 duration-300 space-y-4">
                                {/* 1. Gender Only (Deco removed) */}
                                <div>
                                    <label className="text-xs font-medium block mb-2 text-slate-700 dark:text-slate-300 uppercase">Gender</label>
                                    <div className="flex gap-2">
                                        {['Laki-laki', 'Perempuan'].map(g => (
                                            <button 
                                                key={g} 
                                                onClick={() => setNewbornGender(g)} 
                                                className={`flex-1 py-2.5 text-xs rounded-lg border transition-all font-medium ${newbornGender === g ? 'bg-blue-100 border-blue-500 text-blue-700' : 'bg-slate-50 border-slate-200 text-slate-600 hover:bg-slate-100 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-300'}`}
                                            >
                                                {g}
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                {/* 2. Theme Selection */}
                                <div>
                                    <label className="text-xs font-medium block mb-2 text-slate-700 dark:text-slate-300 uppercase">Tema Studio</label>
                                    <select value={newbornTheme} onChange={(e) => setNewbornTheme(e.target.value)} className="w-full p-2.5 rounded-lg border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-900 dark:text-white text-sm">
                                        {NEWBORN_THEMES.map(t => <option key={t} value={t}>{t}</option>)}
                                    </select>
                                    {newbornTheme === 'Manual' && (
                                        <input 
                                            type="text" 
                                            value={newbornThemeManual} 
                                            onChange={(e) => setNewbornThemeManual(e.target.value)} 
                                            placeholder="Deskripsikan tema (cth: Hutan Ajaib)" 
                                            className="w-full mt-2 p-2.5 rounded-lg border border-indigo-300 dark:border-indigo-600 bg-indigo-50 dark:bg-indigo-900/20 text-slate-900 dark:text-white text-sm focus:ring-2 focus:ring-indigo-500 animate-in fade-in slide-in-from-top-1" 
                                        />
                                    )}
                                </div>

                                {/* 3. Pose & Outfit (NEW) */}
                                <div className="grid grid-cols-2 gap-3">
                                    <div>
                                        <label className="text-xs font-medium block mb-2 text-slate-700 dark:text-slate-300 uppercase">Pose Bayi</label>
                                        <select value={newbornPose} onChange={(e) => setNewbornPose(e.target.value)} className="w-full p-2 rounded-lg border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-900 dark:text-white text-xs">
                                            {NEWBORN_POSES.map(p => <option key={p} value={p}>{p}</option>)}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="text-xs font-medium block mb-2 text-slate-700 dark:text-slate-300 uppercase">Pakaian</label>
                                        <select value={newbornOutfit} onChange={(e) => setNewbornOutfit(e.target.value)} className="w-full p-2 rounded-lg border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-900 dark:text-white text-xs">
                                            {NEWBORN_OUTFITS.map(o => <option key={o} value={o}>{o}</option>)}
                                        </select>
                                    </div>
                                </div>

                                {/* 4. Accessories (NEW) */}
                                <div>
                                    <label className="text-xs font-medium block mb-2 text-slate-700 dark:text-slate-300 uppercase">Aksesoris Tambahan</label>
                                    <div className="flex flex-wrap gap-2">
                                        {NEWBORN_ACCESSORIES.map(a => (
                                            <button 
                                                key={a} 
                                                onClick={() => setNewbornAccessory(a)} 
                                                className={`px-2 py-1 text-[10px] rounded border transition-all ${newbornAccessory === a ? 'bg-pink-100 border-pink-500 text-pink-700 font-medium' : 'bg-slate-50 border-slate-200 text-slate-600 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-300'}`}
                                            >
                                                {a}
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                {/* 5. Name & Date */}
                                <div className="grid grid-cols-2 gap-3">
                                    <input type="text" value={newbornName} onChange={(e) => setNewbornName(e.target.value)} placeholder="Nama Bayi (Opsional)" className="w-full p-2 rounded-lg border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-xs text-slate-900 dark:text-white" />
                                    <input type="text" value={newbornDate} onChange={(e) => setNewbornDate(e.target.value)} placeholder="Tgl Lahir (Opsional)" className="w-full p-2 rounded-lg border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-xs text-slate-900 dark:text-white" />
                                </div>
                            </div>
                        )}
                        <div className="pt-4 border-t border-slate-200 dark:border-slate-700">
                          <label className="text-xs font-medium block mb-2 text-slate-700 dark:text-slate-300 uppercase">Rasio</label>
                          <div className="grid grid-cols-4 gap-2">
                            {(photographerTab === 'newborn' ? NEWBORN_RATIOS : ['9:16', '16:9']).map(r => (
                                <button key={r} onClick={() => setAspectRatio(r)} className={`p-2 text-[10px] rounded-lg border transition-all ${aspectRatio === r ? 'bg-indigo-100 border-indigo-500 text-indigo-700 font-medium' : 'bg-slate-50 border-slate-200 text-slate-600'}`}>{r}</button>
                            ))}
                          </div>
                        </div>
                        <div>
                          <label className="text-xs font-medium block mb-2 text-slate-700 dark:text-slate-300 uppercase">Instruksi</label>
                          <div className="relative">
                            <textarea rows={2} value={prompt} onChange={(e) => setPrompt(e.target.value)} placeholder="Cth: Tambahkan boneka..." className="w-full p-2.5 pr-10 rounded-lg border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-900 dark:text-white placeholder-slate-400 focus:ring-2 focus:ring-indigo-500 text-sm resize-none"></textarea>
                            <button onClick={handleMagicEnhance} disabled={isEnhancing || !prompt.trim()} className="absolute right-2 bottom-2 p-1.5 bg-indigo-100 hover:bg-indigo-200 dark:bg-slate-600 dark:hover:bg-slate-500 text-indigo-700 dark:text-indigo-300 rounded-md transition-colors disabled:opacity-50">
                                {isEnhancing ? <Loader2 size={14} className="animate-spin"/> : <Sparkles size={14} />}
                            </button>
                          </div>
                        </div>
                    </div>
                  )}

                  {/* ADDED 'coloring', 'artist_photo', 'art_caricature' TO THE LIST BELOW */}
                  {['product', 'restore', 'prompt', 'banner', 'prewed', 'mixer', 'photo_merge', 'coloring', 'fashion', 'artist_photo', 'art_caricature', 'change_bg', 'enhancer'].includes(activeTab) && (
                    <div className="space-y-4">
                      {(activeTab === 'banner') ? (
                        <>
                          <div className="flex gap-2"><input type="text" value={bannerText} onChange={(e) => setBannerText(e.target.value)} placeholder="Teks Banner" className="flex-1 w-full p-2.5 rounded-lg border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-900 dark:text-white text-sm" /><button onClick={generateBannerText} className="p-2.5 rounded-lg bg-slate-100 dark:bg-slate-700"><Sparkles size={18} /></button></div>
                          <div className="flex gap-2"><input type="text" value={bannerStyle} onChange={(e) => setBannerStyle(e.target.value)} placeholder="Gaya Banner" className="flex-1 w-full p-2.5 rounded-lg border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-900 dark:text-white text-sm" /><button onClick={generateBannerStyle} className="p-2.5 rounded-lg bg-slate-100 dark:bg-slate-700"><Sparkles size={18} /></button></div>
                        </>
                      ) : (
                        <>
                           {/* --- PRODUCT PHOTOGRAPHY PRO CONTROLS --- */}
                           {activeTab === 'product' && (
                               <div className="space-y-4 mb-4 pb-4 border-b border-slate-200 dark:border-slate-700 animate-in fade-in slide-in-from-top-2">
                                   {/* --- NEW TAB SWITCHER INSIDE PRODUCT --- */}
                                   <div className="flex bg-slate-100 dark:bg-slate-700/50 p-1 rounded-xl mb-4">
                                        <button 
                                            onClick={() => setProductTab('standard')} 
                                            className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all ${productTab === 'standard' ? 'bg-white dark:bg-slate-600 shadow text-blue-600 dark:text-blue-300' : 'text-slate-500 dark:text-slate-400'}`}
                                        >
                                            Foto Standar
                                        </button>
                                        <button 
                                            onClick={() => setProductTab('artist')} 
                                            className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all ${productTab === 'artist' ? 'bg-white dark:bg-slate-600 shadow text-yellow-600 dark:text-yellow-400' : 'text-slate-500 dark:text-slate-400'}`}
                                        >
                                            Endorse Artis
                                        </button>
                                   </div>

                                   {/* 1. Ratio Selector (Shared) */}
                                   <div>
                                       <label className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-2 flex items-center gap-1"><Maximize size={14}/> Rasio</label>
                                       <div className="flex flex-wrap gap-2">
                                           {PRODUCT_RATIOS.map(r => (
                                               <button key={r} onClick={() => setProductRatio(r)} className={`px-3 py-1.5 text-[10px] rounded border transition-all ${productRatio === r ? 'bg-blue-100 border-blue-500 text-blue-700 font-bold' : 'bg-slate-50 border-slate-200 text-slate-600 hover:bg-slate-100 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-300'}`}>{r}</button>
                                           ))}
                                       </div>
                                   </div>

                                   {/* 2. Background Selector (Shared) */}
                                   <div>
                                       <label className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-2 flex items-center gap-1"><ImageIcon size={14}/> Background</label>
                                       <select 
                                           value={productBg} 
                                           onChange={(e) => setProductBg(e.target.value)} 
                                           className="w-full p-2.5 rounded-lg border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-900 dark:text-white text-sm"
                                       >
                                           {PRODUCT_BACKGROUNDS.map(t => <option key={t} value={t}>{t}</option>)}
                                       </select>
                                   </div>

                                   {/* STANDARD MODE CONTROLS */}
                                   {productTab === 'standard' && (
                                       <div className="space-y-4 animate-in fade-in slide-in-from-left-4">
                                            {/* Placement Selector */}
                                            <div>
                                                <label className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-2 flex items-center gap-1"><Package size={14}/> Penempatan</label>
                                                <select 
                                                    value={productPlacement} 
                                                    onChange={(e) => setProductPlacement(e.target.value)} 
                                                    className="w-full p-2.5 rounded-lg border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-900 dark:text-white text-sm"
                                                >
                                                    {PRODUCT_PLACEMENTS.map(p => <option key={p} value={p}>{p}</option>)}
                                                </select>
                                            </div>

                                            {/* Lighting Selector */}
                                            <div>
                                                <label className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-2 flex items-center gap-1"><Sun size={14}/> Cahaya</label>
                                                <div className="flex flex-wrap gap-2">
                                                        {PRODUCT_LIGHTING.map(l => (
                                                            <button key={l} onClick={() => setProductLight(l)} className={`px-2 py-1 text-[10px] rounded border transition-all ${productLight === l ? 'bg-yellow-100 border-yellow-500 text-yellow-800' : 'bg-slate-50 border-slate-200 text-slate-600'}`}>{l}</button>
                                                        ))}
                                                </div>
                                            </div>
                                       </div>
                                   )}

                                   {/* ARTIST ENDORSE MODE CONTROLS */}
                                   {productTab === 'artist' && (
                                       <div className="space-y-4 animate-in fade-in slide-in-from-right-4">
                                            {/* Category Selector */}
                                            <div>
                                                <label className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-2 flex items-center gap-1"><Star size={14}/> Kategori Artis</label>
                                                <div className="flex gap-2">
                                                    <button 
                                                        onClick={() => setEndorseCategory('indo')} 
                                                        className={`flex-1 py-2 px-3 rounded-lg text-xs font-medium transition-all border ${endorseCategory === 'indo' ? 'bg-red-100 border-red-500 text-red-700' : 'bg-slate-50 border-slate-200 text-slate-600'}`}
                                                    >
                                                        Indonesia ðŸ‡®ðŸ‡©
                                                    </button>
                                                    <button 
                                                        onClick={() => setEndorseCategory('hollywood')} 
                                                        className={`flex-1 py-2 px-3 rounded-lg text-xs font-medium transition-all border ${endorseCategory === 'hollywood' ? 'bg-blue-100 border-blue-500 text-blue-700' : 'bg-slate-50 border-slate-200 text-slate-600'}`}
                                                    >
                                                        Hollywood ðŸ‡ºðŸ‡¸
                                                    </button>
                                                </div>
                                            </div>

                                            {/* Artist Selector / Upload */}
                                            <div>
                                                <label className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-2 flex items-center gap-1"><UserCheck size={14}/> {endorseCategory === 'indo' ? 'Upload Artis' : 'Pilih Artis'}</label>
                                                
                                                {endorseCategory === 'indo' ? (
                                                    <div className="space-y-2">
                                                        <div className="p-2 bg-blue-50 dark:bg-blue-900/20 border border-blue-100 dark:border-blue-800 rounded-lg text-[10px] text-blue-700 dark:text-blue-300">
                                                            Upload foto artis/influencer yang ingin Anda gunakan sebagai model endorse.
                                                        </div>
                                                        {/* Upload area is handled in the upload section on the left, but we can show status here */}
                                                        {uploadedImages.productArtist ? (
                                                            <div className="flex items-center gap-2 p-2 bg-green-50 border border-green-200 rounded-lg text-green-700 text-xs">
                                                                <CheckCircle2 size={16} /> Foto artis terupload siap.
                                                            </div>
                                                        ) : (
                                                            <div className="flex items-center gap-2 p-2 bg-slate-50 border border-slate-200 rounded-lg text-slate-500 text-xs">
                                                                <ImageIcon size={16} /> Belum ada foto artis (Upload di kiri).
                                                            </div>
                                                        )}
                                                    </div>
                                                ) : (
                                                    <select 
                                                        value={endorseArtist} 
                                                        onChange={(e) => setEndorseArtist(e.target.value)} 
                                                        className="w-full p-2.5 rounded-lg border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-900 dark:text-white text-sm"
                                                    >
                                                        {ARTISTS_HOLLYWOOD.map(artist => (
                                                            <option key={artist} value={artist}>{artist}</option>
                                                        ))}
                                                    </select>
                                                )}
                                            </div>
                                            <p className="text-[10px] text-slate-500 italic">
                                                *Foto produk akan ditempatkan di tangan artis pilihan Anda secara realistis.
                                            </p>
                                       </div>
                                   )}
                               </div>
                           )}

                           {/* --- FASHION AI CONTROLS --- */}
                           {activeTab === 'fashion' && (
                               <div className="space-y-4 mb-4 pb-4 border-b border-slate-200 dark:border-slate-700 animate-in fade-in slide-in-from-top-2">
                                   {/* 1. Fashion Type Selector */}
                                   <div>
                                       <label className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-2 flex items-center gap-1"><Shirt size={14}/> Jenis Pakaian</label>
                                       <div className="flex flex-wrap gap-2">
                                           {FASHION_TYPES.map(t => (
                                               <button key={t} onClick={() => setFashionType(t)} className={`px-2 py-1.5 text-[10px] rounded border transition-all ${fashionType === t ? 'bg-pink-100 border-pink-500 text-pink-700 font-bold' : 'bg-slate-50 border-slate-200 text-slate-600 hover:bg-slate-100 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-300'}`}>{t}</button>
                                           ))}
                                       </div>
                                   </div>

                                   {/* 2. Shot Type Selector */}
                                   <div>
                                       <label className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-2 flex items-center gap-1"><Maximize size={14}/> Tipe Shot</label>
                                       <div className="flex flex-wrap gap-2">
                                           {FASHION_SHOT_TYPES.map(t => (
                                               <button key={t} onClick={() => setFashionShotType(t)} className={`px-2 py-1.5 text-[10px] rounded border transition-all ${fashionShotType === t ? 'bg-pink-100 border-pink-500 text-pink-700 font-bold' : 'bg-slate-50 border-slate-200 text-slate-600 hover:bg-slate-100 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-300'}`}>{t}</button>
                                           ))}
                                       </div>
                                   </div>

                                   {/* 3. Background Selector (NEW) */}
                                   <div>
                                       <label className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-2 flex items-center gap-1"><ImageIcon size={14}/> Background</label>
                                       <div className="flex flex-wrap gap-2">
                                           {FASHION_BACKGROUNDS.map(bg => (
                                               <button 
                                                   key={bg} 
                                                   onClick={() => setFashionBg(bg)} 
                                                   className={`px-2 py-1.5 text-[10px] rounded border transition-all ${fashionBg === bg ? 'bg-pink-100 border-pink-500 text-pink-700 font-bold' : 'bg-slate-50 border-slate-200 text-slate-600 hover:bg-slate-100 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-300'}`}
                                               >
                                                   {bg}
                                               </button>
                                           ))}
                                       </div>
                                   </div>
                               </div>
                           )}

                           {/* --- CHANGE BACKGROUND CONTROLS (NEW) --- */}
                           {activeTab === 'change_bg' && (
                               <div className="space-y-4 mb-4 pb-4 border-b border-slate-200 dark:border-slate-700 animate-in fade-in slide-in-from-top-2">
                                   
                                   {/* Mode Switcher */}
                                   <div>
                                      <label className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-2 flex items-center gap-1"><Layers size={14}/> Sumber Background</label>
                                      <div className="flex gap-2 p-1 bg-slate-100 dark:bg-slate-700 rounded-xl">
                                          <button onClick={() => setChangeBgMode('preset')} className={`flex-1 py-2 px-3 rounded-lg text-xs font-bold transition-all ${changeBgMode === 'preset' ? 'bg-white dark:bg-slate-600 text-cyan-600 dark:text-cyan-400 shadow-sm' : 'text-slate-500 hover:text-slate-700 dark:text-slate-400'}`}>Pilih Preset</button>
                                          <button onClick={() => setChangeBgMode('upload')} className={`flex-1 py-2 px-3 rounded-lg text-xs font-bold transition-all ${changeBgMode === 'upload' ? 'bg-white dark:bg-slate-600 text-cyan-600 dark:text-cyan-400 shadow-sm' : 'text-slate-500 hover:text-slate-700 dark:text-slate-400'}`}>Upload Sendiri</button>
                                      </div>
                                   </div>

                                   {changeBgMode === 'preset' ? (
                                       <>
                                           {/* 1. Category Selector */}
                                           <div>
                                               <label className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-2 flex items-center gap-1"><Users size={14}/> Kategori</label>
                                               <div className="flex gap-2 p-1 bg-slate-100 dark:bg-slate-700 rounded-xl">
                                                   <button 
                                                       onClick={() => { setChangeBgCategory('Dewasa'); setChangeBgStyle(BG_ADULT_OPTIONS[0]); }} 
                                                       className={`flex-1 py-2 px-3 rounded-lg text-xs font-bold transition-all ${changeBgCategory === 'Dewasa' ? 'bg-white dark:bg-slate-600 text-cyan-600 dark:text-cyan-400 shadow-sm' : 'text-slate-500 hover:text-slate-700 dark:text-slate-400'}`}
                                                   >
                                                       Dewasa
                                                   </button>
                                                   <button 
                                                       onClick={() => { setChangeBgCategory('Anak-anak'); setChangeBgStyle(BG_CHILD_OPTIONS[0]); }} 
                                                       className={`flex-1 py-2 px-3 rounded-lg text-xs font-bold transition-all ${changeBgCategory === 'Anak-anak' ? 'bg-white dark:bg-slate-600 text-cyan-600 dark:text-cyan-400 shadow-sm' : 'text-slate-500 hover:text-slate-700 dark:text-slate-400'}`}
                                                   >
                                                       Anak-anak
                                                   </button>
                                               </div>
                                           </div>

                                           {/* 2. Background Style Selector */}
                                           <div>
                                               <label className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-2 flex items-center gap-1"><ImageIcon size={14}/> Pilihan Background</label>
                                               <div className="grid grid-cols-2 gap-2 max-h-48 overflow-y-auto custom-scrollbar p-1">
                                                   {(changeBgCategory === 'Dewasa' ? BG_ADULT_OPTIONS : BG_CHILD_OPTIONS).map(style => (
                                                       <button 
                                                           key={style} 
                                                           onClick={() => setChangeBgStyle(style)} 
                                                           className={`px-3 py-2 text-[10px] rounded-lg border transition-all text-left ${changeBgStyle === style ? 'bg-cyan-100 border-cyan-500 text-cyan-700 font-bold' : 'bg-slate-50 border-slate-200 text-slate-600 hover:bg-slate-100 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-300'}`}
                                                       >
                                                           {style}
                                                       </button>
                                                   ))}
                                               </div>
                                           </div>
                                       </>
                                   ) : (
                                       /* Upload Reference Area */
                                       <div className="animate-in fade-in slide-in-from-top-1">
                                           <label className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-2 flex items-center gap-1"><ImagePlus size={14}/> Upload Background</label>
                                           <UploadArea 
                                               label="Foto Latar Belakang" 
                                               currentImage={uploadedImages.changeBgReference} 
                                               onFileUpload={(e) => handleGeneralFileUpload(e, 'reference')} 
                                               onRemoveImage={() => removeImage(null, 'changeBgReference')} 
                                               icon={ImageIcon} 
                                           />
                                       </div>
                                   )}
                               </div>
                           )}

                           {/* --- ARTIST PHOTO INPUT (UPDATED) --- */}
                           {activeTab === 'artist_photo' && (
                                <div className="space-y-4 mb-4 pb-4 border-b border-slate-200 dark:border-slate-700 animate-in fade-in slide-in-from-top-2">
                                    <label className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-2 flex items-center gap-1"><Star size={14}/> Target Artis</label>
                                    
                                    {/* Toggle Mode */}
                                    <div className="flex gap-2 p-1 bg-slate-100 dark:bg-slate-700 rounded-xl mb-3">
                                        <button 
                                            onClick={() => setArtistMode('name')} 
                                            className={`flex-1 py-2 px-3 rounded-lg text-xs font-bold transition-all ${artistMode === 'name' ? 'bg-white dark:bg-slate-600 text-yellow-600 dark:text-yellow-400 shadow-sm' : 'text-slate-500 hover:text-slate-700 dark:text-slate-400'}`}
                                        >
                                            Tulis Nama
                                        </button>
                                        <button 
                                            onClick={() => setArtistMode('upload')} 
                                            className={`flex-1 py-2 px-3 rounded-lg text-xs font-bold transition-all ${artistMode === 'upload' ? 'bg-white dark:bg-slate-600 text-yellow-600 dark:text-yellow-400 shadow-sm' : 'text-slate-500 hover:text-slate-700 dark:text-slate-400'}`}
                                        >
                                            Upload Foto
                                        </button>
                                    </div>

                                    {artistMode === 'name' ? (
                                        <>
                                            <input 
                                                type="text" 
                                                value={selectedArtist} 
                                                onChange={(e) => setSelectedArtist(e.target.value)}
                                                placeholder="Cth: Agnez Mo, Taylor Swift..."
                                                className="w-full p-2.5 rounded-lg border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-900 dark:text-white text-sm focus:ring-2 focus:ring-yellow-500"
                                            />
                                            <p className="text-[10px] text-slate-500 italic">Tulis nama artis yang ingin diajak foto bareng.</p>
                                        </>
                                    ) : (
                                        <div className="animate-in fade-in slide-in-from-top-1">
                                             <UploadArea 
                                                label="Foto Artis Target" 
                                                currentImage={uploadedImages.artistTarget} 
                                                onFileUpload={(e) => handleGeneralFileUpload(e, 'target')} 
                                                onRemoveImage={() => removeImage(null, 'artistTarget')} 
                                                icon={Star} 
                                            />
                                        </div>
                                    )}
                                </div>
                           )}

                           {/* --- ART & KARIKATUR CONTROLS (NEW) --- */}
                           {activeTab === 'art_caricature' && (
                               <div className="space-y-4 mb-4 pb-4 border-b border-slate-200 dark:border-slate-700 animate-in fade-in slide-in-from-top-2">
                                   
                                   {/* 1. Mode Selector */}
                                   <div>
                                       <label className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-2 flex items-center gap-1"><Brush size={14}/> Jenis Seni</label>
                                       <div className="flex gap-2">
                                           <button 
                                               onClick={() => setArtType('painting')} 
                                               className={`flex-1 py-2 px-3 rounded-lg text-xs font-bold transition-all border flex items-center justify-center gap-2 ${artType === 'painting' ? 'bg-fuchsia-100 border-fuchsia-500 text-fuchsia-700 shadow-sm' : 'bg-slate-50 border-slate-200 text-slate-600 hover:bg-slate-100 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-300'}`}
                                           >
                                               <Palette size={14}/> Seni Lukis
                                           </button>
                                           <button 
                                               onClick={() => setArtType('caricature')} 
                                               className={`flex-1 py-2 px-3 rounded-lg text-xs font-bold transition-all border flex items-center justify-center gap-2 ${artType === 'caricature' ? 'bg-fuchsia-100 border-fuchsia-500 text-fuchsia-700 shadow-sm' : 'bg-slate-50 border-slate-200 text-slate-600 hover:bg-slate-100 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-300'}`}
                                           >
                                               <User size={14}/> Karikatur
                                           </button>
                                       </div>
                                   </div>

                                   {/* 2. Style Selector */}
                                   <div>
                                       <label className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-2 flex items-center gap-1"><Sparkles size={14}/> Gaya {artType === 'painting' ? 'Lukisan' : 'Karikatur'}</label>
                                       <div className="flex flex-wrap gap-2">
                                           {(artType === 'painting' ? ART_PAINTING_STYLES : ART_CARICATURE_STYLES).map(style => (
                                               <button 
                                                   key={style} 
                                                   onClick={() => {
                                                       setArtStyle(style);
                                                       if (style !== 'Kustom') setArtCustomStyle('');
                                                   }} 
                                                   className={`px-3 py-1.5 text-[10px] rounded-lg border transition-all ${artStyle === style ? 'bg-fuchsia-100 border-fuchsia-500 text-fuchsia-700 font-bold' : 'bg-slate-50 border-slate-200 text-slate-600 hover:bg-slate-100 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-300'}`}
                                               >
                                                   {style}
                                               </button>
                                           ))}
                                       </div>
                                       
                                       {/* Custom Input */}
                                       {artStyle === 'Kustom' && (
                                            <div className="mt-3 animate-in fade-in slide-in-from-top-1">
                                                <input 
                                                    type="text" 
                                                    value={artCustomStyle} 
                                                    onChange={(e) => setArtCustomStyle(e.target.value)} 
                                                    placeholder={artType === 'painting' ? "Cth: Gaya Van Gogh, Cyberpunk..." : "Cth: Karikatur monster lucu..."}
                                                    className="w-full p-2.5 rounded-lg border border-fuchsia-300 dark:border-fuchsia-600 bg-fuchsia-50 dark:bg-fuchsia-900/20 text-slate-900 dark:text-white text-sm focus:ring-2 focus:ring-fuchsia-500"
                                                />
                                            </div>
                                       )}
                                   </div>
                               </div>
                           )}

                           {activeTab === 'photo_merge' && (
                               <div className="space-y-4 mb-4 pb-4 border-b border-slate-200 dark:border-slate-700 animate-in fade-in slide-in-from-top-2">
                                   
                                   {/* 1. Mode Selector */}
                                   <div>
                                       <label className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-2 flex items-center gap-1"><Frame size={14}/> Mode</label>
                                       <div className="flex gap-2">
                                           {['Seamless', 'Collage'].map(m => (
                                               <button 
                                                   key={m} 
                                                   onClick={() => setMergeMode(m)} 
                                                   className={`flex-1 py-2 px-3 rounded-lg text-xs font-medium transition-all border ${mergeMode === m ? 'bg-cyan-100 border-cyan-500 text-cyan-700 shadow-sm' : 'bg-slate-50 border-slate-200 text-slate-600 hover:bg-slate-100 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-300'}`}
                                               >
                                                   {m === 'Seamless' ? 'Blend' : 'Grid'}
                                               </button>
                                           ))}
                                       </div>
                                   </div>

                                   {/* 2. Theme Selector */}
                                   <div>
                                       <label className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-2 flex items-center gap-1"><ImageIcon size={14}/> Latar</label>
                                       <select 
                                           value={mergeTheme} 
                                           onChange={(e) => setMergeTheme(e.target.value)} 
                                           className="w-full p-2.5 rounded-lg border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-900 dark:text-white text-sm"
                                       >
                                           {MERGE_THEMES.map(t => <option key={t} value={t}>{t}</option>)}
                                       </select>
                                   </div>

                                   {/* 3. Outfit Selector (Harmonization) */}
                                   <div>
                                       <label className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-2 flex items-center gap-1"><Shirt size={14}/> Pakaian</label>
                                       <select 
                                           value={mergeOutfit} 
                                           onChange={(e) => setMergeOutfit(e.target.value)} 
                                           className="w-full p-2.5 rounded-lg border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-900 dark:text-white text-sm"
                                       >
                                           {MERGE_OUTFITS.map(o => <option key={o} value={o}>{o}</option>)}
                                       </select>
                                   </div>
                               </div>
                           )}

                           {/* --- PROMPT AI PROFESSIONAL CONTROLS --- */}
                           {activeTab === 'prompt' && (
                               <div className="space-y-4 mb-4 pb-4 border-b border-slate-200 dark:border-slate-700 animate-in fade-in slide-in-from-top-2">
                                    {/* Style Preset */}
                                    <div>
                                        <label className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-2 flex items-center gap-1"><Palette size={14}/> Style</label>
                                        <div className="flex overflow-x-auto gap-2 pb-2 custom-scrollbar">
                                            {PROMPT_STYLES.map(style => (
                                                <button 
                                                    key={style} 
                                                    onClick={() => setPromptStyle(style)} 
                                                    className={`whitespace-nowrap px-3 py-1.5 rounded-full text-[10px] font-medium transition-all border ${promptStyle === style ? 'bg-pink-100 border-pink-500 text-pink-700 shadow-sm' : 'bg-slate-50 border-slate-200 text-slate-600 hover:bg-slate-100 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-300'}`}
                                                >
                                                    {style}
                                                </button>
                                            ))}
                                        </div>
                                    </div>

                                    {/* Aspect Ratio */}
                                    <div>
                                        <label className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-2 flex items-center gap-1"><Maximize size={14}/> Rasio</label>
                                        <div className="flex flex-wrap gap-2">
                                            {PROMPT_RATIOS.map(ratio => (
                                                <button 
                                                    key={ratio} 
                                                    onClick={() => setPromptAspectRatio(ratio)} 
                                                    className={`px-3 py-1.5 rounded-lg text-[10px] font-medium transition-all border ${promptAspectRatio === ratio ? 'bg-indigo-100 border-indigo-500 text-indigo-700 shadow-sm' : 'bg-slate-50 border-slate-200 text-slate-600 hover:bg-slate-100 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-300'}`}
                                                >
                                                    {ratio}
                                                </button>
                                            ))}
                                        </div>
                                    </div>

                                    {/* Negative Prompt */}
                                    <div>
                                        <label className="text-xs font-bold uppercase tracking-wider text-red-500/80 dark:text-red-400/80 mb-2 flex items-center gap-1"><Ban size={14}/> Negative</label>
                                        <textarea 
                                            rows={2} 
                                            value={negativePrompt} 
                                            onChange={(e) => setNegativePrompt(e.target.value)} 
                                            placeholder="Hindari (cth: blur)..." 
                                            className="w-full p-2.5 rounded-lg border border-red-200 dark:border-red-900/30 bg-red-50/50 dark:bg-slate-700/50 text-slate-900 dark:text-white placeholder-slate-400 focus:ring-2 focus:ring-red-500 resize-none text-xs"
                                        ></textarea>
                                    </div>
                               </div>
                           )}
                           
                           {/* GLOBAL STYLE SELECTOR (FOR ALL MENUS EXCEPT PROMPT) */}
                           {activeTab !== 'prompt' && activeTab !== 'writer' && activeTab !== 'coloring' && activeTab !== 'artist_photo' && activeTab !== 'art_caricature' && activeTab !== 'voiceover' && activeTab !== 'change_bg' && activeTab !== 'enhancer' && (
                                <div className="mb-4">
                                   <label className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-2 flex items-center gap-1"><Palette size={14}/> Gaya (Opsional)</label>
                                   <select 
                                       value={promptStyle} 
                                       onChange={(e) => setPromptStyle(e.target.value)} 
                                       className="w-full p-2.5 rounded-lg border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-900 dark:text-white text-sm"
                                   >
                                       {PROMPT_STYLES.map(s => <option key={s} value={s}>{s}</option>)}
                                   </select>
                                </div>
                           )}

                          {activeTab !== 'voiceover' && (
                            <>
                                <label className="text-xs font-medium block text-slate-700 dark:text-slate-300 uppercase">
                                    {activeTab === 'coloring' && coloringMode === 'text' ? 'Deskripsi Gambar (Wajib)' : 'Instruksi AI (Opsional)'}
                                </label>
                                <div className="flex gap-2 items-start">
                                    <div className="relative flex-1">
                                        <textarea 
                                            rows={3} 
                                            value={prompt} 
                                            onChange={(e) => setPrompt(e.target.value)} 
                                            placeholder={activeTab === 'coloring' && coloringMode === 'text' ? "Cth: Seekor kucing lucu sedang memancing ikan..." : "Deskripsikan..."}
                                            className="w-full p-2.5 rounded-lg border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-900 dark:text-white placeholder-slate-400 focus:ring-2 focus:ring-indigo-500 resize-none text-sm"
                                        ></textarea>
                                        <button onClick={handleMagicEnhance} disabled={isEnhancing || !prompt.trim()} className="absolute right-2 bottom-2 flex items-center gap-1 px-2 py-1 bg-indigo-600 hover:bg-indigo-700 text-white text-[10px] rounded-md transition-colors disabled:opacity-50 shadow-sm active:scale-95">
                                            {isEnhancing ? <Loader2 size={10} className="animate-spin"/> : <Sparkles size={10} />} Enhance
                                        </button>
                                    </div>
                                    <button onClick={generateAutoPrompt} className="p-2.5 rounded-lg bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 active:scale-95 h-full" title="Auto Prompt"><BrainCircuit size={18} /></button>
                                </div>
                            </>
                          )}
                        </>
                      )}
                    </div>
                  )}

                  {/* --- FACE SWAP PROFESSIONAL CONTROLS --- */}
                  {activeTab === 'faceswap' && (
                    <div className="space-y-4 mb-4 pb-4 border-b border-slate-200 dark:border-slate-700 animate-in fade-in slide-in-from-top-2">
                        {/* Swap Mode */}
                        <div>
                            <label className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-2 flex items-center gap-1"><Palette size={14}/> Swap Mode</label>
                            <div className="flex gap-2">
                                {['Realistic', 'Artistic', 'Funny'].map(m => (
                                    <button 
                                        key={m} 
                                        onClick={() => setSwapMode(m)} 
                                        className={`flex-1 py-1.5 rounded-lg text-[10px] font-medium transition-all border ${swapMode === m ? 'bg-indigo-100 border-indigo-500 text-indigo-700 shadow-sm' : 'bg-slate-50 border-slate-200 text-slate-600 hover:bg-slate-100 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-300'}`}
                                    >
                                        {m}
                                    </button>
                                ))}
                            </div>
                        </div>

                        {/* Advanced Options */}
                        <div>
                            <label className="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-2 flex items-center gap-1"><Sliders size={14}/> Advanced</label>
                            <div className="space-y-2">
                                <button 
                                    onClick={() => setEnableFaceEnhance(!enableFaceEnhance)}
                                    className={`w-full flex items-center justify-between p-2.5 rounded-lg border transition-all text-xs ${enableFaceEnhance ? 'bg-green-50 border-green-500 text-green-700' : 'bg-slate-50 border-slate-200 text-slate-500 hover:bg-slate-100 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-300'}`}
                                >
                                    <span className="flex items-center gap-2 font-medium"><Sparkles size={14} /> Face Enhancer</span>
                                    <div className={`w-8 h-4 rounded-full relative transition-colors ${enableFaceEnhance ? 'bg-green-500' : 'bg-slate-300'}`}>
                                        <div className={`absolute top-0.5 w-3 h-3 bg-white rounded-full transition-all ${enableFaceEnhance ? 'right-0.5' : 'left-0.5'}`}></div>
                                    </div>
                                </button>
                                
                                <button 
                                    onClick={() => setMatchSkinTone(!matchSkinTone)}
                                    className={`w-full flex items-center justify-between p-2.5 rounded-lg border transition-all text-xs ${matchSkinTone ? 'bg-blue-50 border-blue-500 text-blue-700' : 'bg-slate-50 border-slate-200 text-slate-500 hover:bg-slate-100 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-300'}`}
                                >
                                    <span className="flex items-center gap-2 font-medium"><UserCheck size={14} /> Match Tone</span>
                                    <div className={`w-8 h-4 rounded-full relative transition-colors ${matchSkinTone ? 'bg-blue-500' : 'bg-slate-300'}`}>
                                        <div className={`absolute top-0.5 w-3 h-3 bg-white rounded-full transition-all ${matchSkinTone ? 'right-0.5' : 'left-0.5'}`}></div>
                                    </div>
                                </button>
                            </div>
                        </div>
                    </div>
                  )}

                  {activeTab !== 'voiceover' && (
                    <>
                        <button
                            onClick={activeTab === 'writer' ? handleWriterGenerate : handleGenerate}
                            disabled={activeTab === 'writer' ? isWriterLoading : isLoading}
                            className={`w-full flex items-center justify-center gap-2 px-6 py-3 text-lg font-semibold rounded-xl text-white transition-all duration-300 active:scale-95
                                    ${activeTab === 'writer' ? 'bg-yellow-600 hover:bg-yellow-700 shadow-yellow-500/50' : 'bg-indigo-600 hover:bg-indigo-700 shadow-indigo-500/50'} 
                                    disabled:bg-slate-400 disabled:cursor-not-allowed shadow-lg`}
                        >
                            {activeTab === 'writer' ? (isWriterLoading ? <><Loader2 size={24} className="animate-spin" /> Menulis...</> : <><PenTool size={24} /> Tulis âœ¨</>) : (isLoading ? <><Loader2 size={24} className="animate-spin" /> {getLoadingText()}</> : <><Aperture size={24} /> Proses AI</>)}
                        </button>
                        {error && <div className="text-red-600 dark:text-red-400 bg-red-50 dark:bg-red-900/30 border border-red-300 dark:border-red-700 p-3 rounded-lg text-sm">{error}</div>}
                    </>
                  )}
                  {activeTab === 'voiceover' && error && <div className="text-red-600 dark:text-red-400 bg-red-50 dark:bg-red-900/30 border border-red-300 dark:border-red-700 p-3 rounded-lg text-sm">{error}</div>}
                </div>
              </div>

              {/* Output (Order 2) */}
              <div className="w-full space-y-6 animate-in fade-in duration-700 order-2">
                {activeTab === 'writer' ? (
                  <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 p-5 min-h-[300px] flex flex-col">
                    <div className="flex justify-between items-center mb-4"><h3 className="font-bold text-slate-700 dark:text-white flex items-center gap-2"><FileText size={20} className="text-yellow-600" /> Hasil</h3>
                        <div className="flex gap-2">
                           {writerResult && (
                              <button onClick={() => setReviewData({type: 'text', content: writerResult, title: 'Review Copywriting'})} className="flex items-center gap-1.5 text-xs font-medium px-3 py-1.5 bg-yellow-100 text-yellow-700 hover:bg-yellow-200 rounded-lg transition-colors">
                                 <Maximize size={14} /> Full
                              </button>
                           )}
                           {writerResult && <button onClick={() => copyToClipboard(writerResult)} className="flex items-center gap-1.5 text-xs font-medium px-3 py-1.5 bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600 rounded-lg"><Copy size={14} /> Copy</button>}
                        </div>
                    </div>
                    <div className="flex-1 bg-slate-50 dark:bg-slate-900/50 rounded-xl p-4 border border-slate-200 dark:border-slate-700 overflow-y-auto custom-scrollbar">
                      {isWriterLoading ? <div className="flex flex-col items-center justify-center h-full text-slate-400 space-y-3"><Loader2 size={32} className="animate-spin text-yellow-500" /><p className="text-sm">Merangkai kata...</p></div> : writerResult ? <div className="whitespace-pre-wrap text-slate-700 dark:text-slate-300 leading-relaxed font-serif text-sm">{writerResult}</div> : <div className="flex flex-col items-center justify-center h-full text-slate-400"><PenTool size={48} className="mb-4 opacity-20" /><p className="text-center max-w-xs text-sm">Belum ada tulisan.</p></div>}
                    </div>
                  </div>
                ) : (
                  <>
                    {isLoading && <div className="flex flex-col items-center justify-center h-64 bg-white dark:bg-slate-800 rounded-2xl shadow-xl border-4 border-dashed border-indigo-400/50 p-6"><Loader2 size={48} className="animate-spin text-indigo-500 mb-4" /><p className="text-lg font-semibold text-slate-700 dark:text-slate-300">{getLoadingText()}</p></div>}
                    {!isLoading && generatedImages.length === 0 && <div className="flex flex-col items-center justify-center h-48 bg-white dark:bg-slate-800 rounded-2xl shadow-xl border border-slate-200 dark:border-slate-700 p-6 text-center"><Printer size={40} className="text-indigo-400 mb-4" /><h4 className="text-lg font-semibold text-slate-700 dark:text-white">Siap Cetak?</h4><p className="text-slate-500 dark:text-slate-400 mt-2 text-sm">Hasil akan muncul di sini.</p></div>}
                    {!isLoading && generatedImages.length > 0 && (
                      <>
                        {(activeTab === 'faceswap' || activeTab === 'enhancer') && uploadedImages[activeTab === 'enhancer' ? 'enhancer' : 'faceswapSource']?.preview ? (
                           <div className="space-y-4">
                              <BeforeAfterSlider 
                                beforeImage={uploadedImages[activeTab === 'enhancer' ? 'enhancer' : 'faceswapSource'][activeTab === 'enhancer' ? 0 : 'preview']?.preview || uploadedImages.faceswapSource.preview} 
                                afterImage={generatedImages[0]} 
                              />
                              <div className="flex justify-end gap-2">
                                 <button onClick={() => setReviewData({type: 'image', content: generatedImages[0], title: `Hasil ${activeTab === 'enhancer' ? 'Enhance HD' : 'Face Swap'}`})} className="flex items-center gap-2 px-4 py-2 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl text-xs font-bold shadow-sm hover:bg-slate-50 dark:hover:bg-slate-600 transition-colors text-slate-700 dark:text-slate-200">
                                    <Eye size={16}/> Review Result Only
                                 </button>
                                 <button onClick={() => downloadImage(generatedImages[0])} className="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-xl text-xs font-bold shadow-lg hover:bg-indigo-700 transition-colors">
                                    <Download size={16}/> Download
                                 </button>
                              </div>
                           </div>
                        ) : (
                          <div className="grid grid-cols-1 gap-4">
                            {/* Display all generated images (removed slice) */}
                            {generatedImages.map((img, index) => (
                              <div key={index} className={`relative rounded-xl overflow-hidden shadow-xl group ${aspectRatio === '9:16' && activeTab === 'photographer' ? 'aspect-[9/16]' : aspectRatio === '16:9' && activeTab === 'photographer' ? 'aspect-video' : aspectRatio === '3:4' && activeTab === 'photographer' ? 'aspect-[3/4]' : 'aspect-square'}`}>
                                <img src={img} alt={`Hasil AI ${index + 1}`} className="w-full h-full object-cover" />
                                
                                {/* Overlay Controls */}
                                <div className="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black/80 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-center justify-end gap-3">
                                   <button 
                                      onClick={() => setReviewData({type: 'image', content: img, title: `Review Hasil #${index+1}`})} 
                                      className="bg-white/20 backdrop-blur-md text-white p-2.5 rounded-full hover:bg-white/40 transition-transform hover:scale-110 active:scale-95 border border-white/30"
                                      title="Review Fullscreen"
                                   >
                                      <Eye size={20} />
                                   </button>
                                   <button 
                                      onClick={() => downloadImage(img)} 
                                      className="bg-white text-indigo-600 p-2.5 rounded-full shadow-lg hover:bg-indigo-50 transition-transform hover:scale-110 active:scale-95"
                                      title="Download HD"
                                   >
                                      <Download size={20} />
                                   </button>
                                </div>
                              </div>
                            ))}
                          </div>
                        )}
                      </>
                    )}
                  </>
                )}
              </div>
            </div>
            )}
        </div>
      </main>
    </div>
  );
}
